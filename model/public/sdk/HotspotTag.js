!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).HotspotTag=e()}(this,(function(){"use strict";function t(){var t=!0,e=1;Object.defineProperties(this,{enabled:{get:function(){return t},set:function(e){t=e}},level:{get:function(){return e},set:function(t){e=t}}}),this.enabled=!1}t.prototype.echo=function(t,e,i){return this.enabled?(e=Array.prototype.slice.call(e),"table"!==i&&(e[0]="sdk: "+e[0]),e.unshift(console),Function.prototype.bind.apply(t,e)):function(){}},t.prototype.info=function(){return 1===this.level?this.echo(console.info,arguments):function(){}},t.prototype.debug=function(){return 1===this.level||2===this.level?this.echo(console.debug,arguments):function(){}},t.prototype.warn=function(){return 1===this.level||2===this.level||3===this.level?this.echo(console.warn,arguments):function(){}},t.prototype.error=function(){if(1===this.level||2===this.level||3===this.level||4===this.level)return this.echo(console.error,arguments)},t.prototype.time=function(){return this.echo(console.time,arguments)},t.prototype.timeEnd=function(){return this.echo(console.timeEnd,arguments)};var e=new t,i=new Map,n={carray:function(t,e){i.set(t,e)},get:function(t){return i.get(t)}},o=function(){var t=n.get("ext");t.env="production",t.bundle="Mon Oct 28 2024 11:29:49 GMT+0800 (China Standard Time)",t.version="1.1.2"},a=qspace.THREE,r=Object.create(null),s=null,l=null,c=Object.create(null);r.init=function(){delete r.init,s=n.get("ext"),l=n.get("event");var t=Object.create(null);Object.keys(l).forEach((function(e){var i=l[e];c[i]=[],t[i]={set:function(t){c[i].push(t)},get:function(){return c[i]}}})),Object.defineProperties(s,t)},r.clear=function(){Object.keys(l).forEach((function(t){c[l[t]]=[]}))},n.carray("hook",r);var u=r,h=null,d=null,p=Object.create(null);p.init=function(){h=n.get("ext"),d=n.get("event"),Object.keys(d).forEach((function(t){var e={_state:!1,_data:null,_historyData:{}};p[d[t]]=e,function(t,e){Object.defineProperties(t,{state:{get:function(){return t._state},set:function(i){t._state=i;var n=t._data;!function(t,e,i){switch(t){case d.Add:!0===e&&(p[d.TagPutDown].state=!1,p[d.TagCancelAdd].state=!1,p[d.TagDragMoving].state=!1,p[d.PlaneClick].state=!1,p[d.BlankAreaClick].state=!1,h[d.Add].forEach((function(t){t(i)})));break;case d.TagCancelAdd:!0===e&&(p[d.Add].state=!1,p[d.TagFollowMoving].state=!1,h[d.TagCancelAdd].forEach((function(t){t(i)})));break;case d.DisableAdd:break;case d.TagFollowMoving:!0===e&&(p[d.TagPutDown].state=!1,h[d.TagFollowMoving].forEach((function(t){return t(i)})));break;case d.TagPutDown:!0===e&&(p[d.TagFollowMoving].state=!1,h[d.TagPutDown].forEach((function(t){return t(i)})));break;case d.TagChoosed:!0===e&&(p[d.TagCancelChoose].state=!1,h[d.TagChoosed].forEach((function(t){t(i)}))),!1===e&&(p[d.TagDragMovingEnd].state=!0);break;case d.TagDeleted:!0===e&&h[d.TagDeleted].forEach((function(t){return t(i)}));break;case d.TagDragMovingStart:!0===e&&(p[d.TagDragMoving].state=!1,p[d.TagDragMovingEnd].state=!1,h[d.TagDragMovingStart].forEach((function(t){return t(i)})));break;case d.TagDragMoving:!0===e&&(p[d.TagDragMovingStart].state=!1,p[d.TagDragMovingEnd].state=!1,h[d.TagDragMoving].forEach((function(t){return t(i)})));break;case d.TagDragMovingEnd:!0===e&&(p[d.TagDragMovingStart].state=!1,p[d.TagDragMoving].state=!1,h[d.TagDragMovingEnd].forEach((function(t){return t(i)})));break;case d.BasePlateHover:!0===e&&(p[d.BasePlateHoverOut].state=!1);break;case d.BasePlateHoverOut:!0===e&&(p[d.BasePlateHover].state=!1);break;case d.BasePlateClick:!0===e&&(p[d.BlankAreaClick].state=!1);break;case d.PlaneHover:!0===e&&(p[d.PlaneHoverOut].state=!1,h[d.PlaneHover].forEach((function(t){t(i)})));break;case d.PlaneHoverOut:!0===e&&(p[d.PlaneHover].state=!1,h[d.PlaneHoverOut].forEach((function(t){t(i)})));break;case d.PlaneClick:!0===e&&(p[d.BlankAreaClick].state=!1,h[d.PlaneClick].forEach((function(t){return t(i)})));break;case d.TitleHover:!0===e&&(p[d.TitleHoverOut].state=!1,h[d.TitleHover].forEach((function(t){t(i)})));break;case d.TitleHoverOut:!0===e&&(p[d.TitleHover].state=!1,h[d.TitleHoverOut].forEach((function(t){t(i)})));break;case d.TitleClick:!0===e&&!1===p[d.TagChoosed].state&&h[d.TitleClick].forEach((function(t){t(i)}));break;case d.BlankAreaClick:!0===e&&(p[d.BasePlateClick].state=!1,p[d.PlaneClick].state=!1,p[d.TitleClick].state=!1,h[d.BlankAreaClick].forEach((function(t){return t()})));break;case d.BlankAreaHover:!0===e&&h[d.BlankAreaHover].forEach((function(t){t()}));break;case d.TagCancelChoose:!0===e&&(p[d.TagChoosed].state=!1,h[d.TagCancelChoose].forEach((function(t){t(i)})));break;case d.NewTagPutDown:!0===e&&h[d.NewTagPutDown].forEach((function(t){t(i)}));break;case d.AllTagsLoaded:!0===e&&h[d.AllTagsLoaded].forEach((function(t){t(i)}));break;case d.TagLoaded:!0===e&&h[d.TagLoaded].forEach((function(t){t(i)}));break;case d.HeadOutCameraView:if(!0===e){var n={key:i,value:1};delete p[d.HeadNotOutCameraView].historyData[n.key],p[d.HeadOutCameraView].historyData=n,h[d.HeadOutCameraView].forEach((function(t){t(i)}))}break;case d.HeadNotOutCameraView:if(!0===e){var o={key:i,value:1};delete p[d.HeadOutCameraView].historyData[o.key],p[d.HeadNotOutCameraView].historyData=o,h[d.HeadNotOutCameraView].forEach((function(t){t()}))}break;case d.PlaneIsOutVisualRange:if(!0===e){var a={key:i,value:1};delete p[d.PlaneIsNotOutVisualRange].historyData[a.key],p[d.PlaneIsOutVisualRange].historyData=a}break;case d.PlaneIsNotOutVisualRange:if(!0===e){var r={key:i,value:1};delete p[d.PlaneIsOutVisualRange].historyData[r.key],p[d.PlaneIsNotOutVisualRange].historyData=r}break;case d.DisableSyncTitlePosition:!0===e&&(p[d.EnableSyncTitlePosition].state=!1);break;case d.EnableSyncTitlePosition:!0===e&&(p[d.DisableSyncTitlePosition].state=!1);break;case d.StopLoading:break;case d.ViewRotate:!0===e&&(p[d.ViewRotateStop].state=!1,h[d.ViewRotate].forEach((function(t){return t(i)})));break;case d.ViewRotateStop:!0===e&&(p[d.ViewRotate].state=!1);break;case d.TransformControlHoverIn:!0===e&&(p[d.TransformControlHoverOut].state=!1,h[d.TransformControlHoverIn].forEach((function(t){return t(i)})));break;case d.TransformControlHoverOut:!0===e&&(p[d.TransformControlHoverIn].state=!1,h[d.TransformControlHoverOut].forEach((function(t){return t(i)})));break;case d.TransformControlPointerDown:!0===e&&(p[d.TransformControlPointerUp].state=!1,h[d.TransformControlPointerDown].forEach((function(t){return t(i)})));break;case d.TransformControlPointerUp:!0===e&&(p[d.TransformControlPointerDown].state=!1,h[d.TransformControlPointerUp].forEach((function(t){return t(i)})));break;case d.TransformControlDragMoving:!0===e&&(p[d.TransformControlDragMovingEnd].state=!1,h[d.TransformControlDragMoving].forEach((function(t){return t(i)})));break;case d.TransformControlDragMovingEnd:!0===e&&(p[d.TransformControlDragMoving].state=!1,h[d.TransformControlDragMovingEnd].forEach((function(t){return t(i)})));break;case d.VisualRangeChanged:!0===e&&(p[d.VisualRangeChanged].state=!1,h[d.VisualRangeChanged].forEach((function(t){return t(i)})))}}(e,i,n)}},data:{get:function(){return t._data},set:function(e){t._data=e}},historyData:{get:function(){return t._historyData},set:function(e){t._historyData[e.key]=e.value}}})}(e,d[t])})),delete p.init},n.carray("status",p);var g=p,f=Object.create(null);f.name="tag.manager.inner.interaction";var v=null,y=null;f.init=function(){v=n.get("ext"),y=n.get("event"),v[y.TagDragMoving]=function(){},v[y.TagDragMovingEnd]=function(){},v[y.PlaneClick]=function(){},v[y.BlankAreaClick]=function(){},v[y.ViewRotate]=function(){},v[y.TransformControlDragMoving]=function(t){v.tagsMap.forEach((function(t){t.label&&t.label.disablePointerEvent()}))},v[y.TransformControlDragMovingEnd]=function(t){v.tagsMap.forEach((function(t){t.label&&t.label.enablePointerEvent()}))}};var m=f,b=Object.create(null);b.init=function(){b.Add="tag.add",b.DisableAdd="tag.disable.add",b.TagFollowMoving="tag.follow.moving",b.TagCancelAdd="tag.canbel.add",b.TagPutDown="tag.put.down",b.TagChoosed="tag.choosed",b.TagDeleted="tag.deleted",b.TagDragMovingStart="tag.drag.moving.start",b.TagDragMoving="tag.drag.moving",b.TagDragMovingEnd="tag.drag.moving.end",b.BasePlateHover="tag.base.plate.hover",b.BasePlateHoverOut="tag.base.plate.hover.out",b.BasePlateClick="tag.base.plate.click",b.PlaneHover="tag.head.hover",b.PlaneHoverOut="tag.head.hover.out",b.PlaneClick="tag.head.click",b.TitleHover="tag.title.hover",b.TitleHoverOut="tag.title.hover.out",b.TitleClick="tag.title.click",b.BlankAreaHover="tag.blank.area.hover",b.BlankAreaClick="tag.blank.area.click",b.TagCancelChoose="tag.cancel.choose",b.NewTagPutDown="tag.new.put.down",b.AllTagsLoaded="tag.all.loaded",b.TagLoaded="tag.loaded",b.StopLoading="tag.stop.loading",b.HeadOutCameraView="tag.head.out.camera.view",b.HeadNotOutCameraView="tag.head.not.out.camera.view",b.PlaneIsOutVisualRange="tag.head.is.out.visual.range",b.PlaneIsNotOutVisualRange="tag.head.is.not.out.visual.range",b.DisableSyncTitlePosition="tag.disable.sync.title.position",b.EnableSyncTitlePosition="tag.enable.sync.title.position",b.ViewRotate="tag.manager.view.rotate",b.ViewRotateStop="tag.manager.view.rotate.stop",b.TransformControlHoverIn="tag.transform.control.hover.in",b.TransformControlHoverOut="tag.transform.control.hover.out",b.TransformControlPointerDown="tag.transform.control.pointer.down",b.TransformControlPointerUp="tag.transform.control.pointer.up",b.TransformControlDragMoving="tag.transform.control.drag.moving",b.TransformControlDragMovingEnd="tag.transform.control.drag.moving.end",b.VisualRangeChanged="tag.visual.range.changed",delete b.init,u.init(),m.init(),g.init()},n.carray("event",b);var T=b,w={sceneAdd:function(t){this.qspace.scene.add(t)},sceneRemove:function(t){this.qspace.scene.remove(t)},getActiveModelId:function(){return this.qspace.model.id},getActiveModelType:function(){return this.qspace.model.type},getCameraPosition:function(){return this.qspace.sceneCamera.position},getPanoramaCameraPosition:function(){return this.qspace.panoramaCamera.position},getCamera:function(){switch(this.qspace.view.mode){case"transitioning":return this.qspace.core.getSceneCamera();case"panorama":return this.qspace.core.getPanoramaCamera();case"dollhouse":return this.qspace.core.getDollhouseCamera();case"floorplan":return this.qspace.core.getFloorplanCamera()}},getCurrentMode:function(){return this.qspace.view.mode},getCameraProjectionMatrix:function(){switch(this.qspace.view.mode){case"transitioning":var t=this.qspace.sceneCamera.projectionMatrix,e=new a.Matrix4;return e.elements=t,e;case"panorama":var i=this.qspace.panoramaCamera.projectionMatrix,n=new a.Matrix4;return n.elements=i,n;case"dollhouse":var o=this.qspace.dollhouseCamera.projectionMatrix,r=new a.Matrix4;return r.elements=o,r;case"floorplan":var s=this.qspace.floorCamera.projectionMatrix,l=new a.Matrix4;return l.elements=s,l}},getCameraWorldMatrixInverse:function(){switch(this.qspace.view.mode){case"transitioning":var t=this.qspace.sceneCamera.matrixWorldInverse,e=new a.Matrix4;return e.elements=t,e;case"panorama":var i=this.qspace.panoramaCamera.matrixWorldInverse,n=new a.Matrix4;return n.elements=i,n;case"dollhouse":var o=this.qspace.dollhouseCamera.matrixWorldInverse,r=new a.Matrix4;return r.elements=o,r;case"floorplan":var s=this.qspace.floorCamera.matrixWorldInverse,l=new a.Matrix4;return l.elements=s,l}},getRenderWidth:function(){return this.qspace.core.rendererCanvas.clientWidth},getRenderHeight:function(){return this.qspace.core.rendererCanvas.clientHeight},getRendererStage:function(){return this.qspace.core.rendererStage},getRendererCanvas:function(){return this.qspace.core.rendererCanvas},getFloorsInfo:function(){return this.qspace.model.floors},getFloorBox3:function(t){return this.qspace.commonEvents.modelEvents.getFloorBox3(t)},judgeBarrierBetweenThePoint:function(t,e){return this.qspace.raycaster.computeBarrierWithinModelBetweenThePoint(t,e)},getIntersectWithinPointer:function(t,e){return this.qspace.raycaster.getPointerIntersectWithinModel(t,e)},getIntersectWithinMouse:function(){return this.qspace.raycaster.getCurrentPointerIntersectWithinModel()}},_=O(),x=null,P=Object.create(null);function C(){var t=/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i,e=-1!=_.indexOf("Safari")&&-1!=_.indexOf("Version"),i=-1!=_.indexOf("iPhone")&&-1!=_.indexOf("Version"),n=e&&!i&&"ontouchend"in document;if(_&&t.test)return t.test(_)||n}function O(){return window.navigator.userAgent}P.parent_count=0,P.offset_left=0,P.offset_top=0;var M={isPc:function(){return!C()},isMobile:C,getUserAgent:O,getUrlParam:function(t){var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)","i"),i=window.location.search.substr(1).match(e);return null!=i?decodeURI(i[2]):null},getRendererStageOffsetInfo:function(){if(0!==P.parent_count)return P;null===x&&(x=document.getElementById("renderer-stage"));var t=0,e=0,i=0,n=function(o){e+=o.offsetLeft,i+=o.offsetTop,o.offsetParent&&(t++,n(o.offsetParent))};return n(x),P.parent_count=t,P.offset_left=e,P.offset_top=i,P}};var D={convertScreenPositionToNDC:function(t,e,i){var n=document.getElementById("renderer-stage");return(i=i||new a.Vector2).x=t/n.clientWidth*2-1,i.y=-e/n.clientHeight*2+1,i},convertWorldPositionToScreen:function(t,e){var i=document.getElementById("renderer-stage"),n=t.clone().project(e),o=i.clientWidth/2,a=i.clientHeight/2;return{x:n.x*o+o,y:-n.y*a+a}},computeWorldPositionOutCamera2:function(t,e,i){var n=(t=t.clone()).applyMatrix4(e).applyMatrix4(i);return Math.abs(n.z)>1}};var S={getTsNow:function(){return Date.now()||(new Date).getTime()}};var E=function(){var t=[];this.pipe=function(e,i){return t.push(S.getTsNow()),2===t.length?e>t[1]-t[0]?(t.pop(),!0):(i&&i(),t.shift(),!1):(i&&i(),!1)},this.clear=function(){t=[]}},A=E,I=Object.create(null);I.createLabel=function(t,i){var o=w.getRendererCanvas(),a=document.createElement("div");return a.frameUpdateThrottle=new A,a.id="title-"+t.uuid,a.pid=t.uuid,a.top_space=3,a.visible=t.visible,a.settingItem=i,a._type="tag.title",a.innerText=t.text,a.setAttribute("tag-uuid",t.uuid),a.offset={top:0,right:0,bottom:0,left:0},a.style.cssText="\n       position: absolute;\n       //position: fixed;\n       left: 0;\n       top: 0;\n       font-size: "+t.font_size+"px;\n       color: "+t.font_color+";\n       background-color: rgba("+t.bg_color.r+", "+t.bg_color.g+", "+t.bg_color.b+", "+t.bg_color.a+");\n       padding: 5px 10px;\n       white-space: nowrap;\n       visibility: hidden;\n       opacity: 1;\n       z-index: "+1*getComputedStyle(o).zIndex+";\n       user-select: none;\n       -webkit-user-select: none;\n       border-radius: 2px;\n       will-change: transform; // $$$\n       transform: translate(0, 0);\n     ",function(t){t.isVisible=function(){return"hidden"!==t.style.visibility&&("visible"===t.style.visibility||void 0)},t.setOpacity=function(t){},t.hide=function(e){!1!==t.isVisible()&&(t.style.visibility="hidden")},t.show=function(e){!0!==t.isVisible()&&(t.style.visibility="visible")},t.updatePosition=function(e,i,o){void 0===i&&(i=!1);n.get("ext");t.currentPosition=e;var a=e.x-.5*t.clientWidth,r=e.y-t.clientHeight;a=~~a,r=~~r;var s=t.currentLeft||0,l=t.currentTop||0,c=Math.abs(a-s),u=Math.abs(r-l);if(0!==c||0!==u||!1!==i){t.currentLeft=a,t.currentTop=r;var h=r-t.offset.bottom+t.offset.top+"px",d=a+t.offset.left-t.offset.right+"px";t.style.transform="translate("+d+", "+h+")"}},t.updateText=function(e){t.innerText=e,t.updatePosition(t.currentPosition,!1,"update.text")},t.updateFontSize=function(e){t.style.fontSize=e+"px",t.updatePosition(t.currentPosition,!1,"update.font.size")},t.updateFontColor=function(e){t.style.color=e},t.updateBgColor=function(e){t.style.backgroundColor="rgba("+e.r+", "+e.g+", "+e.b+", "+e.a+")"},t.hoverIn=function(){if(!0!==g[T.TitleHover].state){var i=n.get("ext")._methods.getTag(t.pid,"label.hover.in");e.debug("tag.title.hover.in<"+i.uuid+">")(),n.get("ext").onTagTitleHover(t)}},t.hoverOut=function(){!0!==g[T.TitleHoverOut].state&&n.get("ext").onTagTitleHoverOut(t)},t.disablePointerEvent=function(){t.style.pointerEvents="none"},t.enablePointerEvent=function(){t.style.pointerEvents="auto"},t.remvoe=function(){n.get("ext").getRendererStage().removeChild(t)},t.onDragMoving=function(){t.style.pointerEvents="none"},t.onDragMovingEnd=function(){t.style.pointerEvents="auto"},t.onHeadHide=function(e){t.updatePosition(e,!1,"on.head.hide")},t.onHeadShow=function(e){t.updatePosition(e,!1,"on.head.show")},t.onFrameUpdate=function(){var e=n.get("ext")._methods.getTag(t.pid,"label.on.frame.update").head.getTopCenterOfScreen();t.updatePosition(e,!1,"plane.finded.top.position")}}(a),document.getElementById("renderer-stage").appendChild(a),a};var L=I,H=new a.TextureLoader;H.setCrossOrigin("Anonymous");var B=new Map;var k={TextureMap:B,loadSingleTexture:function(t,i,n){void 0===i&&(i=function(){}),void 0===n&&(n=function(){});var o=t.split(/(\/\/)/g)[2],a=B.get(o);if(a){var r=a.clone();return r.needsUpdate=!0,i(r),r}return H.load("//"+o,(function(t){B.set(o,t),i(t)}),(function(t){}),(function(i){e.error("loadSingleTexture <"+t+"> error:",i)(),n()}))},loadSingleTextureOfImage:function(t,i){void 0===i&&(i=function(){});var n=t.split(/(\/\/)/g)[2],o=B.get(n);if(o){var r=o.clone();return r.needsUpdate=!0,void i(r)}var s=new Image;s.onload=function(){var t=new a.Texture;t.image=s,B.set(n,t),i(t)},s.onerror=function(t){e.error("loadSingleTextureOfImage",t)()},s.crossOrigin="anonymous",s.src=t},loadAsyncSingleTexture:function(t,e){void 0===e&&(e=function(){});var i=t.split(/(\/\/)/g)[2];H.loadAsync("//"+i).then((function(t){e(t)}))},loadMultipleTextures:function(t){},createCanvasLabel:function(t){var e=document.createElement("canvas"),i=e.getContext("2d");i.font=t.fontSize+"px "+t.fontFace;var n=i.measureText(t.text).width+t.fontSize,o=t.fontSize+t.fontSize,r=o/10;return t.radius&&(r=t.radius),e.width=n,e.height=o,i.lineWidth=2,i.strokeStyle=t.bgColor,i.fillStyle=t.bgColor,function(t,e,i,n,o,a){t.beginPath(),t.moveTo(e,i+a),t.lineTo(e,i+o-a),t.quadraticCurveTo(e,i+o,e+a,i+o),t.lineTo(e+n-a,i+o),t.quadraticCurveTo(e+n,i+o,e+n,i+o-a),t.lineTo(e+n,i+a),t.quadraticCurveTo(e+n,i,e+n-a,i),t.lineTo(e+a,i),t.quadraticCurveTo(e,i,e,i+a),t.stroke(),t.fill(),t.closePath()}(i,2,2,n-4,o-4,r),function(t,e){t.fillStyle=e.fontColor,t.font=e.fontSize+"px "+e.fontFace,t.textAlign="center",t.textBaseline="middle",t.fillText(e.text,n/2,o/2+2),t.fillText(e.text,n/2,o/2+2)}(i,t),{texture:new a.CanvasTexture(e),width:e.width,height:e.height,ratio:e.width/e.height}},createCanvasText:function(t){var e=document.createElement("canvas"),i=e.getContext("2d"),n="normal bold "+t.fontSize+"px "+t.fontFace;i.font=n;var o=i.measureText(t.text),r=o.width,s=o.actualBoundingBoxAscent,l=t.width,c=t.height;l=r+64,c=t.fontSize+32,e.width=l,e.height=c,i.rect(0,0,l,c),i.fillStyle=t.bgColor,i.fill(),i.fillStyle=t.fontColor,i.font=n;var u=.5*(l-r),h=t.fontSize+.5*(c-t.fontSize);h-=.5*(c-s),h+=16,i.fillText(t.text,u,h,r);var d=new a.CanvasTexture(e);return e.style.cssText+="position:absolute;bottom:0;left:0;width:"+l+"px;height:"+c+"px;",e.style.cssText+="background-color:rgba(255, 255, 255, 1);",e.style.cssText+="border-radius:"+t.border_radius+"px",{texture:d,width:l,height:c,ratio:l/c}},createCanvasText2:function(t){var e=document.createElement("canvas"),i=e.getContext("2d"),n="normal bold "+t.fontSize+"px "+t.fontFace;i.font=n;var o=i.measureText(t.text),r=o.width,s=o.actualBoundingBoxAscent,l=t.width,c=t.height;t.border_radius,l=r+64+32,c=t.fontSize+64+32,e.width=l,e.height=c;var u=l-16-8-16,h=c-16-8-16;i.translate(20,20),i.beginPath(0),i.arc(u-16,h-16,16,0,Math.PI/2),i.lineTo(16,h),i.arc(16,h-16,16,Math.PI/2,Math.PI),i.lineTo(0,16),i.arc(16,16,16,Math.PI,3*Math.PI/2),i.lineTo(u-16,0),i.arc(u-16,16,16,3*Math.PI/2,2*Math.PI),i.lineTo(u,h-16),i.closePath(),i.lineWidth=16,i.strokeStyle="#fff",i.stroke(),i.fillStyle=t.bgColor,i.fill(),i.fillStyle=t.fontColor,i.font=n;var d=.5*(l-r-16),p=t.fontSize+.5*(c-t.fontSize-32+32);p-=.5*(c-s),p+=32,i.fillText(t.text,d,p,r);var g=new a.CanvasTexture(e);return g.minFilter=a.LinearMipMapLinearFilter,g.magFilter=a.LinearFilter,e.style.cssText+="position:absolute;bottom:0;left:0;width:"+l+"px;height:"+c+"px;",e.style.cssText+="background-color:rgba(0, 0, 255, 0.5);",{texture:g,width:l,height:c,ratio:l/c}}},z=Object.create(null);function R(t,e,i,n){void 0===n&&(n=!1);var o=new a.BufferGeometry,r=[t.x,t.y,t.z,e.x,e.y,e.z];o.setAttribute("position",new a.BufferAttribute(new Float32Array(r),3));var s=new a.LineBasicMaterial({color:i,depthTest:n}),l=new a.Line(o,s,a.LineSegments);return l.renderOrder=999,l}function V(t,e,i,n,o){0<Object.keys(z).length&&function(t){var e=z[t];e&&(w.sceneRemove(e),e=null,delete z[t])}(n);var r=R(new a.Vector3(t.x,t.y,t.z),new a.Vector3(e.x,e.y,e.z),i,o);r.name=n,r&&(w.sceneAdd(r),z[n]=r)}var U=V,j=Object.create(null);j.tagHeadBg="",j.tagBasePlate="";var N={Resource:j,init:function(t){j.tagHeadBg=t.head_bg,j.tagBasePlate=t.base_plate,j.rotateControlTorus=t.rotate_control_torus,j.rotateControlArcSurface=t.rotate_control_arc_surface}};function W(t){return JSON.parse(JSON.stringify(t))}var F=function(t){var e=Object.create(null);return e.id=t.id,e.type=t.type,e.uuid=t.uuid,e.location_id=t.location_id,e.position=Object.freeze(W(t.position)),e.quaternion=Object.freeze(W(t.quaternion)),e.scale=Object.freeze(W(t.scale)),e.location_line=Object.freeze(W(t.location_line)),e.visible=t.visible,e.floor=t.floor,e.isSaved=t.isSaved,Object.freeze(e)};function G(t,i){return"[object Number]"===Object.prototype.toString.call(t)&&!isNaN(t)||(i&&e.error(i+" is not number")(),!1)}function q(t,i){return"[object Object]"===Object.prototype.toString.call(t)||(i&&e.error(i+" is not object")(),!1)}var Y={isStr:function(t,i){return"[object String]"===Object.prototype.toString.call(t)||(i&&e.error(i+" is not string")(),!1)},isNum:G,isBool:function(t,i){return"[object Boolean]"===Object.prototype.toString.call(t)||(i&&e.error(i+" is not boolean")(),!1)},isFunc:function(t,i){return"[object Function]"===Object.prototype.toString.call(t)||(i&&e.error(i+" is not function")(),!1)},isObj:q,isArr:function(t,i){return"[object Array]"===Object.prototype.toString.call(t)||(i&&e.error(i+" is not array")(),!1)},isVec2:function(t,i){if(q(t,i))return!(!G(t.x,"x")||!G(t.y,"y"))||(i&&e.error(i+" is not vec2")(),!1)},isVec3:function(t,i){if(q(t,i))return!!(G(t.x,"x")&&G(t.y,"y")&&G(t.z,"z")&&3===Object.keys(t).length)||(i&&e.error(i+" is not vec3")(),!1)},isVec4:function(t,i){return!!q(t,i)&&(!!(G(t.x,"x")&&G(t.y,"y")&&G(t.z,"z")&&G(t.w,"w")&&4===Object.keys(t).length)||(i&&e.error(i+" is not vec4")(),!1))},isRGBA:function(t,i){return q(t,i)?!!G(t.r,i+".r")&&(!!G(t.g,i+".g")&&(!!G(t.b,i+".b")&&!!G(t.a,i+".a"))):(i&&e.error(i+" is not RGBA object")(),!1)}};var Q=function(t){var e=this;this.id=t.applicationId,this.type=t.getUserData("type"),this.uuid="",this.location_id="",this._position=new a.Vector3,this._quaternion=new a.Quaternion,this._scale=new a.Vector3,this.location_line={visible:!1,length:0,width:0,color:"rgb(255, 255, 255)"},this.face_bg={color:"ffffff",opacity:1},this.visible=!0,this.floor=[],this.isSaved=t.data.isSaved,Object.defineProperties(this,{position:{get:function(){return{x:e._position.x,y:e._position.y,z:e._position.z}}},quaternion:{get:function(){return{x:e._quaternion.x,y:e._quaternion.y,z:e._quaternion.z,w:e._quaternion.w}}},scale:{get:function(){return{x:e._scale.x,y:e._scale.y,z:e._scale.z}}}})},Z=null;function X(t,e){null===Z&&(Z=n.get("ext")),a.Line2.call(this),this.name="location.line",this.geometry=new a.LineGeometry,this.geometry.vertices=[],this.material=new a.LineMaterial({depthWrite:!1,color:16053492,linewidth:1,opacity:1,transparent:!0,resolution:new a.Vector2(w.getRenderWidth(),w.getRenderHeight())}),this.renderOrder=9,this.setVertices(t,e)}X.prototype=Object.create(a.Line2.prototype),X.prototype.setVertices=function(t,e){this.setUserData("origin",t),this.setUserData("target",e);var i=[t.x,t.y,t.z,e.x,e.y,e.z];this.geometry.vertices[0]=(new a.Vector3).copy(t),this.geometry.vertices[1]=(new a.Vector3).copy(e),this.geometry.setPositions(i)},X.prototype.getTopVertex=function(){var t=this.geometry.boundingBox.max;return{x:t.x,y:t.y,z:t.z}},X.prototype.getBottomVertex=function(){var t=this.geometry.boundingBox.min;return{x:t.x,y:t.y,z:t.z}},X.prototype.show=function(t){this.parent.getUserData("setting_item").location_line.visible=!0,this.visible=!0},X.prototype.hide=function(t){this.parent.getUserData("setting_item").location_line.visible=!1,this.visible=!1},X.prototype.restoreVisible=function(){!0===this.parent.getUserData("setting_item").location_line.visible?this.visible=!0:this.visible=!1},X.prototype.setWidth=function(t){this.parent.getUserData("setting_item").location_line.width=t,this.material.linewidth=t},X.prototype.setColor=function(t){this.parent.getUserData("setting_item").location_line.color=t,this.material.color.set(new a.Color(t))},X.prototype.setLength=function(t,i){var n=this.parent.getUserData("setting_item");if(n.location_line.length!==t){var o=this.geometry.vertices[0].clone(),r=this.geometry.vertices[1].clone(),s=[o.x,o.y,o.z],l=[r.x,r.y,r.z+t],c=new a.Vector3(s[0],s[1],s[2]),u=new a.Vector3(l[0],l[1],l[2]);this.setUserData("origin",c),this.setUserData("target",u),this.geometry.setPositions(s.concat(l)),n.location_line.length=t,this.parent.onLocationLineChanged(t)}else e.warn("tag location line setLength failure, reason: same length "+t+", cmd: "+i)()},X.prototype.getLength=function(){return this.parent.getUserData("setting_item").location_line.length},X.prototype.setUserData=function(t,e){this.userData[t]=e},X.prototype.getUserData=function(t){return this.userData[t]},X.prototype.getOriginWp=function(){return this.localToWorld(this.geometry.vertices[0])},X.prototype.getTargetWp=function(){return this.localToWorld(this.geometry.vertices[1])},X.prototype.setRenderOrder=function(t){this.renderOrder=t,this.material.needsUpdate=!0},X.prototype.onRendererResize=function(t){this.material.resolution=new a.Vector2(t.width,t.height)},X.prototype.clearCache=function(){this.material.dispose(),this.geometry.dispose()},X.prototype.destroy=function(){e.info("%c"+this.name+" destroy","color:#f00;")(),this.clearCache()};var K=X,J=N.Resource;function $(t,e,i){void 0===t&&(t=1),void 0===e&&(e=1),a.Mesh.call(this),this.name="base.plate";var n=.1/(t/e);this.geometry=new a.PlaneBufferGeometry(.1,n),this.material=new a.MeshBasicMaterial({map:null,opacity:1,side:2,transparent:!0,premultipliedAlpha:!0,depthTest:!1,depthWrite:!1}),this.setUserData("default_scale",1),this.setUserData("current_scalar",1),this.init()}$.prototype=Object.create(a.Mesh.prototype),$.prototype.init=function(){var t=this;k.loadSingleTexture(J.tagBasePlate,(function(e){t.setMap(e)}))},$.prototype.addAxesHelper=function(){var t=new a.AxesHelper(.4);this.add(t)},$.prototype.addBoxHelper=function(){var t=new a.BoxHelper(this,16711680);this.add(t),this.boxHelper=t},$.prototype.show=function(){this.visible=!0},$.prototype.hide=function(){this.visible=!1},$.prototype.hover=function(){!0!==this.isHover&&(this.isHover=!0,n.get("ext").onBasePlateHover(this))},$.prototype.hoverOut=function(){!1!==this.isHover&&(this.isHover=!1,n.get("ext").onBasePlateHoverOut(this))},$.prototype.click=function(){n.get("ext").onBasePlateClick(this)},$.prototype.setMap=function(t){this.material.map=t,this.material.needsUpdate=!0},$.prototype.setPosition=function(t){var e;(e=this.position).set.apply(e,t)},$.prototype.setScale=function(t){this.scale.set(t,t,t),this.setUserData("default_scale",t)},$.prototype.setScalar=function(t){var e=this.getUserData("default_scale");this.setScale(e),this.scale.multiplyScalar(t),this.setUserData("current_scalar",t)},$.prototype.setUserData=function(t,e){this.userData[t]=e},$.prototype.getUserData=function(t){return this.userData[t]};var tt=$,et=U,it=new a.Raycaster,nt=0,ot=null;function at(t){void 0===t&&(t="tag"),null===ot&&(ot=n.get("ext")),a.Sprite.call(this),nt++,this.name="head",this.material=new a.SpriteMaterial({transparent:!0,sizeAttenuation:!1,depthTest:"tag2"!==t,color:16777215}),this.renderOrder="tag2"===t?10+nt:10,this.topCenterScreen={x:0,y:0},this.bottomCenterScreen={x:0,y:0},"tag"===t?this.setScale(.07):this.setScale(.08),this.worldPosition=new a.Vector3,this.isDragMoving=!1,this.hovered=!1,this._opacity=1,this.setUserData("origin_scale_rate",1),this.setUserData("current_scale_rate",1),this.setUserData("out_camera_view",!1),this.setUserData("out_visual_range",!1),this.setUserData("barrier_within_model",!1),this.setUserData("barrier_by_other_head",!1)}at.prototype=Object.create(a.Sprite.prototype),at.prototype.init=function(){},at.prototype.show=function(){this.visible=!0,this.parent&&this.parent.label&&this.parent.label.onHeadShow(this.getTopCenterOfScreen())},at.prototype.hide=function(){this.visible=!1,this.parent&&this.parent.label&&this.parent.label.onHeadHide(this.getCenterOfScreen())},at.prototype.setMap=function(t){this.material.map=t,this.material.needsUpdate=!0},at.prototype.setScalar=function(t){this.scale.multiplyScalar(t)},at.prototype.setScale=function(t){this.scale.set(t,t,t)},at.prototype.setColor=function(t){this.material.color.setHex(t)},at.prototype.setOpacity=function(t,e){var i;e?(this._opacity=t,i=t):i=this._opacity*t,this.material.premultipliedAlpha=1===i,this.material.opacity=i},at.prototype.setUserData=function(t,e){this.userData[t]=e},at.prototype.setPosition=function(t){this.position.copy(t)},at.prototype.getUserData=function(t){return this.userData[t]},at.prototype.getVH=function(){return this.scale.y},at.prototype.getScreenH=function(){var t=this.getTopCenterOfScreen(),e=this.getBottomCenterOfScreen();return this.screenH=Math.abs(e.y-t.y),this.screenH},at.prototype._getWorldPosition=function(){return this.getWorldPosition(this.worldPosition)},at.prototype.getCenter=function(){var t=w.getCamera();return this._getWorldPosition().clone().project(t)},at.prototype.getCenterOfScreen=function(){var t=this._getWorldPosition(),e=D.convertWorldPositionToScreen(t,w.getCamera());return{x:Math.floor(e.x),y:Math.floor(e.y)}},at.prototype.getTopCenterOfScreen=function(){var t=w.getCamera(),e=t.zoom/1,i=t.fov/70,n=this._getWorldPosition();if(!1===this.visible)return D.convertWorldPositionToScreen(n,t);var o=n.clone().project(t),r=this.getVH(),s=new a.Vector3(o.x,o.y+.5*(r+.4*r)*e/i,o.z),l=(1+s.x)/2*w.getRenderWidth(),c=(1-s.y)/2*w.getRenderHeight();return this.topCenterScreen.x=Math.floor(l),this.topCenterScreen.y=Math.floor(c),this.topCenterScreen},at.prototype.getBottomCenterOfScreen=function(){var t=w.getCamera(),e=t.zoom/1,i=t.fov/70,n=this._getWorldPosition();if(!1===this.visible)return D.convertWorldPositionToScreen(n,t);var o=n.clone().project(t),r=this.getVH(),s=new a.Vector3(o.x,o.y-.65*(r+.4*r)*e/i,o.z),l=(1+s.x)/2*w.getRenderWidth(),c=(1-s.y)/2*w.getRenderHeight();return this.bottomCenterScreen.x=Math.floor(l),this.bottomCenterScreen.y=Math.floor(c),this.bottomCenterScreen},at.prototype.getScreenPosition=function(){var t=(new a.Vector2).copy(this.getCenterOfScreen()),e=(new a.Vector2).copy(this.getTopCenterOfScreen()),i=e.clone().rotateAround(t,.5*Math.PI),n=e.clone().rotateAround(t,1*Math.PI),o=e.clone().rotateAround(t,1.5*Math.PI);return{center:t,top:e,right:i,bottom:n,left:o}},at.prototype.getDistanceToCamera=function(){return this._getWorldPosition().distanceTo(w.getCameraPosition())},at.prototype.showBoundingSphere=function(){this.geometry.computeBoundingSphere();var t=this.geometry.boundingSphere,e=new a.SphereBufferGeometry(t.radius,32,32),i=new a.MeshBasicMaterial({color:16776960});return new a.Mesh(e,i)},at.prototype.onFollowMoving=function(){this.updateVirtualScale()},at.prototype.onDragMoving=function(){this.isDragMoving=!0},at.prototype.onDragMovingEnd=function(){this.isDragMoving=!1},at.prototype.onLocationLineChanged=function(t){this.position.z=t},at.prototype.updateVirtualScale=function(){var t=w.getCamera(),e=t.zoom,i=t.fov;if("tag"===this.parent.userData.type){var n=this.getDistanceToCamera(),o=this.scale.x;n>10&&(n=10),o=(o=-.003*n+.0704)/(e/1)*(i/70),(o*=this.getUserData("current_scale_rate")*this.getUserData("origin_scale_rate"))!==this.scale.x&&this.setScale(o)}if("tag2"===this.parent.userData.type){var a=.08;a/=e,a*=this.getUserData("current_scale_rate")*this.getUserData("origin_scale_rate"),this.setScale(a)}},at.prototype.updateVisible=function(){this.parent&&this.parent.plane&&(!1===this.parent.plane.visible&&this.hide(),!0===this.parent.plane.visible&&this.show())},at.prototype.computeIsOutVisualRangle=function(t){var e=!1;return"purepano"===w.getActiveModelType()&&(e=!0),e=null===ot.visualRange||ot.visualRangeSphere.containsPoint(this._getWorldPosition()),this.setUserData("out_visual_range",!e),!0===e?(g[T.PlaneIsNotOutVisualRange].data=this.parent.uuid,g[T.PlaneIsNotOutVisualRange].state=!0):(g[T.PlaneIsOutVisualRange].data=this.parent.uuid,g[T.PlaneIsOutVisualRange].state=!0),!e},at.prototype.computeIsOutVisualRangle2=function(t){var e=!1;return e=null===ot.visualRange||ot.visualRangeSphere.containsPoint(this._getWorldPosition()),this.setUserData("out_visual_range",!e),!0===e?(g[T.PlaneIsNotOutVisualRange].data=this.parent.uuid,g[T.PlaneIsNotOutVisualRange].state=!0):(g[T.PlaneIsOutVisualRange].data=this.parent.uuid,g[T.PlaneIsOutVisualRange].state=!0),!e},at.prototype.computeIsOutCameraView2=function(){var t=this.parent.userData.type,e=w.getCameraWorldMatrixInverse(),i=w.getCameraProjectionMatrix(),n=new a.Vector3;"tag"===t&&n.copy(this._getWorldPosition()),"tag2"===t&&n.copy(this.parent.position);var o=D.computeWorldPositionOutCamera2(n,e,i);return this.setUserData("out_camera_view",o),o},at.prototype.computeBarrierWithinModel=function(){var t=this._getWorldPosition(),e=w.getCameraPosition(),i=w.judgeBarrierBetweenThePoint(e,t);return this.setUserData("barrier_within_model",i),i},at.prototype.computeBarrierByOtherTags=function(){var t=!1;return"model"===w.getActiveModelType()&&(t=this.computeBarrierByOtherPlane()),"purepano"===w.getActiveModelType()&&(t=this.computeBarrierByOtherPlane2()),t},at.prototype.computeBarrierByOtherPlane=function(){var t=ot._methods.getOtherTags(this.parent.uuid).map((function(t){return t.head})),e=w.getCamera(),i=w.getCameraPosition(),n=this._getWorldPosition(),o=(new a.Vector3).copy(i),r=(new a.Vector3).subVectors(o,n),s=(new a.Vector3).subVectors(n,o),l=r.clone().normalize();s.clone().normalize();it.setFromCamera(new a.Vector2,e),it.set(n,l);var c=it.intersectObjects(t);if(0<c.length){var u=c[0];u.object;u.distance>0?this.setUserData("barrier_by_other_head",!0):this.setUserData("barrier_by_other_head",!1)}else this.setUserData("barrier_by_other_head",!1);return this.getUserData("barrier_by_other_head")},at.prototype.computeBarrierByOtherPlane2=function(){for(var t=ot._methods.getOtherTags(this.parent.uuid).map((function(t){return t.head})),e=this.getCenterOfScreen(),i=this.getTopCenterOfScreen(),n=(new a.Vector2).copy(e).distanceTo((new a.Vector2).copy(i)),o=0,r=t.length;o<r;++o){var s=t[o],l=s.getCenterOfScreen();if((new a.Vector2).copy(l).distanceTo((new a.Vector2).copy(e))<=n){if(this.renderOrder<s.renderOrder){this.setUserData("barrier_by_other_head",!0);break}}else this.setUserData("barrier_by_other_head",!1)}return this.getUserData("barrier_by_other_head")},at.prototype.showVHLine=function(){var t=w.getCamera(),e=this._getWorldPosition(),i=e.clone(),n=i.clone(),o=i.clone();n.y+=.5*this.scale.y,o.y-=.5*this.scale.y;(new a.Vector3).subVectors(n,o);et(o,n,65535,"vhline-"+this.uuid);var r=n.clone().project(t),s=o.clone().project(t),l=(new a.Vector3).subVectors(r,s).normalize();l.angleTo(new a.Vector3(0,1,0));Math.abs(l.y-1)>.001?this.setColor(16711680):this.setColor(255);var c=(new a.Vector3).subVectors(t.position,e);this.rotateAxis=c},at.prototype.hoverIn=function(){!0!==this.hovered&&(this.hovered=!0,e.debug("tag.head.hover.in<"+this.parent.uuid+">")(),ot.onTagPlaneHover(this))},at.prototype.hoverOut=function(){!1!==this.hovered&&(this.hovered=!1,ot.onTagPlaneHoverOut(this))},at.prototype.click=function(){ot.onTagPlaneClick(this)},at.prototype.onPutDown=function(){},at.prototype.onFrameUpdate=function(t){this.parent&&(this.updateVirtualScale(),this.children[0]&&this.children[0].onFrameUpdate(t))},at.prototype.clearCache=function(){this.material.map&&this.material.map.dispose(),this.material.dispose(),this.geometry.dispose()},at.prototype.destroy=function(){e.info("%c"+this.name+" destroy","color:#f00;")(),this.clearCache()};var rt=at,st={protocol:/https:|http:/g};function lt(t,e,i){return t(i={path:e,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==e&&i.path)}},i.exports),i.exports}var ct=lt((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.loop=e.conditional=e.parse=void 0;e.parse=function t(e,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:n;if(Array.isArray(i))i.forEach((function(i){return t(e,i,n,o)}));else if("function"==typeof i)i(e,n,o,t);else{var a=Object.keys(i)[0];Array.isArray(i[a])?(o[a]={},t(e,i[a],n,o[a])):o[a]=i[a](e,n,o,t)}return n};e.conditional=function(t,e){return function(i,n,o,a){e(i,n,o)&&a(i,t,n,o)}};e.loop=function(t,e){return function(i,n,o,a){for(var r=[];e(i,n,o);){var s={};a(i,t,n,s),r.push(s)}return r}}})),ut=lt((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.readBits=e.readArray=e.readUnsigned=e.readString=e.peekBytes=e.readBytes=e.peekByte=e.readByte=e.buildStream=void 0;e.buildStream=function(t){return{data:t,pos:0}};var i=function(){return function(t){return t.data[t.pos++]}};e.readByte=i;e.peekByte=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return function(e){return e.data[e.pos+t]}};var n=function(t){return function(e){return e.data.subarray(e.pos,e.pos+=t)}};e.readBytes=n;e.peekBytes=function(t){return function(e){return e.data.subarray(e.pos,e.pos+t)}};e.readString=function(t){return function(e){return Array.from(n(t)(e)).map((function(t){return String.fromCharCode(t)})).join("")}};e.readUnsigned=function(t){return function(e){var i=n(2)(e);return t?(i[1]<<8)+i[0]:(i[0]<<8)+i[1]}};e.readArray=function(t,e){return function(i,o,a){for(var r="function"==typeof e?e(i,o,a):e,s=n(t),l=new Array(r),c=0;c<r;c++)l[c]=s(i);return l}};e.readBits=function(t){return function(e){for(var i=function(t){return t.data[t.pos++]}(e),n=new Array(8),o=0;o<8;o++)n[7-o]=!!(i&1<<o);return Object.keys(t).reduce((function(e,i){var o=t[i];return o.length?e[i]=function(t,e,i){for(var n=0,o=0;o<i;o++)n+=t[e+o]&&Math.pow(2,i-o-1);return n}(n,o.index,o.length):e[i]=n[o.index],e}),{})}}})),ht=lt((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i={blocks:function(t){for(var e=[],i=0,n=(0,ut.readByte)()(t);0!==n;n=(0,ut.readByte)()(t))e.push((0,ut.readBytes)(n)(t)),i+=n;for(var o=new Uint8Array(i),a=0,r=0;r<e.length;r++)o.set(e[r],a),a+=e[r].length;return o}},n=(0,ct.conditional)({gce:[{codes:(0,ut.readBytes)(2)},{byteSize:(0,ut.readByte)()},{extras:(0,ut.readBits)({future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}})},{delay:(0,ut.readUnsigned)(!0)},{transparentColorIndex:(0,ut.readByte)()},{terminator:(0,ut.readByte)()}]},(function(t){var e=(0,ut.peekBytes)(2)(t);return 33===e[0]&&249===e[1]})),o=(0,ct.conditional)({image:[{code:(0,ut.readByte)()},{descriptor:[{left:(0,ut.readUnsigned)(!0)},{top:(0,ut.readUnsigned)(!0)},{width:(0,ut.readUnsigned)(!0)},{height:(0,ut.readUnsigned)(!0)},{lct:(0,ut.readBits)({exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}})}]},(0,ct.conditional)({lct:(0,ut.readArray)(3,(function(t,e,i){return Math.pow(2,i.descriptor.lct.size+1)}))},(function(t,e,i){return i.descriptor.lct.exists})),{data:[{minCodeSize:(0,ut.readByte)()},i]}]},(function(t){return 44===(0,ut.peekByte)()(t)})),a=(0,ct.conditional)({text:[{codes:(0,ut.readBytes)(2)},{blockSize:(0,ut.readByte)()},{preData:function(t,e,i){return(0,ut.readBytes)(i.text.blockSize)(t)}},i]},(function(t){var e=(0,ut.peekBytes)(2)(t);return 33===e[0]&&1===e[1]})),r=(0,ct.conditional)({application:[{codes:(0,ut.readBytes)(2)},{blockSize:(0,ut.readByte)()},{id:function(t,e,i){return(0,ut.readString)(i.blockSize)(t)}},i]},(function(t){var e=(0,ut.peekBytes)(2)(t);return 33===e[0]&&255===e[1]})),s=(0,ct.conditional)({comment:[{codes:(0,ut.readBytes)(2)},i]},(function(t){var e=(0,ut.peekBytes)(2)(t);return 33===e[0]&&254===e[1]})),l=[{header:[{signature:(0,ut.readString)(3)},{version:(0,ut.readString)(3)}]},{lsd:[{width:(0,ut.readUnsigned)(!0)},{height:(0,ut.readUnsigned)(!0)},{gct:(0,ut.readBits)({exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}})},{backgroundColorIndex:(0,ut.readByte)()},{pixelAspectRatio:(0,ut.readByte)()}]},(0,ct.conditional)({gct:(0,ut.readArray)(3,(function(t,e){return Math.pow(2,e.lsd.gct.size+1)}))},(function(t,e){return e.lsd.gct.exists})),{frames:(0,ct.loop)([n,r,s,o,a],(function(t){var e=(0,ut.peekByte)()(t);return 33===e||44===e}))}];e.default=l})),dt=lt((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.deinterlace=void 0;e.deinterlace=function(t,e){for(var i=new Array(t.length),n=t.length/e,o=function(n,o){var a=t.slice(o*e,(o+1)*e);i.splice.apply(i,[n*e,e].concat(a))},a=[0,4,2,1],r=[8,8,4,2],s=0,l=0;l<4;l++)for(var c=a[l];c<n;c+=r[l])o(c,s),s++;return i}})),pt=lt((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.lzw=void 0;e.lzw=function(t,e,i){var n,o,a,r,s,l,c,u,h,d,p,g,f,v,y,m,b=i,T=new Array(i),w=new Array(4096),_=new Array(4096),x=new Array(4097);for(s=(o=1<<(d=t))+1,n=o+2,c=-1,a=(1<<(r=d+1))-1,u=0;u<o;u++)w[u]=0,_[u]=u;for(p=g=f=v=y=m=0,h=0;h<b;){if(0===v){if(g<r){p+=e[m]<<g,g+=8,m++;continue}if(u=p&a,p>>=r,g-=r,u>n||u==s)break;if(u==o){a=(1<<(r=d+1))-1,n=o+2,c=-1;continue}if(-1==c){x[v++]=_[u],c=u,f=u;continue}for(l=u,u==n&&(x[v++]=f,u=c);u>o;)x[v++]=_[u],u=w[u];f=255&_[u],x[v++]=f,n<4096&&(w[n]=c,_[n]=f,0==(++n&a)&&n<4096&&(r++,a+=n)),c=l}v--,T[y++]=x[v],h++}for(h=y;h<b;h++)T[h]=0;return T}})),gt=lt((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.decompressFrames=e.decompressFrame=e.parseGIF=void 0;var i,n=(i=ht)&&i.__esModule?i:{default:i};e.parseGIF=function(t){var e=new Uint8Array(t);return(0,ct.parse)((0,ut.buildStream)(e),n.default)};var o=function(t,e,i){if(t.image){var n=t.image,o=n.descriptor.width*n.descriptor.height,a=(0,pt.lzw)(n.data.minCodeSize,n.data.blocks,o);n.descriptor.lct.interlaced&&(a=(0,dt.deinterlace)(a,n.descriptor.width));var r={pixels:a,dims:{top:t.image.descriptor.top,left:t.image.descriptor.left,width:t.image.descriptor.width,height:t.image.descriptor.height}};return n.descriptor.lct&&n.descriptor.lct.exists?r.colorTable=n.lct:r.colorTable=e,t.gce&&(r.delay=10*(t.gce.delay||10),r.disposalType=t.gce.extras.disposal,t.gce.extras.transparentColorGiven&&(r.transparentIndex=t.gce.transparentColorIndex)),i&&(r.patch=function(t){for(var e=t.pixels.length,i=new Uint8ClampedArray(4*e),n=0;n<e;n++){var o=4*n,a=t.pixels[n],r=t.colorTable[a];i[o]=r[0],i[o+1]=r[1],i[o+2]=r[2],i[o+3]=a!==t.transparentIndex?255:0}return i}(r)),r}};e.decompressFrame=o;e.decompressFrames=function(t,e){return t.frames.filter((function(t){return t.image})).map((function(i){return o(i,t.gct,e)}))}}));var ft=function(t,e){void 0===e&&(e=function(){});var i=setTimeout((function(){e(),clearTimeout(i),i=null}),t)};var vt=function(t,e,i,n,o,a){void 0===i&&(i=""),void 0===o&&(o="application/json"),void 0===a&&(a=!0);var r=new XMLHttpRequest;return new Promise((function(s,l){r.open(e,t,!0),r.setRequestHeader&&a&&r.setRequestHeader("Content-Type",o),r.responseType=i;var c=JSON.stringify(n);r.send(c),r.onreadystatechange=function(){},r.onload=function(t){4===r.readyState&&200===r.status&&s(r.response)},r.onprogress=function(t){},r.onerror=function(){alert("http request errorï¼š"+t)}}))},yt=st.protocol,mt=M.getUrlParam,bt=gt.parseGIF,Tt=gt.decompressFrames,wt=ft,_t=vt,xt={jpg:At,png:At,gif:function(t){Mt(t,(function(){}))},sprite:function(t){k.loadAsyncSingleTexture(t.pic,(function(e){e.wrapS=e.wrapT=a.RepeatWrapping,e.repeat.set(t.tileVertical/t.tileCount,t.tileHorizontal/t.tileCount),t.setMap(e),t.updateScale()}))}},Pt=null,Ct=0;function Ot(t,e){void 0===e&&(e="tag"),null===Pt&&(Pt=n.get("ext")),a.Sprite.call(this),++Ct,this.name="face",this.data=t,this.adapter="w",this.userData.type=e,this.picW=t.width,this.picH=t.height,this.picType=t.type,this.pic=t.src.replace(yt,""),this.picRatio=t.width/t.height,this.picW>=this.picH?this.adapter="w":this.adapter="h",this.tileCount=t.tile_count,this.tileFrameDuration=t.tile_duration,this.tileHorizontal=t.tile_horizontal,this.tileVertical=t.tile_vertical,this.tileOrder=t.tile_order||1,this.currentDisplayTime=0,this.currentTile=1===this.tileOrder?this.tileCount-1:0,this._opacity=1,"w"===this.adapter&&(this.defaultScale={x:.68,y:.68/this.picRatio,z:1}),"h"===this.adapter&&(this.defaultScale={x:.68*this.picRatio,y:.68,z:1}),this.screenH=0,this.bg=null,this.material=new a.SpriteMaterial({transparent:!0,sizeAttenuation:!1,depthTest:"tag2"!==e}),this.topCenterScreen={x:0,y:0},this.bottomCenterScreen={x:0,y:0},this.renderOrder="tag2"===e?10+Ct:10,this.hovered=!1,this.setScale(0,0,0,"new");var i=mt("tag_face_opacity");i&&this.setOpacity(i,!0)}function Mt(t,i){var n=t.pic;if(Pt.gifMap[n]&&0<Pt.gifMap[n].length)return t.updateScale(),Dt(t,Pt.gifMap[n].length),void i();_t(n,"GET","arraybuffer",void 0,!1).then((function(n){Pt.gifMap[t.pic]=[];var o=bt(n);!function(t,i,n){var o=document.createElement("canvas"),a=o.getContext("2d"),r=document.createElement("canvas"),s=r.getContext("2d"),l=t.length;60<=l&&e.error("frame count:",l)();r.width=t[0].dims.width,r.height=t[0].dims.height;for(var c=0;c<l;++c){var u=t[c],h=u.delay,d=St(c,u,s,a,o,r);Et(i.pic,c,d,h)}g[T.TagLoaded].state=!0,i.updateScale(),Dt(i,l),n()}(Tt(o,!0),t,(function(){i()}))}))}function Dt(t,e){var i=0,n=function(){i===e&&(i=0);var o=function(t,e){return Pt.gifMap[t]&&Pt.gifMap[t][e]?Pt.gifMap[t][e].texture:null}(t.pic,i);if(null!==o){var a=function(t,e){return Pt.gifMap[t]&&Pt.gifMap[t][e]?Pt.gifMap[t][e].time:null}(t.pic,i);null!==a&&(t.setMap(o),t.setTransparent(!0),wt(a,(function(){n()})),i++)}};n()}function St(t,e,i,n,o,r){var s=e.dims,l=s.width,c=s.height;o.width=l,o.height=c;var u=n.createImageData(l,c);u.data.set(e.patch),n.putImageData(u,0,0),1!==e.disposalType&&i.clearRect(0,0,l,c),i.drawImage(o,s.left,s.top);var h=document.createElement("canvas"),d=h.getContext("2d");return h.width=r.width,h.height=r.height,d.drawImage(r,0,0),function(t){var e=new a.CanvasTexture(t);return e.minFilter=a.LinearFilter,e.magFilter=a.LinearFilter,e}(h)}function Et(t,e,i,n){Pt.gifMap[t][e]||(Pt.gifMap[t][e]={texture:i,time:n})}function At(t){k.loadAsyncSingleTexture(t.pic,(function(e){t.updateScale(),t.setMap(e)}))}Ot.prototype=Object.create(a.Sprite.prototype),Ot.prototype.init=function(){},Ot.prototype.addAxesHelper=function(){var t=new a.AxesHelper(4);this.add(t)},Ot.prototype.addBoxHelper=function(){this.boxHelper=new a.BoxHelper(this,16776960),this.boxHelper.update(),w.sceneAdd(this.boxHelper)},Ot.prototype.addBox=function(){var t=new a.Box3;this.box=t},Ot.prototype.getSize=function(){return this.scale},Ot.prototype.loadTexture=function(t){var e=this;"png"!==this.picType&&"jpg"!==this.picType||k.loadSingleTexture(this.pic,(function(i){e.setMap(i),g[T.TagLoaded].state=!0,e.updateScale(),t()})),"gif"===this.picType&&Mt(this,(function(){t()})),"sprite"===this.picType&&k.loadSingleTexture(this.pic,(function(i){i.wrapS=i.wrapT=a.RepeatWrapping,i.repeat.set(e.tileVertical/e.tileCount,e.tileHorizontal/e.tileCount),e.setMap(i),g[T.TagLoaded].state=!0,e.updateScale(),t()}))},Ot.prototype.updateTexture=function(t){var e=t.type,i=t.src,n=t.width,o=t.height,a=t.tile_count,r=t.tile_duration,s=t.tile_vertical,l=t.tile_horizontal,c=t.tile_order;this.picType=e,this.pic=i,this.picW=n,this.picH=o,this.picRatio=n/o,this.tileCount=a,this.tileFrameDuration=r,this.tileVertical=s,this.tileHorizontal=l,this.tileOrder=c,this.currentTile=1===this.tileOrder?this.tileCount-1:0,this.adapter=n>=o?"w":"h",xt[e](this)},Ot.prototype.updateSpriteTexture=function(){},Ot.prototype.getCameraVector=function(){var t=w.getCamera();t.updateMatrixWorld(),t.updateProjectionMatrix();this.position.clone().applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)},Ot.prototype.getLocalPosition=function(){return this.position.clone()},Ot.prototype.show=function(){!0!==this.visible&&(this.visible=!0)},Ot.prototype.hide=function(t){!1!==this.visible&&(this.visible=!1)},Ot.prototype.setMap=function(t){this.material.map&&this.material.map.dispose(),this.material.dispose(),this.material.map=t,this.material.needsUpdate=!0},Ot.prototype.setTransparent=function(t){this.material.transparent=t},Ot.prototype.setPosition=function(t){var e;(e=this.position).set.apply(e,t)},Ot.prototype.copyPosition=function(t){this.position.copy(t)},Ot.prototype.followLocationLine=function(t){this.setPosition([t[0],t[1],t[2]])},Ot.prototype.setTranslate=function(t){var e;(e=this.geometry).translate.apply(e,t)},Ot.prototype.setOpacity=function(t,e){var i;e?(this._opacity=t,i=t):i=this._opacity*t,this.material.opacity=i},Ot.prototype.setScale=function(t,e,i,n){this.scale.set(t,e,1),this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.screenH=0},Ot.prototype.setScale2=function(t){var e=1,i=1;"w"===this.adapter&&(i=(e=t)/this.picRatio),"h"===this.adapter&&(i=t,e=t*this.picRatio);this.setScale(e,i,1)},Ot.prototype.updateScale=function(){"w"===this.adapter&&this.setScale2(.68),"h"===this.adapter&&this.setScale2(.68)},Ot.prototype.onChoosed=function(){e.info(this.name+" choosed")()},Ot.prototype.unChoosed=function(){e.info(this.name+" unchoosed")()},Ot.prototype.setColor=function(t){this.material.color.setHex(t)},Ot.prototype.cancelSetColor=function(){this.material.color.r=1,this.material.color.g=1,this.material.color.b=1},Ot.prototype.getVH=function(){return this.scale.y+.18*this.scale.y},Ot.prototype.getScreenH=function(){var t=this.getTopCenterOfScreen(),e=this.getBottomCenterOfScreen();return this.screenH=Math.abs(e.y-t.y),this.screenH},Ot.prototype.getTopCenterOfScreen=function(){var t=w.getCamera(),e=t.zoom,i=70/t.fov,n=this._getWorldPosition().clone().project(t),o=new a.Vector3(n.x,n.y+this.getVH()*e*i*.6,n.z),r=(1+o.x)/2*w.getRenderWidth(),s=(1-o.y)/2*w.getRenderHeight();return this.topCenterScreen.x=Math.floor(r),this.topCenterScreen.y=Math.floor(s),this.topCenterScreen},Ot.prototype.getBottomCenterOfScreen=function(){var t=w.getCamera(),e=t.zoom,i=70/t.fov,n=this._getWorldPosition().clone().project(t),o=new a.Vector3(n.x,n.y-this.getVH()*e*i*.6,n.z),r=(1+o.x)/2*w.getRenderWidth(),s=(1-o.y)/2*w.getRenderHeight();return this.bottomCenterScreen.x=Math.floor(r),this.bottomCenterScreen.y=Math.floor(s),this.bottomCenterScreen},Ot.prototype._getWorldPosition=function(){return this.localToWorld(new a.Vector3)},Ot.prototype.getCenterOfScreen=function(){var t=this._getWorldPosition();return D.convertWorldPositionToScreen(t,w.getCamera())},Ot.prototype.addAxesHelper=function(){var t=new a.AxesHelper(.4);this.add(t)},Ot.prototype.onFrameUpdate=function(t){if(!0===g[T.TagLoaded].state&&"sprite"===this.picType){var i=1e3*t;if(this.currentDisplayTime+=i,this.currentDisplayTime>this.tileFrameDuration){this.currentDisplayTime=0;var n=0,o=0;-1===this.tileOrder&&(this.currentTile===this.tileCount&&(this.currentTile=0),n=this.currentTile%this.tileHorizontal,o=Math.floor(this.currentTile/this.tileHorizontal),this.currentTile++),1===this.tileOrder&&(-1===this.currentTile&&(this.currentTile=this.tileCount-1),n=this.currentTile%this.tileHorizontal,o=Math.floor(this.currentTile/this.tileHorizontal),this.currentTile--);var a=n/this.tileHorizontal,r=o/this.tileVertical;if(!this.material.map)return void e.error("update tag sprite failure, reason: unget map.offset!")();this.material.map.offset.set(a,r)}}},Ot.prototype.clearCache=function(){this.material.map&&this.material.map.dispose(),this.material.dispose(),this.geometry.dispose()},Ot.prototype.destroy=function(){e.info("%c"+this.name+" destroy","color:#f00;")(),this.clearCache()};var It=Ot,Lt=N.Resource,Ht=F,Bt=Y.isNum;function kt(t){a.Group.call(this),this.name="tag-"+this.uuid,this.applicationId=t.id,this.data=t,this.head=null,this.plane=null,this.basePlate=null,this.locationLine=null,this.isChoosed=!1,this.visible=!0,this.isPutDown=!1,this.tween=null,this.opacity=1,this.setUserData("type","tag"),this.onTextureLoaded=function(){}}kt.prototype=Object.create(a.Group.prototype),kt.prototype.init=function(){this.bundleData(),this.addBasePlate(),this.addLocationLine(),this.addHead(),this.syncData()},kt.prototype.bundleData=function(){var t=new Q(this);this.setUserData("setting_item",t)},kt.prototype.syncData=function(){var t=this.getUserData("setting_item");if(t.uuid=this.uuid,this.data.isSaved)t.location_id=this.data.location_id,t.visible=this.data.visible,this.data.rotation&&(this.setQuaternion(this.data.rotation),this.setPosition(this.data.position)),this.data.normal&&this.lookAtNormal(this.data.normal,this.data.position),!0===this.data.visible&&this.show("sync.data");else{var e=this.data.position;if(e){var i=w.getIntersectWithinPointer(e.x,e.y);i&&this.followMoving(i)}}this.updateMatrix(),this.updateMatrixWorld()},kt.prototype.show=function(t){this.getUserData("setting_item").visible=!0,this.visible=!0},kt.prototype.hide=function(t){this.getUserData("setting_item").visible=!1,this.visible=!1},kt.prototype.setUserData=function(t,e){this.userData[t]=e},kt.prototype.setPosition=function(t){this.position.copy(t)},kt.prototype.setQuaternion=function(t){this.quaternion.copy(t)},kt.prototype.lookAtNormal=function(t,e){this.position.set(0,0,0),this.lookAt(t.x,t.y,t.z),this.position.copy(e),this.updateMatrix(),this.updateMatrixWorld()},kt.prototype.getUserData=function(t){return this.userData[t]},kt.prototype.followMoving=function(t){if(t){var e=n.get("ext"),i=t.point,o=t.normal,a=i.clone();this.position.set(0,0,0),this.lookAt(o),this.position.copy(a),this.updateMatrix(),this.updateMatrixWorld(),this.head&&this.head.onFollowMoving(),e.tagsMap.forEach((function(t){t.label&&t.label.disablePointerEvent()})),e.onTagFollowMoving(this)}},kt.prototype.dragMoving=function(t){var e=t.point,i=t.normal,o=e.clone();this.position.set(0,0,0),this.lookAt(i),this.setPosition(o),this.setQuaternion(this.quaternion),this.updateMatrix(),this.updateMatrixWorld(),this.head&&this.head.onDragMoving(),this.label&&this.label.onDragMoving(),n.get("ext")._methods.getOtherTags(this.uuid).forEach((function(t){t.label&&t.label.disablePointerEvent()})),n.get("ext").onTagDragMoving(this)},kt.prototype.dragMovingEnd=function(){var t=n.get("ext");this.head&&this.head.onDragMovingEnd(),this.title&&this.title.onDragMovingEnd(),this.label&&this.label.onDragMovingEnd(),t._methods.getOtherTags(this.uuid).forEach((function(t){t.label&&t.label.enablePointerEvent()})),n.get("ext").onTagDragMovingEnd(this)},kt.prototype.addHead=function(t){var e=this,i=Lt.tagHeadBg,n=this.getUserData("setting_item"),o=new rt;if(this.add(o),this.head=o,this.locationLine&&(o.position.z=n.location_line.length),this.data.isSaved){var a=this.data.face.visible,r=this.data.face.bg_color,s=M.getUrlParam("tag_head_opacity")||this.data.face.bg_opacity,l=this.data.face.scale;s*=1,r&&o.setColor(1*("0x"+r)),Bt(s)&&o.setOpacity(s,!0),l&&o.setUserData("origin_scale_rate",l),!0===a?o.show():o.hide()}else{var c=this.data.face_scale||1,u=this.data.head_bg_color||"ffffff",h=this.data.head_bg_opacity;o.setUserData("origin_scale_rate",c),o.setColor(1*("0x"+u)),o.setOpacity(h,!0)}o.updateMatrix(),o.updateMatrixWorld(),this.addFace(),k.loadSingleTexture(i,(function(t){o.setMap(t),e.plane.loadTexture((function(){e.onTextureLoaded(e.uuid)}))}))},kt.prototype.addFace=function(){var t=null;t=this.data.isSaved?{type:this.data.face.type,src:this.data.face.src,width:this.data.face.width,height:this.data.face.height,tile_count:this.data.face.tile_count,tile_horizontal:this.data.face.tile_horizontal,tile_vertical:this.data.face.tile_vertical,tile_duration:this.data.face.tile_duration,tile_order:this.data.face.tile_order,scale:this.data.face.scale,visible:this.data.face.visible}:{type:this.data.type,src:this.data.src,width:this.data.width,height:this.data.height,tile_count:this.data.tile_count,tile_horizontal:this.data.tile_horizontal,tile_vertical:this.data.tile_vertical,tile_duration:this.data.tile_duration,tile_order:this.data.tile_order,scale:this.data.scale,visible:!0};var e=this.getUserData("setting_item"),i=new It(t);i.settingItem=e,this.head.add(i),this.plane=i},kt.prototype.addTitle=function(t){var e=this.getUserData("setting_item");this.label=L.createLabel(t,e);var i=null;i=this.head.visible?this.head.getTopCenterOfScreen():this.head.getCenterOfScreen(),this.label.updatePosition(i,"add.title")},kt.prototype.addBasePlate=function(){var t=new tt(200,200);this.add(t),this.basePlate=t},kt.prototype.addLocationLine=function(){var t="tag: add.location.line",e=this.basePlate.position.clone(),i=e.clone(),n=new K(e,i);this.add(n);var o=1,a=!0;this.data.isSaved?(o=this.data.location_line.length,a=this.data.location_line.visible):(o=this.data.location_line_len,a=this.data.location_line_visible),this.locationLine=n,n.setLength(o,t),a?n.show(t):n.hide(t)},kt.prototype.removeLocationLine=function(){var t=this.getObjectByName("location.line");t&&this.removeChild(t)},kt.prototype.removeBasePlate=function(){var t=this.getObjectByName("base.plate");t&&this.removeChild(t)},kt.prototype.removeChild=function(t){t.geometry&&t.geometry.dispose(),t.material&&(t.material.dispose(),t.material.map&&t.material.map.dispose()),this.remove(t)},kt.prototype.cancelAdd=function(){n.get("ext").onTagCancelAdd(this)},kt.prototype.putDown=function(){if(!0!==g[T.StopLoading].state){var t=n.get("ext"),i=this.getUserData("setting_item"),o="rgb(255, 255, 255)",a=1;this.data.isSaved&&(o=this.data.location_line.color||o,a=this.data.location_line.width||a),this.basePlate&&this.basePlate.hide(),this.locationLine&&(this.locationLine.setWidth(a),this.locationLine.setColor(o));var r=w.getFloorsInfo(),s=[];if(r.forEach((function(t){var e=t.idx,n=w.getFloorBox3(e);s[e]=n,n&&i.floor.push(e)})),this.data.title){var l={uuid:this.uuid,text:this.data.title.text,font_size:this.data.title.font_size,font_color:this.data.title.font_color,bg_color:this.data.title.bg_color,visible:this.data.title.visible};this.addTitle(l)}this.head&&this.head.onPutDown(),this.setOriginData(),t.onTagPutDown(this),t.tagsMap.forEach((function(t){t.label&&t.label.enablePointerEvent()})),this.isPutDown=!0}else e.error(this.name+" put down failure, reason: stop loading")()},kt.prototype.setOriginData=function(){var t=this.userData.setting_item;t._position=this.position,t._quaternion=this.quaternion,t._scale=this.plane.scale},kt.prototype.choosed=function(){!0!==this.isChoosed?(this.isChoosed=!0,this.basePlate&&this.basePlate.show(),this.plane&&this.plane.onChoosed(),n.get("ext").onTagChoosed(this)):e.info("tag "+this.uuid+" is choosed")()},kt.prototype.unChoosed=function(){!1!==this.isChoosed&&(this.isChoosed=!1,this.basePlate&&this.basePlate.hide(),this.plane&&this.plane.unChoosed(),n.get("ext").onTagUnChoosed(this))},kt.prototype.delete=function(){this.unChoosed(),this.label&&this.deleteTitle(this.label),n.get("ext").onTagDeleted(this)},kt.prototype.deleteTitle=function(t){t.remove(),this.label=null},kt.prototype.onSwitchPano=function(t){this.title&&this.title.onSwitchPano()},kt.prototype.onRendererResize=function(t){this.locationLine&&this.locationLine.onRendererResize(t)},kt.prototype.onFrameUpdate=function(t){this.head&&this.head.onFrameUpdate(t),this.label&&this.label.onFrameUpdate(),this.css2dLabel&&this.css2dLabel.onFrameUpdate()},kt.prototype.getLocationLineLength=function(){if(this.locationLine)return this.locationLine.getLength()},kt.prototype.hideLocationLine=function(){this.locationLine.hide("tag.hide.location.line")},kt.prototype.showLocationLine=function(){this.locationLine?this.locationLine.show("tag.show.location.line"):e.warn("tag show location line failure, reason: has not location line")()},kt.prototype.checkIsInVisualRange=function(t){return!this.head.computeIsOutVisualRangle()},kt.prototype.getOutputSettingItem=function(){var t=this.getUserData("setting_item");return Ht(t)},kt.prototype.createAnimate=function(t,e){var i=this,o=n.get("ext").parent.TWEEN;this.removeAnimate();var a={opacity:this.opacity},r={opacity:t},s=new o.Tween(a).to(r,e).easing(o.Easing.Linear.None).onUpdate((function(t){var e=t.opacity;i.opacity=e,i.basePlate&&(i.basePlate.material.opacity=e),i.locationLine&&(i.locationLine.material.opacity=e),i.label&&(i.label.style.opacity=e),i.head&&i.head.setOpacity(e),i.plane&&i.plane.setOpacity(e)})).start();this.tween=s},kt.prototype.removeAnimate=function(){var t=n.get("ext").parent.TWEEN;this.tween&&(t.remove(this.tween),this.tween=null)},kt.prototype.onLocationLineChanged=function(t){this.head&&this.head.onLocationLineChanged(t)},kt.prototype.destroy=function(){e.info("%c"+this.name+" destroy","color:#f00;")(),this.head&&this.head.destroy(),this.plane&&this.plane.destroy(),this.locationLine&&this.locationLine.destroy()};var zt=kt;var Rt=function(t,e,i,n,o,a){void 0===o&&(o=1),void 0===a&&(a="#00f");var r=t<i?t:i,s=e<n?e:n,l=Math.abs(t-i),c=Math.abs(e-n),u=Math.ceil(Math.sqrt(l*l+c*c));return{width:u+"px",height:o+"px",backgroundColor:""+a,transform:"translate("+(r+(l-u)/2)+"px, "+(s+(c-o)/2)+"px) rotate("+Math.atan2(e-n,t-i)+"rad)"}},Vt=Object.create(null),Ut=null;Vt.createLine=function(t,i){null===Ut&&(Ut=n.get("ext"));var o=document.createElement("div"),r=t.uuid,s=t.begin,l=t.end,c=t.color,u=t.width,h=t.visible,d=t.length;o.style.cssText="\n       position: absolute;\n       pointer-events: none;\n       top: 0;\n       z-index: 1;\n     ";var p=Rt(s.x,s.y,l.x,l.y,u,c);return o.setAttribute("tag-uuid",r),o.id="line-"+r,o.pid=r,o.width=u,o.length=100*d,o.color=c,o.visible=h,o.setVisible=h,o.settingItem=i,o.style.width=p.width,o.style.height=p.height,o.style.backgroundColor=p.backgroundColor,o.style.transform=p.transform,document.getElementById("renderer-stage").appendChild(o),i.location_line.visible=h,i.location_line.length=d,i.location_line.width=u,i.location_line.color=c,function(t){t.isVisible=function(){return"hidden"!==t.style.visibility&&("visible"===t.style.visibility||void 0)},t.hide=function(e){e&&(t.setVisible=!1),t.visible=!1,t.settingItem.location_line.visible=!1,!1!==t.isVisible()&&(t.style.visibility="hidden")},t.show=function(e){e&&(t.setVisible=!0),t.setVisible&&(t.visible=!0,t.settingItem.location_line.visible=!0,!0!==t.isVisible()&&(t.style.visibility="visible"))},t.restoreVisible=function(){!0===t.visible?t.show("restore.visible"):t.hide("restore.visible")},t.remove=function(){var e=w.getRendererStage();t.style.display="none",e.removeChild(t)},t.setLength=function(i,n){var o=100*i;if(o!==t.length){t.length=o;var r=n||Ut._methods.getTag(t.pid,"line.set.length");if(r){r.getUserData("setting_item").location_line.length=.01*i;var s=r.getPositionOfScreen(),l={x:s.x,y:s.y-t.length},c=Rt(s.x,s.y,l.x,l.y,t.width,t.color);t.style.width=c.width,t.style.height=c.height,t.style.backgroundColor=c.backgroundColor,t.style.transform=c.transform;var u=D.convertScreenPositionToNDC(l.x,l.y),h=new a.Vector3(u.x,u.y,0).unproject(w.getCamera()),d=r.worldToLocal(h.clone());if(r.head&&r.head.setPosition(d),r.label){var p=r.head.getTopCenterOfScreen();r.label.updatePosition(p,"set.length")}}}else e.warn("location line set length failure, reason: same length")()},t.setWidth=function(e,i){t.width=e;var n=i||Ut._methods.getTag(t.pid,"line.set.width");if(n){n.getUserData("setting_item").location_line.width=e;var o=n.getPositionOfScreen(),a={x:o.x,y:o.y-t.length},r=Rt(o.x,o.y,a.x,a.y,t.width,t.color);t.style.width=r.width,t.style.height=r.height,t.style.backgroundColor=r.backgroundColor,t.style.transform=r.transform}},t.setColor=function(e){t.style.backgroundColor=e,t.color=e;var i=Ut._methods.getTag(t.pid,"line.set.color");i&&(i.getUserData("setting_item").location_line.color=e)},t.updatePosition=function(e,i){var n=e.getPositionOfScreen(),o={x:n.x,y:n.y-t.length},r=Rt(n.x,n.y,o.x,o.y,t.width,t.color);o.y=o.y-.68*e.head.getScreenH()*.5,t.style.width=r.width,t.style.height=r.height,t.style.backgroundColor=r.backgroundColor,t.style.transform=r.transform;var s=D.convertScreenPositionToNDC(o.x,o.y),l=new a.Vector3(s.x,s.y,0).unproject(w.getCamera());e.updateMatrixWorld();var c=e.worldToLocal(l.clone());e.head&&e.head.setPosition(c)},t.onFollowMoving=function(e){t.show(),t.updatePosition(e,"on.follow.moving")},t.onDragMoving=function(t){},t.onFrameUpdate=function(e){!1!==t.settingItem.visible&&t.updatePosition(e,"on.frame.update")}}(o),o.hide(),o};var jt=Vt,Nt=N.Resource,Wt=Object.create(null),Ft=null;function Gt(t){var e=this;null===Ft&&(Ft=n.get("ext")),a.Sprite.call(this),this.name="base.plate",this.material=new a.SpriteMaterial({map:null,opacity:1,transparent:!0,sizeAttenuation:!1,depthTest:!1,depthWrite:!1}),this.renderOrder=10,this.myStatus=Wt,k.loadSingleTexture(Nt.tagBasePlate,(function(t){e.setMap(t)})),this.setScale(.04),this.setScalar(1)}Wt.isHover=!1,Gt.prototype=Object.create(a.Sprite.prototype),Gt.prototype.init=function(){},Gt.prototype.show=function(){this.visible=!0},Gt.prototype.hide=function(){this.visible=!1},Gt.prototype.hover=function(){!0!==this.myStatus.isHover&&(this.myStatus.isHover=!0,window.document.body.style.cursor="pointer",Ft.onBasePlateHover(this))},Gt.prototype.hoverOut=function(){!1!==this.myStatus.isHover&&(this.myStatus.isHover=!1,window.document.body.style.cursor="",Ft.onBasePlateHoverOut(this))},Gt.prototype.click=function(){Ft.onBasePlateClick(this)},Gt.prototype.setMap=function(t){this.material.map=t,this.material.needsUpdate=!0},Gt.prototype.setPosition=function(t){var e;(e=this.position).set.apply(e,t)},Gt.prototype.setScale=function(t){this.scale.set(t,t,t),this.setUserData("default_scale",t)},Gt.prototype.setScalar=function(t){var e=this.getUserData("default_scale");this.setScale(e),this.scale.multiplyScalar(t),this.setUserData("current_scalar",t)},Gt.prototype.setUserData=function(t,e){this.userData[t]=e},Gt.prototype.getUserData=function(t){return this.userData[t]},Gt.prototype.getLocalPosition=function(){return this.position.clone()},Gt.prototype.getWorldPosition=function(){return this.parent.updateMatrixWorld(!0),this.parent.localToWorld(this.getLocalPosition()).clone()},Gt.prototype.onFollowMoving=function(){};var qt=Gt,Yt=N.Resource,Qt=F,Zt=Y.isNum,Xt=null;function Kt(t){null===Xt&&(Xt=n.get("ext")),a.Group.call(this),this.name="tag-"+this.uuid,this.applicationId=t.id,this.data=t,this.locationLine=null,this.head=null,this.plane=null,this.isChoosed=!1,this.setUserData("type","tag2"),this.onTextureLoaded=function(){}}Kt.prototype=Object.create(a.Group.prototype),Kt.prototype.init=function(){this.bundleData(),this.addBasePlate(),this.addLocationLine(),this.addHead(),this.syncData()},Kt.prototype.bundleData=function(){var t=new Q(this);this.setUserData("setting_item",t)},Kt.prototype.addBasePlate=function(){var t=new qt(200,200);this.add(t),this.basePlate=t},Kt.prototype.addAxesHelper=function(){var t=new a.AxesHelper(.4);this.add(t)},Kt.prototype.show=function(t){this.visible=!0,this.getUserData("setting_item").visible=this.visible,this.locationLine&&this.locationLine.show()},Kt.prototype.hide=function(){this.visible=!1,this.getUserData("setting_item").visible=this.visible,this.label&&this.label.hide("tag2.hide"),this.locationLine&&this.locationLine.hide()},Kt.prototype.setUserData=function(t,e){this.userData[t]=e},Kt.prototype.getUserData=function(t){return this.userData[t]},Kt.prototype.followMoving=function(t){var e=t.point,i=(t.normal,e.clone());this.position.copy(i),this.locationLine&&this.locationLine.onFollowMoving(this),this.head&&this.head.onFollowMoving(),n.get("ext").tagsMap.forEach((function(t){t.label&&t.label.disablePointerEvent()})),Xt.onTagFollowMoving(this)},Kt.prototype.getPositionOfScreen=function(){return D.convertWorldPositionToScreen(this.position.clone(),w.getCamera())},Kt.prototype.getPlaneBottomPositionOfScreen=function(){var t=this.position.clone();return t.y+=.05,D.convertWorldPositionToScreen(t,w.getCamera())},Kt.prototype.dragMoving=function(t){var e=t.point,i=t.normal;e=e.clone().add(i.clone()),this.position.copy(e),this.setPosition(e),this.setQuaternion(this.quaternion),this.locationLine&&this.locationLine.onDragMoving(this),this.head&&this.head.onDragMoving(),this.label&&this.label.onDragMoving(),Xt._methods.getOtherTags(this.uuid).forEach((function(t){t.label&&t.label.disablePointerEvent()})),Xt.onTagDragMoving(this)},Kt.prototype.dragMovingEnd=function(){this.head&&this.head.onDragMoving(),this.label&&this.label.onDragMovingEnd(),Xt._methods.getOtherTags(this.uuid).forEach((function(t){t.label&&t.label.enablePointerEvent()})),Xt.onTagDragMovingEnd(this)},Kt.prototype.addLocationLine=function(t){var e=null;if(this.data.isSaved)e={uuid:this.uuid,begin:{x:0,y:0},end:{x:0,y:100*this.data.location_line.length},width:this.data.location_line.width,length:this.data.location_line.length,color:this.data.location_line.color,visible:this.data.location_line.visible};else{var i=this.data.location_line_len||.6;e={uuid:this.uuid,begin:{x:0,y:0},end:{x:0,y:100*i},width:1,length:i,color:"rgb(255, 255, 255)",visible:!0}}var n=this.getUserData("setting_item"),o=jt.createLine(e,n);this.locationLine=o},Kt.prototype.addHead=function(){var t=this,e=Yt.tagHeadBg,i=this.getUserData("setting_item"),n=new rt("tag2");if(this.head=n,this.locationLine&&(n.position.z=i.location_line.length),this.data.isSaved){var o=this.data.face.visible,a=this.data.face.bg_color,r=M.getUrlParam("tag_head_opacity")||this.data.face.bg_opacity,s=this.data.face.scale;r*=1,a&&n.setColor(1*("0x"+a)),Zt(r)&&n.setOpacity(r,!0),s&&n.setUserData("origin_scale_rate",s),!0===o?n.show():n.hide()}else{var l=this.data.face_scale||1,c=this.data.head_bg_color||"ffffff",u=this.data.head_bg_opacity;n.setUserData("origin_scale_rate",l),n.setColor(1*("0x"+c)),Zt(u)&&n.setOpacity(u,!0)}n.updateMatrix(),n.updateMatrixWorld(),this.add(n),this.addFace(),k.loadSingleTexture(e,(function(e){n.setMap(e),t.plane.loadTexture((function(){t.onTextureLoaded(t.uuid)}))}))},Kt.prototype.addBasePlate=function(){var t=new qt("tag2");this.basePlate=t,this.add(t)},Kt.prototype.addFace=function(t){var e=null;e=this.data.isSaved?{type:this.data.face.type,src:this.data.face.src,width:this.data.face.width,height:this.data.face.height,tile_count:this.data.face.tile_count,tile_horizontal:this.data.face.tile_horizontal,tile_vertical:this.data.face.tile_vertical,tile_duration:this.data.face.tile_duration,tile_order:this.data.face.tile_order,scale:this.data.face.scale,visible:this.data.face.visible}:{type:this.data.type,src:this.data.src,width:this.data.width,height:this.data.height,tile_count:this.data.tile_count,tile_horizontal:this.data.tile_horizontal,tile_vertical:this.data.tile_vertical,tile_duration:this.data.tile_duration,tile_order:this.data.tile_order,scale:this.data.scale,visible:!0};var i=this.getUserData("setting_item"),n=new It(e,"tag2");n.settingItem=i,this.head.add(n),this.plane=n},Kt.prototype.addTitle=function(t){var e=this.getUserData("setting_item");this.label=L.createLabel(t,e);var i=null;i=this.head.visible?this.head.getTopCenterOfScreen():this.head.getCenterOfScreen(),this.label.updatePosition(i,"add.title")},Kt.prototype.removeChild=function(t){t.geometry&&t.geometry.dispose(),t.material&&(t.material.dispose(),t.material.map&&t.material.map.dispose()),this.remove(t)},Kt.prototype.cancelAdd=function(){this.locationLine&&this.deleteLocationLine(),Xt.onTagCancelAdd(this)},Kt.prototype.putDown=function(){if(!0!==g[T.StopLoading].state){if(this.basePlate&&this.basePlate.hide(),this.locationLine&&(this.locationLine.updatePosition(this,"tag2.put.down"),this.data.isSaved&&(!1===this.locationLine.visible&&this.locationLine.hide(),!0===this.locationLine.visible&&this.locationLine.show())),this.data.title){var t={uuid:this.uuid,text:this.data.title.text,font_size:this.data.title.font_size,font_color:this.data.title.font_color,bg_color:this.data.title.bg_color,visible:this.data.title.visible};this.addTitle(t)}this.data.isSaved&&(this.data.visible&&"panorama"===w.getCurrentMode()?this.show("put.down"):this.hide("put.down")),this.head&&this.head.onPutDown(),function(t){var e=t.userData.setting_item;e._position=t.position,e._quaternion=t.quaternion,e._scale=t.plane.scale}(this),Xt.onTagPutDown(this),n.get("ext").tagsMap.forEach((function(t){t.label&&t.label.enablePointerEvent()})),this.isPutDown=!0}else e.error(this.name+" put down failure, reason: stop loading")()},Kt.prototype.choosed=function(){!0!==this.isChoosed?(this.isChoosed=!0,this.basePlate&&this.basePlate.show(),this.plane&&this.plane.onChoosed(),Xt.onTagChoosed(this)):e.warn("tag "+this.uuid+" already choosed")()},Kt.prototype.unChoosed=function(){!1!==this.isChoosed&&(this.isChoosed=!1,this.plane&&this.plane.unChoosed(),this.basePlate&&this.basePlate.hide(),Xt.onTagUnChoosed(this))},Kt.prototype.delete=function(){this.unChoosed(),this.label&&this.deleteTitle(this.label),this.locationLine&&this.deleteLocationLine(),Xt.onTagDeleted(this)},Kt.prototype.deleteTitle=function(t){t.remove(),this.label=null},Kt.prototype.deleteLocationLine=function(){this.locationLine.remove(),this.locationLine=null},Kt.prototype.syncData=function(){if(this.getUserData("setting_item").uuid=this.uuid,this.data.isSaved)this.setPosition(this.data.position),this.setQuaternion(this.data.rotation),this.setVisible(this.data.visible);else{var t=this.data.position,e=w.getIntersectWithinPointer(t.x,t.y);e&&this.followMoving(e)}},Kt.prototype.setPosition=function(t){this.position.copy(t)},Kt.prototype.setQuaternion=function(t){this.quaternion.copy(t)},Kt.prototype.setVisible=function(t){t?this.show("set.visible"):this.hide("set.visible")},Kt.prototype.getOutputSettingItem=function(){var t=this.getUserData("setting_item");return Qt(t)},Kt.prototype.onFrameUpdate=function(t){this.locationLine&&this.locationLine.onFrameUpdate(this),this.head&&this.head.onFrameUpdate(t),this.label&&this.label.onFrameUpdate()},Kt.prototype.showLocationLine=function(t){this.locationLine?this.locationLine.show(!0):e.warn("tag show location line failure, reason: has not location line")()},Kt.prototype.hideLocationLine=function(){this.locationLine?this.locationLine.hide(!0):e.warn("tag hide location line failure, reason: has not location line")()},Kt.prototype.destroy=function(){e.info("%c"+this.name+" destroy","color:#f00;")(),this.head&&this.head.destroy(),this.plane&&this.plane.destroy()};var Jt=Kt,$t=function(){var t=function(t){a.MeshBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.transparent=!0,this.opacity=.5,this.color.setHex(t.color),this.highlight=function(t){this.opacity=t?1:.5}};(t.prototype=Object.create(a.MeshBasicMaterial.prototype)).constructor=t;var e=function(t){a.LineBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.transparent=!0,this.linewidth=1,this.color.setHex(t.color),this.highlight=function(t){}};(e.prototype=Object.create(a.LineBasicMaterial.prototype)).constructor=e;var i=function(){for(var t=[{x:26,y:16},{x:26,y:6},{x:-54,y:6},{x:-54,y:-6},{x:26,y:-6},{x:26.1,y:-16.1},{x:54,y:0}],e=new a.Shape,i=0,n=t.length;i<n;++i)0===i?e.moveTo(t[i].x,t[i].y):e.lineTo(t[i].x,t[i].y);return new a.ExtrudeBufferGeometry(e,{depth:8,bevelEnabled:!1,bevelSegments:1,steps:1,bevelSize:1,bevelThickness:1})},n=function(t){var e=[{x:-84.5,y:21.5},{x:-82.8,y:-11.5},{x:-72,y:-2.7},{x:-60.3,y:-7.8},{x:-50.2,y:-11.9},{x:-36.3,y:-16.2},{x:-24.8,y:-18.8},{x:-10.57,y:-21.01},{x:6.4,y:-21.74},{x:20.67,y:-21.09},{x:35.02,y:-18.28},{x:45.3,y:-15.7},{x:56.5,y:-11.5},{x:72.6,y:-4.5},{x:83.5,y:-13.5},{x:84.5,y:20.5},{x:52.5,y:13.1},{x:60.7,y:5},{x:48.38,y:.6},{x:35.6,y:-3.1},{x:24.7,y:-5.2},{x:12.9,y:-6.7},{x:-1.6,y:-7},{x:-14.9,y:-5.7},{x:-27.8,y:-3.2},{x:-41.2,y:.5},{x:-50.7,y:3.9},{x:-59.7,y:7.6},{x:-51.8,y:14.4}],i=new a.Shape;i.moveTo(e[0].x,e[0].y);for(var n=1;n<e.length;++n)i.lineTo(e[n].x,e[n].y);return new a.ExtrudeGeometry(i,{depth:t,bevelEnabled:!1,bevelSegments:1,steps:1,bevelSize:1,bevelThickness:1})},o=function(){var t=(new a.TextureLoader).load(N.rotateControlTorus);t.minFilter=a.LinearFilter,t.magFilter=a.LinearFilter;var e=new a.PlaneBufferGeometry(4,4),i=new a.MeshBasicMaterial({map:t,side:a.DoubleSide,transparent:!0,depthTest:!1,depthWrite:!1});return new a.Mesh(e,i)},r=function(){var t=(new a.TextureLoader).load(N.rotateControlArcSurface);t.minFilter=a.LinearFilter,t.magFilter=a.LinearFilter;var e=new a.PlaneBufferGeometry(2.84,.74),i=new a.MeshBasicMaterial({map:t,side:a.DoubleSide,transparent:!0,depthTest:!1,depthWrite:!1});return new a.Mesh(e,i)},s=function(e){var i=new a.Group,s=new a.Mesh(new n(8),new t({color:e.color}));s.name=e.name,s.scale.set(.01,.01,.01),s.position.set(0,-1.84,0),s.userData.isPicker=!0,i.add(s);var l=new o;l.name="Torus",l.visible=!1,i.add(l);var c=new r;return c.name="ArcSurface",c.visible=!1,c.position.y-=1.84-.37+.18,c.position.z+=.01,i.add(c),i};function l(t,e){a.Object3D.call(this),e=void 0!==e?e:document,this.object=void 0,this.visible=!1,this.translationSnap=null,this.rotationSnap=null,this.space="world",this.size=1,this.axis=null,this.currentWorldPosition=new a.Vector3,this.clock=new a.Clock,this.delta=0,this.MOVELOCK={X:{state:!1,crash_point:null},Y:{state:!1,crash_point:null},Z:{state:!1,crash_point:null}};var i=this,n="translate",o=!1,r={translate:new a.TransformGizmoTranslate,rotate:new a.TransformGizmoRotate};for(var s in this._gizmo=r,r){var l=r[s];l.visible=s===n,this.add(l)}var c={type:"change"},u={type:"mouseDown"},h={type:"mouseUp",mode:n},d={type:"objectChange"},p={type:"hover.in"},g={type:"hover.out"},f=new a.Raycaster,v=new a.Vector2,y=new a.Vector3,m=new a.Vector3,b=new a.Vector3,T=new a.Vector3,w=1,_=(new a.Matrix4,new a.Vector3),x=new a.Matrix4,P=new a.Vector3,C=new a.Quaternion,O=new a.Vector3(1,0,0),M=new a.Vector3(0,1,0),D=new a.Vector3(0,0,1),S=new a.Quaternion,E=new a.Quaternion,A=new a.Quaternion,I=new a.Quaternion,L=(new a.Quaternion,new a.Vector3),H=new a.Vector3,B=new a.Matrix4,k=new a.Matrix4,z=new a.Vector3,R=new a.Vector3,V=new a.Euler,U=new a.Matrix4,j=new a.Vector3,N=new a.Euler;function W(t){if(void 0!==i.object&&!0!==o&&(void 0===t.button||0===t.button)){var e=Y(t.changedTouches?t.changedTouches[0]:t,r[n].pickers.children),a=null;e?(i.dispatchEvent(p),a=e.object.userData.axis,t.preventDefault()):i.dispatchEvent(g),i.axis!==a&&(i.axis=a,i.update(),i.dispatchEvent(c))}}function F(t){if(void 0!==i.object&&!0!==o&&(void 0===t.button||0===t.button)){var e=t.changedTouches?t.changedTouches[0]:t;if(0===e.button||void 0===e.button){var a=Y(e,r[n].pickers.children);if(a){t.preventDefault(),t.stopPropagation(),i.dispatchEvent(u),i.axis=a.object.userData.axis,i.update(),_.copy(j).sub(R).normalize(),r[n].setActivePlane(i.axis,_);var s=Y(e,[r[n].activePlane]);s&&(L.copy(i.object.position),H.copy(i.object.scale),B.extractRotation(i.object.matrix),U.extractRotation(i.object.matrixWorld),k.extractRotation(i.object.parent.matrixWorld),z.setFromMatrixScale(x.getInverse(i.object.parent.matrixWorld)),m.copy(s.point));var l=a.object,c=i.getMode(),h=i._gizmo[c].pickerGizmos;if("rotate"===c&&l.userData.isPicker){for(var d in h){h[d][0][0].children[0].visible=!1}l.parent.getObjectByName("Torus").visible=!0,l.parent.getObjectByName("ArcSurface").visible=!0}if("translate"===c&&l.userData.isPicker)for(var p in h){var g=h[p][0][0];i.axis!==p&&(g.visible=!1)}}}o=!0}}function G(t){if(void 0!==i.object&&null!==i.axis&&!1!==o&&(void 0===t.button||0===t.button)){var e=Y(t.changedTouches?t.changedTouches[0]:t,[r[n].activePlane]);if(!1!==e){if(t.preventDefault(),t.stopPropagation(),y.copy(e.point),"translate"===n){if(i.MOVELOCK[i.axis].state)return;y.sub(m),y.multiply(z),"world"!==i.space&&-1===i.axis.search("XYZ")||(-1===i.axis.search("X")&&(y.x=0),-1===i.axis.search("Y")&&(y.y=0),-1===i.axis.search("Z")&&(y.z=0),y.applyMatrix4(x.getInverse(k)),i.object.position.copy(L),i.object.position.add(y))}if("rotate"===n){if(i.MOVELOCK[i.axis].state)return;if(y.sub(R),y.multiply(z),P.copy(m).sub(R),P.multiply(z),"world"===i.space){var s,l;if(b.set(Math.atan2(y.z,y.y),Math.atan2(y.x,y.z),Math.atan2(y.y,y.x)),T.set(Math.atan2(P.z,P.y),Math.atan2(P.x,P.z),Math.atan2(P.y,P.x)),C.setFromRotationMatrix(x.getInverse(k)),null!==i.rotationSnap?(E.setFromAxisAngle(O,Math.round((b.x-T.x)/i.rotationSnap)*i.rotationSnap),A.setFromAxisAngle(M,Math.round((b.y-T.y)/i.rotationSnap)*i.rotationSnap),I.setFromAxisAngle(D,Math.round((b.z-T.z)/i.rotationSnap)*i.rotationSnap)):(E.setFromAxisAngle(O,b.x-T.x),A.setFromAxisAngle(M,b.y-T.y),I.setFromAxisAngle(D,b.z-T.z)),S.setFromRotationMatrix(U),"X"===i.axis&&(C.multiplyQuaternions(C,E),s=i._gizmo[n].pickerGizmos.X[0][0].getObjectByName("ArcSurface"),(l=new a.Quaternion).setFromAxisAngle(D,b.x),s.quaternion.copy(l)),"Y"===i.axis&&(C.multiplyQuaternions(C,A),s=i._gizmo[n].pickerGizmos.Y[0][0].getObjectByName("ArcSurface"),(l=new a.Quaternion).setFromAxisAngle(D,b.y),s.quaternion.copy(l)),"Z"===i.axis&&(C.multiplyQuaternions(C,I),s=i._gizmo[n].pickerGizmos.Z[0][0].getObjectByName("ArcSurface"),(l=new a.Quaternion).setFromAxisAngle(D,b.z),s.quaternion.copy(l)),i.MOVELOCK[i.axis].state)return;C.multiplyQuaternions(C,S),i.object.quaternion.copy(C)}}i.update(),i.dispatchEvent(c),i.dispatchEvent(d)}}}function q(t){if(t.preventDefault(),void 0===t.button||0===t.button){if(o&&null!==i.axis){h.mode=n,i.dispatchEvent(h);var e=i.getMode(),a=i.axis,r=i._gizmo[e].pickerGizmos;if("rotate"===e){for(var s in r){r[s][0][0].children[0].visible=!0}r[a][0][0].getObjectByName("Torus").visible=!1,r[a][0][0].getObjectByName("ArcSurface").visible=!1}if("translate"===e)for(var l in r){var u=r[l][0][0];i.axis!==l&&(u.visible=!0)}}o=!1,"TouchEvent"in window&&t instanceof TouchEvent?(i.axis=null,i.update(),i.dispatchEvent(c)):W(t)}}function Y(i,n,o){var a=e.getBoundingClientRect(),r=(i.clientX-a.left)/a.width,s=(i.clientY-a.top)/a.height;v.set(2*r-1,-2*s+1),f.setFromCamera(v,t);var l=f.intersectObjects(n,!0);return!!l[0]&&l[0]}e.style.pointerEvents="auto",e.addEventListener("mousedown",F,!1),e.addEventListener("mousemove",W,!1),e.addEventListener("mousemove",G,!1),e.addEventListener("mouseup",q,!1),e.addEventListener("mouseout",q,!1),this.dispose=function(){e.style.pointerEvents="none",e.removeEventListener("mousedown",F),e.removeEventListener("mousemove",W),e.removeEventListener("mousemove",G),e.removeEventListener("mouseup",q),e.removeEventListener("mouseout",q)},this.attach=function(t){this.object=t,this.visible=!0,this.update()},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.getMode=function(){return n},this.setMode=function(t){for(var e in"scale"===(n=t||n)&&(i.space="local"),r)r[e].visible=e===n;this.update(),i.dispatchEvent(c)},this.setTranslationSnap=function(t){i.translationSnap=t},this.setRotationSnap=function(t){i.rotationSnap=t},this.setSize=function(t){i.size=t,this.update(),i.dispatchEvent(c)},this.setSpace=function(t){i.space=t,this.update(),i.dispatchEvent(c)},this.update=function(){void 0!==i.object&&(i.object.updateMatrixWorld(),R.setFromMatrixPosition(i.object.matrixWorld),V.setFromRotationMatrix(x.extractRotation(i.object.matrixWorld)),t.updateMatrixWorld(),j.setFromMatrixPosition(t.matrixWorld),N.setFromRotationMatrix(x.extractRotation(t.matrixWorld)),w=R.distanceTo(j)/6*i.size,this.position.copy(R),this.scale.set(w,w,w),t instanceof a.PerspectiveCamera?_.copy(j).sub(R).normalize():t instanceof a.OrthographicCamera&&_.copy(j).normalize(),"local"===i.space?r[n].update(V,_):"world"===i.space&&r[n].update(new a.Euler,_),r[n].highlight(i.axis))}}return a.TransformGizmoDIY=function(){this.init=function(){a.Object3D.call(this),this.handles=new a.Object3D,this.pickers=new a.Object3D,this.planes=new a.Object3D,this.add(this.handles),this.add(this.pickers),this.add(this.planes);var t=new a.PlaneBufferGeometry(50,50,2,2),e=new a.MeshBasicMaterial({visible:!1,side:a.DoubleSide}),i={XY:new a.Mesh(t,e),YZ:new a.Mesh(t,e),XZ:new a.Mesh(t,e)};for(var n in i.YZ.rotation.set(0,Math.PI/2,0),i.XZ.rotation.set(-Math.PI/2,0,0),i)i[n].name=n,this.planes.add(i[n]),this.planes[n]=i[n];var o=function(t,e){for(var i in t)for(n=t[i].length;n--;){var o=t[i][n][0],a=t[i][n][1],r=t[i][n][2];o.traverse((function(t){t.userData.axis=i})),a&&o.position.set(a[0],a[1],a[2]),r&&o.rotation.set(r[0],r[1],r[2]),e.add(o)}};o(this.handleGizmos,this.handles),o(this.pickerGizmos,this.pickers),this.traverse((function(t){if(t instanceof a.Mesh){t.updateMatrix();var e=t.geometry.clone();e.applyMatrix4(t.matrix),t.geometry=e,t.position.set(0,0,0),t.rotation.set(0,0,0),t.scale.set(1,1,1)}}))},this.highlight=function(t){this.traverse((function(e){e.material&&e.material.highlight&&(e.name===t?e.material.highlight(!0):e.material.highlight(!1))}))}},a.TransformGizmoDIY.prototype=Object.create(a.Object3D.prototype),a.TransformGizmoDIY.prototype.constructor=a.TransformGizmoDIY,a.TransformGizmoDIY.prototype.update=function(t,e){},a.TransformGizmoTranslate=function(){a.TransformGizmoDIY.call(this);var n=new a.BufferGeometry;n.setAttribute("position",new a.Float32BufferAttribute([0,0,0,.3,0,0],3));var o=new a.Line(n,new e({color:16711680}));o.userData.isLine=!0;var r=new a.BufferGeometry;r.setAttribute("position",new a.Float32BufferAttribute([0,0,0,0,.3,0],3));var s=new a.Line(r,new e({color:65280}));s.userData.isLine=!0;var l=new a.BufferGeometry;l.setAttribute("position",new a.Float32BufferAttribute([0,0,0,0,0,.3],3));var c=new a.Line(l,new e({color:255}));o.userData.isLine=!0,this.handleGizmos={X:[[o]],Y:[[s]],Z:[[c]]};var u=new a.Mesh(new i,new t({visible:!0,transparent:!0,color:65280}));u.scale.set(.01,.01,.01),u.userData.isPicker=!0;var h=new a.Mesh(new i,new t({visible:!0,transparent:!0,color:16711680}));h.scale.set(.01,.01,.01),h.userData.isPicker=!0;var d=new a.Mesh(new i,new t({visible:!0,transparent:!0,color:16776960}));d.scale.set(.01,.01,.01),d.userData.isPicker=!0,this.pickerGizmos={X:[[u,[1.2,0,0],[Math.PI/2,0,0]]],Y:[[h,[0,1.2,0],[0,0,Math.PI/2]]],Z:[[d,[0,0,1.2],[Math.PI/2,0,Math.PI/2]]]},this.setActivePlane=function(t,e){var i=new a.Matrix4;e.applyMatrix4(i.getInverse(i.extractRotation(this.planes.XY.matrixWorld))),"X"===t&&(this.activePlane=this.planes.XY,Math.abs(e.y)>Math.abs(e.z)&&(this.activePlane=this.planes.XZ)),"Y"===t&&(this.activePlane=this.planes.XY,Math.abs(e.x)>Math.abs(e.z)&&(this.activePlane=this.planes.YZ)),"Z"===t&&(this.activePlane=this.planes.XZ,Math.abs(e.x)>Math.abs(e.y)&&(this.activePlane=this.planes.YZ)),"XYZ"===t&&(this.activePlane=this.planes.XYZE),"XY"===t&&(this.activePlane=this.planes.XY),"YZ"===t&&(this.activePlane=this.planes.YZ),"XZ"===t&&(this.activePlane=this.planes.XZ)};var p=new a.Vector3(1,0,0),g=new a.Vector3(0,1,0),f=new a.Vector3(0,0,1),v=new a.Quaternion,y=new a.Quaternion,m=new a.Vector3(0,1,0);this.update=function(t,e){var i;a.TransformGizmoDIY.prototype.update.apply(this,arguments),this.traverse((function(t){if("X"===t.name&&((i=m.copy(p).applyQuaternion(v).dot(e))<0&&(t.scale.x=-1),i>0&&(t.scale.x=1)),"Y"===t.name){var n=new a.Quaternion,o=new a.Quaternion;n.setFromAxisAngle(g,Math.atan2(e.x,e.z)),o.multiplyQuaternions(o,n),t.quaternion.copy(o)}"Z"===t.name&&((i=m.copy(f).applyQuaternion(y).dot(e))<0&&(t.scale.z=-1),i>0&&(t.scale.z=1))}))},this.init()},a.TransformGizmoTranslate.prototype=Object.create(a.TransformGizmoDIY.prototype),a.TransformGizmoTranslate.prototype.constructor=a.TransformGizmoTranslate,a.TransformGizmoRotate=function(){a.TransformGizmoDIY.call(this);var t=new a.BufferGeometry;t.setAttribute("position",new a.Float32BufferAttribute([0,0,0,.3,0,0],3));var i=new a.Line(t,new e({color:16711680}));i.userData.isLine=!0;var n=new a.BufferGeometry;n.setAttribute("position",new a.Float32BufferAttribute([0,0,0,0,.3,0],3));var o=new a.Line(n,new e({color:65280}));o.userData.isLine=!0;var r=new a.BufferGeometry;r.setAttribute("position",new a.Float32BufferAttribute([0,0,0,0,0,.3],3));var l=new a.Line(r,new e({color:255}));l.userData.isLine=!0,this.handleGizmos={X:[[i]],Y:[[o]],Z:[[l]]};var c=new s({color:8446604,name:"X"}),u=new s({color:15897485,name:"Y"}),h=new s({color:16701062,name:"Z"});this.pickerGizmos={X:[[c,[0,0,0],[0,Math.PI/2,-3*Math.PI/4]]],Y:[[u,[0,0,0],[0,0,0]]],Z:[[h,[0,0,0],[0,0,3*Math.PI/4]]]},this.setActivePlane=function(t){"X"===t&&(this.activePlane=this.planes.YZ),"Y"===t&&(this.activePlane=this.planes.XZ),"Z"===t&&(this.activePlane=this.planes.XY)},this.update=function(t,e){a.TransformGizmoDIY.prototype.update.apply(this,arguments);this.handles,this.pickers,new a.Matrix4,new a.Euler(0,0,1);var i=new a.Vector3(1,0,0),n=new a.Vector3(0,1,0),o=new a.Vector3(0,0,1),r=new a.Quaternion,s=(new a.Quaternion,new a.Quaternion),l=e.clone(),c=new a.Vector3(0,1,0),u=c.copy(i).applyQuaternion(r).dot(l),h=c.copy(o).applyQuaternion(s).dot(l);u<0&&1===this.handleGizmos.X[0][0].scale.x&&(this.handleGizmos.X[0][0].scale.x=-1,this.pickerGizmos.Z[0][0].rotateZ(Math.PI/2)),u>0&&-1===this.handleGizmos.X[0][0].scale.x&&(this.handleGizmos.X[0][0].scale.x=1,this.pickerGizmos.Z[0][0].rotateZ(-Math.PI/2)),h<0&&1===this.handleGizmos.Z[0][0].scale.z&&(this.handleGizmos.Z[0][0].scale.z=-1,this.pickerGizmos.X[0][0].rotateZ(-Math.PI/2)),h>0&&-1===this.handleGizmos.Z[0][0].scale.z&&(this.handleGizmos.Z[0][0].scale.z=1,this.pickerGizmos.X[0][0].rotateZ(Math.PI/2));var d=new a.Quaternion,p=new a.Quaternion;d.setFromAxisAngle(n,Math.atan2(l.x,l.z)),p.multiplyQuaternions(p,d),this.pickerGizmos.Y[0][0].quaternion.copy(p),this.pickerGizmos.Y[0][0].rotateX(-Math.PI/2)},this.init()},a.TransformGizmoRotate.prototype=Object.create(a.TransformGizmoDIY.prototype),a.TransformGizmoRotate.prototype.constructor=a.TransformGizmoRotate,l.prototype=Object.create(a.Object3D.prototype),l.prototype.constructor=l,l}();function te(t){var e=w.getCamera(),i=document.getElementById("renderer-canvas");$t.call(this,e,i),this.name="TransformControl-"+t,this.userData.uuid=t,this.isHovered=!1,this.bindEvents()}te.prototype=Object.create($t.prototype),te.prototype.bindEvents=function(){this.addEventListener("objectChange",this.onChange),this.addEventListener("mouseUp",this.onMouseUp),this.addEventListener("mouseDown",this.onMouseDown),this.addEventListener("hover.in",this.onHoverIn),this.addEventListener("hover.out",this.onHoverOut)},te.prototype.removeEvents=function(){this.removeEventListener("objectChange",this.onChange),this.removeEventListener("mouseUp",this.onMouseUp),this.removeEventListener("mouseDown",this.onMouseDown),this.removeEventListener("hover.in",this.onHoverIn),this.removeEventListener("hover.out",this.onHoverOut)},te.prototype.onMouseDown=function(t){n.get("ext").onTransformControlPointerDown(this.object.uuid)},te.prototype.onMouseUp=function(t){var e=n.get("event");!0===n.get("status")[e.TransformControlDragMoving].state&&n.get("ext").onTransformControlDragMovingEnd(this.object.uuid),n.get("ext").onTransformControlPointerUp(this.object.uuid)},te.prototype.onChange=function(t){n.get("ext").onTransformControlDragMoving(this.object.uuid)},te.prototype.onHoverIn=function(t){!0!==this.isHovered&&(this.isHovered=!0,e.debug(this.name+" hover in",t)(),n.get("ext").onTransformControlHoverIn(this.object.uuid))},te.prototype.onHoverOut=function(t){!1!==this.isHovered&&(this.isHovered=!1,n.get("ext").onTransformControlHoverOut(this.object.uuid))},te.prototype.destroy=function(){this.removeEvents(),this.dispose()};var ee=te;function ie(t){a.Mesh.call(this),this.name="visual.range.container",this.geometry=new a.SphereGeometry(t,16,16),this.material=new a.MeshBasicMaterial({transparent:!0,depthWrite:!1,side:a.DoubleSide,color:65280,opacity:.2})}ie.prototype=Object.create(a.Mesh.prototype),ie.prototype.setPosition=function(t){this.position.set(t.x,t.y,t.z)},ie.prototype.setRadius=function(t){this.geometry=new a.SphereGeometry(t,16,16)};var ne=ie,oe=Y.isNum,ae=Y.isStr,re=Y.isRGBA,se=new a.Vector3(0,1,0),le=null;function ce(t,i){void 0===i&&(i=function(){});if(!0!==g[T.DisableAdd].state){if(t.isSaved);else if(!0===g[T.Add].state&&!1===g[T.TagPutDown].state)return void e.warn("add tag failure, reason: have new tag unput down!")();var n=null,o=w.getActiveModelType();"model"===o&&(n=new zt(t)),"purepano"===o&&(n=new Jt(t)),n.init(),le.onTagAdd(n,(function(t){i(t)}))}else e.warn("add tag failure, reason: disable add!")()}function ue(t,i){var n=le.tagsMap.get(t)||le.tagsGroup.getObjectByName("tag-"+t);return n||(e.error("get tag failure, invalid uuid<"+t+">; cmd: "+i)(),null)}function he(){var t=[];return le.tagsMap.forEach((function(e){var i=e.getOutputSettingItem();t.push(i)})),t}function de(t){ue(t,"show.tag").show("show.tag")}function pe(t){var e=ue(t,"hide.tag");e&&e.hide()}function ge(t,e){le.visualRangeSphere.set(t,e),le.visualRangeHelper&&(le.visualRangeHelper.setRadius(e),le.visualRangeHelper.setPosition(t))}function fe(t){var e=ue(t,"check has title");if(e)return!!e.label}function ve(t){if(!le.tagsMap.get(t))return!1}var ye={init:function(t){le=t},disableAdd:function(){g[T.DisableAdd].state=!0},enableAdd:function(){g[T.DisableAdd].state=!1},addTag:ce,removeTag:function(t){var e=ue(t,"remove.tag");e&&e.delete()},loadTag:function(t){var i=t.data,n=t.success||function(){},o=i.length;e.time("load.tag")();var a=function(t){if(!0!==g[T.StopLoading].state){if(t===o)return e.timeEnd("load.tag")(),n(),void le.onTagsLoaded();if(t<o){var r=i[t];r.isSaved=!0,ce(r,(function(e){a(t+1)}))}}else e.error("tag<"+t+"> stop loading")()};a(0)},unSetVisualRange:function(){le.visualRange=null,le.onVisualRangeChanged(null)},updateVisualRangeSphere:ge,showVisualRangeHelper:function(){le.visualRangeHelper=new ne(le.visualRange),le.visualRangeHelper.setPosition(le.visualRangeSphere.center),w.sceneAdd(le.visualRangeHelper)},hideVisualRangeHelper:function(){w.sceneRemove(le.visualRangeHelper),le.visualRangeHelper=null},cancelChoosed:function(){le.choosedTag&&le.choosedTag.unChoosed()},cancelPut:function(){le.newTag&&le.newTag.cancelAdd()},cancelChooseTag:function(t){var e=ue(t,"cancel choose tag");e&&e.unChoosed()},getTagData:function(t){var e=ue(t,"getTagData");return e?e.getOutputSettingItem():null},getTagsData:he,getTag:ue,getOtherTags:function(t){var i=le.tagsMap,n=[];return i.forEach((function(t){n.push(t)})),!1===ve(t)?(e.error("get other tags failure, reason: invald uuid")(),[]):n.filter((function(e){return e.uuid!==t}))},getChoosedTag:function(){return le.choosedTag},getTopPositionOfScreen:function(t){var i=ue(t,"get.top.position.of.screen");if(i){var n=i.head.getTopCenterOfScreen(),o=n.x,a=n.y;return i.label&&i.label.isVisible()&&(a-=i.label.clientHeight+i.label.top_space),{left:o,top:a}}e.error("get top position of screen failure, reason: invalid tag")()},getOtherNotOutScreenViewTags:function(t){var i=[];if(!1===ve(t))return e.error("get other not out screen view tags failure, reason: invald uuid")(),i;var n=g[T.HeadNotOutCameraView].historyData;return Object.keys(n).forEach((function(e){t!==e&&i.push(ue(e,"get.other.not.out.screen.view tags"))})),i},showTag:de,hideTag:pe,chooseTag:function(t){var e=ue(t,"choose tag");e&&e.choosed()},setVisualRange:function(t){le.visualRange=t,ge(w.getCameraPosition(),t),le.onVisualRangeChanged(t)},setTagScale:function(t){var e=t.uuid,i=t.scale,n=ue(e,"set.tag.scale");n&&n.head.setUserData("origin_scale_rate",i)},setAllTagsScale:function(t){le.tagsMap.forEach((function(e){e.head.setUserData("current_scale_rate",t)}))},setLocationLineLen:function(t){var e=t.uuid,i=t.value,n=ue(e,"set location line length");n&&n.locationLine.setLength(i)},setLocationLineWidth:function(t){var i="set location line width failure",n=t.tag_id,o=t.width,a=ue(n,"set.location.line.width");a?!1!==oe(o,i+", reason: location line width")&&a.locationLine&&a.locationLine.setWidth(o):e.error(i+", reason: invalid tag_id")()},setLocationLineColor:function(t){var e=t.tag_id,i=t.color,n=ue(e,"set.location.line.color");n&&n.locationLine.setColor(i)},showTagLocationLine:function(t){var e="show tag location line",i=ue(t,e);i&&i.showLocationLine(e)},hideTagLocationLine:function(t){var e="hide tag location line",i=ue(t,e);i&&i.hideLocationLine(e)},setPlaneTexture:function(t){var e=t.uuid,i=ue(e,"set.plane.texture");i&&i.plane.updateTexture({uuid:e,type:t.type,src:t.src,width:t.width,height:t.height,tile_count:t.tile_count,tile_duration:t.tile_duration,tile_vertical:t.tile_vertical,tile_horizontal:t.tile_horizontal,tile_order:t.tile_order||1})},hasTitle:fe,addTitle:function(t){var i=ue(t.uuid,"add.title");i&&(i.label?e.error("add title failure, reason: tag<"+i.uuid+"> already has title!")():i.addTitle(t))},showTitle:function(t){var i=ue(t,"show.title");i?i.label.show("show.title"):e.error("show title failure, reason: invalid tag")()},hideTitle:function(t){var i=ue(t,"hide.title");i?i.label.hide():e.error("hide title failure, reason: invalid tag")()},titleIsVisible:function(t){var e=ue(t,"title is visible");if(e&&e.label)return e.label?e.label.isVisible():void 0},hideHead:function(t){var i=ue(t,"hide.face");i?i.head.hide("hide.face"):e.error("hide face failure, reason: invalid uuid")()},showHead:function(t){var i=ue(t,"show.face");i?i.head.show("show.face"):e.error("show face failure, reason: invalid uuid")()},updateTitleText:function(t){var i=t.uuid,n=t.text,o=ue(i,"update.title.text");o?fe(i)?o.label.updateText(n):e.error("update title text failure, reason: has not title")():e.error("update title text failure, reason: invalid tag")()},updateTitleFontSize:function(t){var i=t.uuid,n=t.size,o=ue(i,"update.title.fontsize");o?fe(i)?o.label.updateFontSize(n):e.error("update title font size failure, reason: has not title")():e.error("update title font size failure, reason: invalid tag")()},updateTitleFontColor:function(t){var i="update title font color failure",n=t.uuid,o=t.color,a=ue(n,"update.title.font.color");a?ae(o,i+", reason: color")&&(fe(n)?a.label.updateFontColor(o):e.error(i+", reason: invalid title")()):e.error(i+", reason: invalid tag")()},updateTitleBgColor:function(t){var i="update title bg color failure",n=t.uuid,o=t.color,a=ue(n,"update.title.bgcolor");a?re(o,i+", reason: bg color")&&(fe(n)?a.label.updateBgColor(o):e.error(i+", reason: has not title")()):e.error(i+", reason: invalid tag")()},bundleTagId:function(t){var i=t.uuid,n=t.id,o=ue(i,"bundle.tag.id");o?o.getUserData("setting_item").id=n:e.error("bundleTagId failure, reason: invalid tag")()},checkHeadIsOutCamera:function(t){var e=ue(t,"check tag head is out of screen");if(e)return e.head.getUserData("out_camera_view")},checkHeadIsBarrierByModel:function(t){var e=ue(t,"check tag head is barrier by model");if(e)return e.head.getUserData("barrier_within_model")},checkHeadIsOutOfVisualRange:function(t){var e=ue(t,"check tag head is out visual range");if(e)return e.head.getUserData("out_visual_range")},enableSyncTitlePosition:function(){g[T.EnableSyncTitlePosition].state=!0},disableSyncTitlePosition:function(){g[T.DisableSyncTitlePosition].state=!0},setTagPosition:function(t){var e=t.uuid,i=t.position,n=ue(e,"set.tag.position");n&&n.setPosition(i)},setTagQuaternion:function(t){var e=t.uuid,i=t.quaternion,n=ue(e,"set.tag.quaternion");n&&n.setQuaternion(i)},setHeadBgColor:function(t){var e=t.uuid,i=t.color,n=ue(e,"set.tag.face.color");n&&n.head.setColor(1*("0x"+i))},setHeadBgOpacity:function(t){var e=t.uuid,i=t.opacity,n=ue(e,"set.tag.face.opacity");n&&n.head.setOpacity(i,!0)},computeHeadIsOutCamera:function(t){var e=ue(t,"compute.is.out.camera");return e?e.head.computeIsOutCameraView2():null},computeHeadIsOutVisualRange:function(t){var e=ue(t,"compute.is.out.visual.range");return e?e.head.computeIsOutVisualRangle2():null},computeHeadIsBarrierWithinModel:function(t){var e=ue(t,"compute.barrier.within.model");return e?e.head.computeBarrierWithinModel():null},hideTagsOfFloor:function(t){var e=he(),i=[];e.forEach((function(e){-1!==e.floor.indexOf(t)&&i.push(e.uuid)})),i.forEach((function(t){pe(t)}))},showTagsOfFloor:function(t){var e=he(),i=[];e.forEach((function(e){-1!==e.floor.indexOf(t)&&i.push(e.uuid)})),i.forEach((function(t){de(t)}))},bindTransformControl:function(t,e,i){void 0===e&&(e="translate"),void 0===i&&(i=.5);var n=ue(t,"bind.transform.control");if(n){var o=new ee(t);o.setMode(e),o.setSize(i),o.attach(n),le.onTagAddedTransformControl(t,o)}},unbindTransformControl:function(t){ue(t,"unbind.transform.control")&&le.onTagRemoveTarnsformControl(t)},alignAxisY:function(t){var e=ue(t,"align.axis.Y");if(e){var i=e.position.clone(),n=e.quaternion.clone();e.align_before_position=(new a.Vector3).copy(i),e.align_before_quaternion=(new a.Quaternion).copy(n),e.lookAtNormal(se,i)}},setTitleOpacity:function(t,e){var i=ue(t,"set.tag.title.opacity");i&&i.label&&i.label.setOpacity(e)},getVisualRangeTags:function(){var t=he(),e=[];return t.forEach((function(t){ue(t.uuid).head.computeIsOutVisualRangle()||e.push(t.uuid)})),e},getHeadCenter:function(t){var e=ue(t,"get.tag.head.center");if(e){var i=e.head._getWorldPosition();return{x:i.x,y:i.y,z:i.z}}},getHeadScreenCenter:function(t){var e=ue(t,"get.tag.head.screen.center");if(e)return e.head.getCenterOfScreen()},getHeadScreenTop:function(t){var e=ue(t,"get.tag.head.screen.top");if(e)return e.head.getTopCenterOfScreen()},getHeadScreenPosition:function(t){var e=ue(t,"get.tag.head.screen.edge.center");if(e){var i=e.head.getScreenPosition();return{center:{x:i.center.x,y:i.center.y},top:{x:i.top.x,y:i.top.y},right:{x:i.right.x,y:i.right.y},bottom:{x:i.bottom.x,y:i.bottom.y},left:{x:i.left.x,y:i.left.y}}}},getLocationLineDirection:function(t){var e=ue(t,"get.tag.location.line.direction");if(e){var i=e.locationLine.getWorldDirection(new a.Vector3);return{x:i.x,y:i.y,z:i.z}}},setTransformControlMode:function(t,i){if(ue(t,"set.tag.transform.control.mode")){var n=le.transformControls.get(t);n?n.setMode(i):e.error("set transform control mode failure, reason: tag <"+t+"> unbind transform control!")()}},fadeInAll:function(t){!oe(t)&&(t=1e3),le.tagsMap.forEach((function(e){e.visible&&e.createAnimate&&e.createAnimate(1,t)}))},fadeOutAll:function(t){!oe(t)&&(t=1e3),le.tagsMap.forEach((function(e){e.visible&&e.createAnimate&&e.createAnimate(0,t)}))},setTitleOffset:function(t){var e=ue(t.uuid,"tag: set title offset failure, reason:");if(e){var i=e.head,n=e.label;n.offset.top=t.top||0,n.offset.right=t.right||0,n.offset.bottom=t.bottom||0,n.offset.left=t.left||0;var o=i.getTopCenterOfScreen();n.updatePosition(o,!0,"set.title.offset")}},setControlPlateScale:function(t){var e=t.uuid,i=(t.scale,ue(e,"tag: set control plate scale failure, reason:"));if(i)i.basePlate}},me=Y.isNum,be=Y.isBool,Te=Y.isArr,we=Y.isVec2,_e=Y.isVec3,xe=Y.isVec4,Pe=Y.isStr,Ce=Y.isObj,Oe=Y.isRGBA,Me=Y.isFunc,De=["jpg","png","gif","sprite"],Se=function(t,i){var n="tags-manager load tag failure, index: "+i;if(!Ce(t,n+", reason: tag data"))return!1;if(t.id&&!Pe(t.id)&&!me(t.id))return e.error(n+", reason: invalid tag id")(),!1;if(t.location_id){if(!Pe(t.location_id,n+", reason: tag.location_id"))return!1}else e.warn("load tag: index:"+i+", reason: invalid location_id")();if(!_e(t.position,n+", reason: tag.position"))return!1;if(!t.rotation&&!t.normal)return e.error(n+", reason: invalid rotation|normal")(),!1;if(t.rotation&&t.normal)return e.error(n+", reason: rotation|normal only has one!")(),!1;if(t.rotation&&!xe(t.rotation,n+", reason: rotation"))return e.error(n+", reason: invalid rotation")(),!1;if(t.normal&&!_e(t.normal,n+", reason: normal"))return e.error(n+", reason: invalid normal")(),!1;if(!be(t.visible,n+", reason: tag.visible"))return!1;if(!Ce(t.face,n+", reason: tag.face"))return!1;if(!be(t.face.visible,n+", reason: tag.face.visible"))return!1;if(!me(t.face.scale,n+", reason: tag.face.scale"))return!1;if(!me(t.face.width,n+", reason: tag.face.width"))return!1;if(!me(t.face.height,n+", reason: tag.face.height"))return!1;if(!Pe(t.face.type,n+", reason: tag.face.type"))return!1;if(-1===De.indexOf(t.face.type))return e.error(n+", reason: invalid type<"+t.face.type+">")(),!1;if(!Pe(t.face.src,n+", reason: tag.face.src"))return!1;if(void 0!==t.face.bg_color&&!Pe(t.face.bg_color,n+", reason: tag.face.bg_color"))return!1;if(void 0!==t.face.bg_opacity&&!me(t.face.bg_opacity,n+", reason: tag.face.bg_opacity"))return!1;if(!Ce(t.location_line,n+", reason: tag.location_line"))return!1;if(!me(t.location_line.length,n+", reason: tag.location_line.length"))return!1;if(!me(t.location_line.width,n+", reason: tag.location_line.width"))return!1;if(!be(t.location_line.visible,n+", reason: tag.location_line.visible"))return!1;if(!Pe(t.location_line.color,n+", reason: tag.location_line.color"))return!1;if(t.title&&!Ce(t.title,n+", reason: tag.title"))return!1;if(t.title){if(!t.title.text)return e.error(n+", reason: invalid title.text")(),!1;if(!Pe(t.title.text,n+", reason: tag.title.text"))return!1;if(!me(t.title.font_size,n+", reason: tag.title.font_size"))return!1;if(!Pe(t.title.font_color,n+", reason: tag.title.font_color"))return!1;if(!Oe(t.title.bg_color,n+", reason: tag.title.bg_color"))return!1;if(!be(t.title.visible,n+", reason: tag.title.visible"))return!1}return!0},Ee=function(t){var i="tags-manager add failed";return t&&Ce(t,"add tag params")?t.width&&me(t.width,"tag width")?t.height&&me(t.height,"tag height")?t.type?-1===De.indexOf(t.type)?(e.error(i+", reason: invalid type")(),!1):t.src&&Pe(t.src,"tag src")?!(void 0!==t.location_line_len&&!me(t.location_line_len,"tag location_line_len"))&&(void 0===t.location_line_len&&(t.location_line_len=.6),!(void 0!==t.location_line_visible&&!be(t.location_line_visible,i+", reason: invalid location_line_visible"))&&(void 0===t.location_line_visible&&(t.location_line_visible=!0),!!me(t.face_scale,i+", reason: invalid face_scale")&&(!(t.position&&!we(t.position,i+", reason: invalid position"))&&(!(t.head_bg_color&&!Pe(t.head_bg_color,i+", reason: invalid head_bg_color"))&&!(t.head_bg_opacity&&!me(t.head_bg_opacity,i+", reason: invalid head_bg_opacity")))))):(e.error(i+", reason: invalid src")(),!1):(e.error(i+", reason: invalid type")(),!1):(e.error(i+", reason: invalid height")(),!1):(e.error(i+", reason: invalid width")(),!1):(e.error(i+", reason: invalid params")(),!1)},Ae=function(t){var i="tags-manager load tag failure";if(!t)return e.error(i+", reason: invalid params")(),!1;if(!Te(t.data,i+", reson: params.data"))return!1;for(var n=0,o=t.data.length;n<o;++n){var a=t.data[n];if(!Se(a,n))return!1}return!!Me(t.success,i+", reason: params.success")&&!!Me(t.failed,i+", reason: params.failed")},Ie=function(t){return!(!Pe(t)&&!me(t))||(e.error("getTagData failure, reason: invalid tag_id")(),!1)},Le=function(t){return!!Pe(t,"tag hide head failure, reason: uuid ")},He=function(t){return!!Pe(t,"tag show head failure, reason: uuid ")},Be=function(t){var e="tag add title failure";return!!Pe(t.uuid,e+", reason: tag title.uuid ")&&(!!Pe(t.text,e+", reason: tag title.text ")&&(!!me(t.font_size,e+", reason: tag title.font_size ")&&(!!Pe(t.font_color,e+", reason: tag title.font_color ")&&(!!Oe(t.bg_color,e+", reason: tag title.bg_color ")&&!!be(t.visible,e+", reason: tag title.visible")))))},ke=function(t){var e="tag: set location line color failure";return!!Ce(t,e+", reason: params")&&(!!Pe(t.tag_id,e+", reason: tag_id")&&!!Pe(t.color,e+", reason: location line color"))},ze=function(t){var e="tag: set location line length failure";return!!Ce(t,e+", reason: params")&&(!!Pe(t.uuid,e+", reason: uuid")&&!!me(t.value,e+", reason: value"))},Re=function(t){var e="tag: set location line width failure";return!!Ce(t,e+", reason: params")&&(!!Pe(t.tag_id,e+", reason: tag_id")&&!!me(t.width,e+", reason: width"))},Ve=function(t){return!!Pe(t,"choose tag failure, reason: uuid")},Ue=function(t){return!!Pe(t,"unchoose tag failure, reason: uuid")},je=function(t){var i="set tag scale failure";return!1!==Ce(t,i+", reason: params")&&(t.uuid?!1!==Pe(t.uuid,i+", reason: params.uuid")&&(t.scale?!1!==me(t.scale,i+", reason: params:scale")&&(!t.success||!1!==Me(t.success,i+", reason: params.success")):(e.error(i+", invalid params.scale")(),!1)):(e.error(i+", invalid params.uuid")(),!1))},Ne=function(t){return!!me(t,"set all tag scale failure, reason: scale")},We=function(t){var i="set tag position failure";return!!Ce(t,i+", reason: params")&&(!!Pe(t.uuid,i+", reason: uuid")&&(!!_e(t.position,i+", reason: position")&&(!!t.uuid||(e.error(i+", reason: invalid uuid")(),!1))))},Fe=function(t){var i="set tag quaternion failure";return!!Ce(t,i+", reason: params")&&(!!Pe(t.uuid,i+", reason: uuid")&&(!!xe(t.quaternion,i+", reason: quaternion")&&(!!t.uuid||(e.error(i+", reason: invalid uuid")(),!1))))},Ge=function(t){var e="set tag face bg color failure";return!!Ce(t,e+", reason: params")&&(!!Pe(t.uuid,e+", reason: uuid")&&!!Pe(t.color,e+", reason: color"))},qe=function(t){var e="set tag face bg opacity failure";return!!Ce(t,e+", reason: params")&&(!!Pe(t.uuid,e+", reason: uuid")&&!!me(t.opacity,e+", reason: opacity"))},Ye=function(t){return!!Ce(t,"bundleTagId failure, reason: params")},Qe=function(t){t.add=function(t){Ee(t)&&ye.addTag(t)},t.unput=function(){ye.cancelPut()},t.load=function(t){Ae(t)?ye.loadTag(t):t.failed()},t.del=function(t){ye.removeTag(t)},t.choose=function(t){Ve(t)&&ye.chooseTag(t)},t.unchoose=function(t){Ue(t)&&ye.cancelChooseTag(t)},t.show=function(t){ye.showTag(t)},t.hide=function(t){ye.hideTag(t)},t.setVisualRange=function(t){ye.setVisualRange(t)},t.unsetVisualRange=function(){ye.unSetVisualRange()},t.getData=function(t){if(Ie(t))return ye.getTagData(t)},t.getAllData=function(){return ye.getTagsData()},t.setLocationLineLen=function(t){ze(t)&&ye.setLocationLineLen(t)},t.setLocationLineWidth=function(t){Re(t)&&ye.setLocationLineWidth(t)},t.setLocationLineColor=function(t){ke(t)&&ye.setLocationLineColor(t)},t.hideLocationLine=function(t){ye.hideTagLocationLine(t)},t.showLocationLine=function(t){ye.showTagLocationLine(t)},t.setTagScale=function(t){!1!==je(t)&&ye.setTagScale(t)},t.setGlobalHeadScale=function(t){Ne(t)&&ye.setAllTagsScale(t)},t.addTitle=function(t){Be(t)&&ye.addTitle(t)},t.hasTitle=function(t){return ye.hasTitle(t)},t.showTitle=function(t){ye.showTitle(t)},t.hideTitle=function(t){ye.hideTitle(t)},t.setTitleOffset=function(t){ye.setTitleOffset(t)},t.setTitleOpacity=function(t,e){ye.setTitleOpacity(t,e)},t.updateTitleText=function(t){ye.updateTitleText(t)},t.updateTitleFontSize=function(t){ye.updateTitleFontSize(t)},t.updateTitleFontColor=function(t){ye.updateTitleFontColor(t)},t.updateTitleBgColor=function(t){ye.updateTitleBgColor(t)},t.getTopPositionOfScreen=function(t){return ye.getTopPositionOfScreen(t)},t.setFaceTexture=function(t){return ye.setPlaneTexture(t)},t.setHeadBgColor=function(t){Ge(t)&&ye.setHeadBgColor(t)},t.setHeadBgOpacity=function(t){qe(t)&&ye.setHeadBgOpacity(t)},t.hideHead=function(t){Le(t)&&ye.hideHead(t)},t.showHead=function(t){He(t)&&ye.showHead(t)},t.checkHeadIsOutCamera=function(t){return ye.checkHeadIsOutCamera(t)},t.checkHeadIsBarrierByModel=function(t){return ye.checkHeadIsBarrierByModel(t)},t.checkHeadIsOutOfVisualRange=function(t){return ye.checkHeadIsOutOfVisualRange(t)},t.setPosition=function(t){We(t)&&ye.setTagPosition(t)},t.setQuaternion=function(t){Fe(t)&&ye.setTagQuaternion(t)},t.computeHeadIsOutCamera=function(t){return ye.computeHeadIsOutCamera(t)},t.computeHeadIsOutVisualRange=function(t){return ye.computeHeadIsOutVisualRange(t)},t.computeHeadIsBarrierWithinModel=function(t){return ye.computeHeadIsBarrierWithinModel(t)},t.bindTransformControl=function(t,e){ye.bindTransformControl(t,e)},t.unbindTransformControl=function(t){ye.unbindTransformControl(t)},t.setTransformControlMode=function(t,e){ye.setTransformControlMode(t,e)},t.alignAxisY=function(t){ye.alignAxisY(t)},t.getVisualRangeTags=function(){return ye.getVisualRangeTags()},t.getHeadCenter=function(t){return ye.getHeadCenter(t)},t.getHeadScreenCenter=function(t){return ye.getHeadScreenCenter(t)},t.getHeadScreenTop=function(t){return ye.getHeadScreenTop(t)},t.getHeadScreenPosition=function(t){return ye.getHeadScreenPosition(t)},t.getLocationLineDirection=function(t){return ye.getLocationLineDirection(t)},t.fadeInAll=function(t){ye.fadeInAll(t)},t.fadeOutAll=function(t){ye.fadeOutAll(t)},t.hasTitle=function(t){return ye.hasTitle(t)},t.titleIsVisible=function(t){return ye.titleIsVisible(t)},t.bundleTagId=function(t){Ye(t)&&ye.bundleTagId(t)},t.setControlPlateScale=function(t){ye.setControlPlateScale(t)}},Ze=null;var Xe=function(){Ze=n.get("ext");var t,e=function(){var t=n.get("event");return{"new.put.down":{en:t.NewTagPutDown,cb:[]},"put.down":{en:t.TagPutDown,cb:[]},"head.hover":{en:t.PlaneHover,cb:[]},"head.hoverout":{en:t.PlaneHoverOut,cb:[]},"head.click":{en:t.PlaneClick,cb:[]},"title.hover":{en:t.TitleHover,cb:[]},"title.hoverout":{en:t.TitleHoverOut,cb:[]},"title.click":{en:t.TitleClick,cb:[]},"baseplate.hover":{en:t.BasePlateHover,cb:[]},"baseplate.hoverout":{en:t.BasePlateHoverOut,cb:[]},"blankarea.click":{en:t.BlankAreaClick,cb:[]},"follow.moving":{en:t.TagFollowMoving,cb:[]},"drag.moving":{en:t.TagDragMoving,cb:[]},"drag.moving.end":{en:t.TagDragMovingEnd,cb:[]},"transform.control.drag.moving":{en:t.TransformControlDragMoving,cb:[]},"transform.control.drag.moving.end":{en:t.TransformControlDragMovingEnd,cb:[]},"tags.loaded":{en:t.AllTagsLoaded,cb:[]},"visual.range.changed":{en:t.VisualRangeChanged,cb:[]}}}();t=e,Object.keys(t).forEach((function(e,i){var n=t[e];Ze[n.en]=function(i){t[e].cb.forEach((function(t){return t(i)}))}})),Ze.addEventListener=function(t,i){e[t].cb.push(i)},Ze.removeEventListener=function(t,i){var n=e[t].cb.indexOf(i);e[t].cb.splice(n,1)},Ze.getEventListener=function(){return e}},Ke=function(){var t=n.get("ext");o(t),Qe(t),Xe(t)},Je="pc",$e="mobile";function ti(){a.Group.call(this),this.name="tag-group"}ti.prototype=Object.create(a.Group.prototype),ti.prototype.addTag=function(t){this.add(t)},ti.prototype.removeTag=function(t){t.traverse((function(t){t.geometry&&t.geometry.dispose(),t.material&&(t.material.map&&t.material.map.dispose(),t.material.dispose())})),this.remove(t)},ti.prototype.destroy=function(){for(var t=this.children,e=t.length-1;e>=0;--e){t[e].delete()}};var ei=ti,ii=E,ni=new a.Vector3(0,0,1),oi=new ii,ai=new ii,ri={x:0,y:0},si=null;function li(){n.carray("ext",this),si=this,this.event=T,this.eventStatus=g,this.hoverBasePlate=null,this.hoverPlane=null,this.choosedTag=null,this.tagsMap=new Map,this.gifMap=Object.create(null),this.raycaster=new a.Raycaster,this.tagsGroup=new ei,this.hasTag=Ii,this.visualRange=1/0,this.visualRangeSphere=new a.Sphere(new a.Vector3(0,0,0),this.visualRange),this.visualRangeHelper=null,this.transformControls=new Map,this._methods=ye,this._middleware=w,Object.defineProperties(this,{onTagAdd:{get:function(){return ci}},onTagFollowMoving:{get:function(){return hi}},onTagCancelAdd:{get:function(){return gi}},onTagDragMoving:{get:function(){return di}},onTagDragMovingEnd:{get:function(){return pi}},onTagPutDown:{get:function(){return fi}},onTagChoosed:{get:function(){return vi}},onTagUnChoosed:{get:function(){return yi}},onTagDeleted:{get:function(){return mi}},onBasePlateHover:{get:function(){return bi}},onBasePlateHoverOut:{get:function(){return Ti}},onBasePlateClick:{get:function(){return wi}},onTagPlaneHover:{get:function(){return _i}},onTagPlaneHoverOut:{get:function(){return xi}},onTagTitleHover:{get:function(){return Ci}},onTagTitleHoverOut:{get:function(){return Oi}},onTagPlaneClick:{get:function(){return Pi}},onTagTitleClick:{get:function(){return Mi}},onBlankAreaClick:{get:function(){return Di}},onVisualRangeChanged:{get:function(){return zi}}}),function(t){var e=null,i=!0;Object.defineProperties(t,{newTag:{get:function(){return e},set:function(i){e=i,null===i&&(t.disablePicker=!1)}},disablePicker:{get:function(){return i},set:function(t){i=t}}})}(this)}function ci(t,i){if(!0!==g[T.StopLoading].state){var n=t.getOutputSettingItem();si.tagsGroup.addTag(t),n.isSaved?t.putDown():(si.newTag=t,g[T.Add].data=n,g[T.Add].state=!0),i(t.uuid)}else e.error("onTagAdd failure: reason: stop loading! uuid<"+t.uuid+">")()}function ui(t){var e=t.getOutputSettingItem();g[T.TagDragMovingStart].data=e,g[T.TagDragMovingStart].state=!0}function hi(t){var e=t.getOutputSettingItem();g[T.TagFollowMoving].data=e,g[T.TagFollowMoving].state=!0}function di(t){var e=t.getOutputSettingItem();g[T.TagDragMoving].data=e,g[T.TagDragMoving].state=!0}function pi(t){var e=t.getOutputSettingItem();g[T.TagDragMovingEnd].data=e,g[T.TagDragMovingEnd].state=!0}function gi(t){si.tagsGroup.removeTag(t),si.newTag=null;var e=t.getOutputSettingItem();g[T.TagCancelAdd].data=e,g[T.TagCancelAdd].state=!0}function fi(t,e){void 0===e&&(e=function(){});var i=t.getOutputSettingItem();si.newTag=null,si.tagsMap.set(t.uuid,t),g[T.TagPutDown].data=i,g[T.TagPutDown].state=!0,e()}function vi(t){si.choosedTag=t;var e=t.getOutputSettingItem();g[T.TagChoosed].data=e,g[T.TagChoosed].state=!0}function yi(t,e){si.choosedTag=null;var i=t.getOutputSettingItem();g[T.TagCancelChoose].data=i,g[T.TagCancelChoose].state=!0}function mi(t){var e=t.uuid;si.tagsGroup.removeTag(t),si.tagsMap.delete(e),t.destroy();var i=t.getOutputSettingItem();g[T.TagDeleted].data=i,g[T.TagDeleted].state=!0}function bi(t){var e=t.parent,i=e?e.getOutputSettingItem():null;g[T.BasePlateHover].state=!0,si.hoverBasePlate=t,si[T.BasePlateHover].forEach((function(t){t(i)}))}function Ti(t){g[T.BasePlateHoverOut].state=!0,si.hoverBasePlate=null,si[T.BasePlateHoverOut].forEach((function(t){t()}))}function wi(t){g[T.BasePlateClick].state=!0,si[T.BasePlateClick].forEach((function(t){t()}))}function _i(t){si.hoverPlane=t;var e=t.parent.getOutputSettingItem();g[T.PlaneHover].data=e,g[T.PlaneHover].state=!0}function xi(t){si.hoverPlane=null,g[T.PlaneHoverOut].data=null,g[T.PlaneHoverOut].state=!0}function Pi(t){var e=t.parent.getOutputSettingItem();g[T.PlaneClick].data=e,g[T.PlaneClick].state=!0}function Ci(t){si.hoverTitle=t;var e=t.settingItem.uuid,i=(si.tagsMap.get(e)||si.tagsGroup.getObjectByName("tag-"+e)).getOutputSettingItem();g[T.TitleHover].data=i,g[T.TitleHover].state=!0}function Oi(t){si.hoverTitle=null;var e=t.pid,i=si.tagsMap.get(e).getOutputSettingItem();g[T.TitleHoverOut].data=i,g[T.TitleHoverOut].state=!0}function Mi(t){var e=si.tagsMap.get(t).getOutputSettingItem();g[T.TitleClick].data=e,g[T.TitleClick].state=!0}function Di(){g[T.BlankAreaClick].state=!0}function Si(t){if(void 0===t&&(t=[]),0===t.length)return null;n.get("ext");var e=si.raycaster.intersectObjects(t);if(0<e.length){var i=e[0],o=i.object,a=i.point,r=w.getCameraPosition(),s=!1;return"model"===w.getActiveModelType()&&"panorama"===w.getCurrentMode()&&(s=w.judgeBarrierBetweenThePoint(r,a)),s?null:o}return null}function Ei(){var t=[];return si.tagsMap.forEach((function(e){e.visible&&e.head.visible&&t.push(e.head)})),t}function Ai(t){t?(si.hoverPlane&&si.hoverPlane.uuid!==t.uuid&&si.hoverPlane.hoverOut(),t.hoverIn()):si.hoverPlane&&si.hoverPlane.hoverOut()}function Ii(){return 0<si.tagsMap.size}function Li(t,e){si.tagsMap.forEach((function(i){i[t]&&i[t](e)}))}function Hi(t,e){var i;D.convertScreenPositionToNDC(t,e,ni),i=w.getCamera(),si.raycaster.setFromCamera(ni,i)}function Bi(t){g[T.ViewRotate].data=t,g[T.ViewRotate].state=!0,Hi(ri.x,ri.y),Ai(Si(Ei()))}function ki(t){g[T.ViewRotateStop].data=t,g[T.ViewRotateStop].state=!0}function zi(t){g[T.VisualRangeChanged].data=t,g[T.VisualRangeChanged].state=!0}return li.prototype.name="tags-manager",li.prototype.supportPlatform=[Je,$e],li.prototype.registeredApi=Object.create(null),li.prototype.onApi=Object.create(null),li.prototype.register=function(){var t=this;e.info(this.name+" register")(),w.qspace=this.parent;var i=this.parent.commonExtension;this.registeredApi[i.API.NEED_UPDATE]=!0,this.registeredApi[i.API.NEED_CORE_LOADED]=!0,this.registeredApi[i.API.NEED_ON_RESIZE]=!0,this.registeredApi[i.API.NEED_MODE_CHANGE]=!0,this.registeredApi[i.API.NEED_SWITCH_WAYPOINT_START]=!0,this.registeredApi[i.API.NEED_SWITCH_WAYPOINT_TRANSITION]=!0,this.registeredApi[i.API.NEED_SWITCH_WAYPOINT_COMPLETE]=!0,this.registeredApi[i.API.NEED_SWITCH_MODEL]=!0,this.registeredApi[i.API.NEED_SWITCH_MODEL_COMPLETE]=!0,this.registeredApi[i.API.NEED_PANORAMA_CAMERA_ROTATE]=!0,this.registeredApi[i.API.NEED_DOLLHOUSE_CAMERA_ROTATE]=!0,this.registeredApi[i.API.NEED_PANORAMA_CAMERA_ROTATE_STOP]=!0,this.registeredApi[i.API.NEED_DOLLHOUSE_CAMERA_ROTATE_STOP]=!0,this.registeredApi[i.API.NEED_MOUSE_OUT]=!0,this.registeredApi[i.API.NEED_MOUSE_MOVE_INTERSECT_WITHIN_MODEL]=!0,this.registeredApi[i.API.NEED_MOUSE_MOVE_WITHOUT_BUTTON_DOWN]=!0,this.registeredApi[i.API.NEED_MOUSE_LEFT_BUTTON_DOWN_WITHIN_MOVE]=!0,this.registeredApi[i.API.NEED_MOUSE_LEFT_BUTTON_DOWN]=!0,this.registeredApi[i.API.NEED_MOUSE_LEFT_BUTTON_UP]=!0,this.registeredApi[i.API.NEED_MOUSE_LEFT_BUTTON_DOWN_UP_WITHOUT_MOVE]=!0,this.registeredApi[i.API.NEED_MOUSE_RIGHT_BUTTON_DOWN_UP_WITHOUT_MOVE]=!0,this.registeredApi[i.API.NEED_HANDLE_SINGLE_TOUCH_START]=!0,this.registeredApi[i.API.NEED_HANDLE_CLICK]=!0,this.onApi[i.API.NEED_UPDATE]=function(e){if(t.newTag&&t.newTag.onFrameUpdate(e),t.hasTag()&&Li("onFrameUpdate",e),t.newTag&&!0===g[T.ViewRotate].state&&M.isPc()){var i=w.getIntersectWithinPointer(ri.x,ri.y);t.newTag.followMoving(i)}},this.onApi[i.API.NEED_CORE_LOADED]=function(e){w.sceneAdd(t.tagsGroup)},this.onApi[i.API.NEED_PANORAMA_CAMERA_ROTATE]=function(t){Bi(t)},this.onApi[i.API.NEED_DOLLHOSUE_CAMERA_ROTATE]=function(t){Bi(t)},this.onApi[i.API.NEED_PANORAMA_CAMERA_ROTATE_STOP]=function(t){ki(t)},this.onApi[i.API.NEED_DOLLHOUSE_CAMERA_ROTATE_STOP]=function(t){ki(t)},this.onApi[i.API.NEED_MODE_CHANGE]=function(e){switch(t.hoverPlane&&t.hoverPlane.hoverOut(),t.hoverBasePlate&&t.hoverBasePlate.hoverOut(),e.mode){case"transitioning":si.disablePicker=!0,g[T.PlaneClick].state=!1,g[T.BasePlateClick].state=!1;break;case"panorama":t.visualRange&&ye.updateVisualRangeSphere(w.getPanoramaCameraPosition(),t.visualRange),t.disablePicker=!1;break;case"dollhouse":case"floorplan":t.disablePicker=!1}Li("onModeChange",e.mode)},this.onApi[i.API.NEED_MOUSE_MOVE_INTERSECT_WITHIN_MODEL]=function(e){t.newTag&&(t.disablePicker=!0,t.newTag.followMoving(e))},this.onApi[i.API.NEED_MOUSE_LEFT_BUTTON_DOWN_WITHIN_MOVE]=function(t){ri.x=t.x,ri.y=t.y,ai.pipe(12.5,(function(){!function(){var t=w.getActiveModelType();if("model"===t&&si.hoverBasePlate){var e=w.getIntersectWithinMouse();e&&si.hoverBasePlate.parent.dragMoving(e)}if("purepano"===t&&si.hoverBasePlate){var i=w.getIntersectWithinMouse();i&&si.hoverBasePlate.parent.dragMoving(i)}Li("onMouseDragMoving")}()}))},this.onApi[i.API.NEED_MOUSE_LEFT_BUTTON_DOWN]=function(e){t.hoverBasePlate&&ui(t.hoverBasePlate.parent)},this.onApi[i.API.NEED_MOUSE_LEFT_BUTTON_UP]=function(t){ri.x=t.offsetX,ri.y=t.offsetY,!0===g[T.TagDragMoving].state&&si.choosedTag.dragMovingEnd()},this.onApi[i.API.NEED_MOUSE_RIGHT_BUTTON_DOWN_UP_WITHOUT_MOVE]=function(){if(t.newTag){var e=t.newTag.getOutputSettingItem();g[T.NewTagPutDown].data=e,g[T.NewTagPutDown].state=!0,t.newTag.putDown()}},this.onApi[i.API.NEED_MOUSE_MOVE_WITHOUT_BUTTON_DOWN]=function(t){var e=t.x,i=t.y,n=t.target;ri.x=e,ri.y=i,oi.pipe(12.5,(function(){!function(t,e,i){if(Hi(t,e),!1===si.hasTag())return;if(!0===si.disablePicker)return;(function(t){var e=si.raycaster.intersectObjects(t);if(0<e.length){var i=e[0].object;!0===i.visible&&i.hover()}else si.hoverBasePlate&&si.hoverBasePlate.hoverOut()})((n=[],si.tagsMap.forEach((function(t){t.visible&&t.basePlate.visible&&n.push(t.basePlate)})),n)),Ai(Si(Ei())),"tag.title"===i._type?i.hoverIn():si.hoverTitle&&si.hoverTitle.hoverOut();var n;si.hoverPlane||si.hoverBasePlate||si.hoverTitle||(g[T.BlankAreaHover].state=!0)}(e,i,n)}))},this.onApi[i.API.NEED_MOUSE_LEFT_BUTTON_DOWN_UP_WITHOUT_MOVE]=function(e){t.hoverBasePlate?t.hoverBasePlate.click():t.hoverPlane?t.hoverPlane.click():"tag.title"===e.target._type?t.onTagTitleClick(e.target.pid):t.onBlankAreaClick()},this.onApi[i.API.NEED_MOUSE_OUT]=function(t){si.hoverPlane&&si.hoverPlane.hoverOut(),si.hoverBasePlate&&si.hoverBasePlate.hoverOut()},this.onApi[i.API.NEED_HANDLE_SINGLE_TOUCH_START]=function(t){var e=M.getRendererStageOffsetInfo(),i=t.changedTouches[0].clientX-e.offset_left,n=t.changedTouches[0].clientY-e.offset_top;ri.x=i,ri.y=n,function(t,e){Hi(t,e)}(i,n),Ai(Si(Ei()))},this.onApi[i.API.NEED_HANDLE_CLICK]=function(e){t.hoverPlane?(t.hoverPlane.click(),t.hoverPlane.hoverOut()):"tag.title"===e.target._type?t.onTagTitleClick(e.target.pid):t.onBlankAreaClick()},this.onApi[i.API.NEED_SWITCH_MODEL]=function(t){g[T.StopLoading].state=!0},this.onApi[i.API.NEED_SWITCH_MODEL_COMPLETE]=function(e){g[T.StopLoading].state=!1,t.visualRange&&ye.updateVisualRangeSphere(w.getCameraPosition(),t.visualRange)},this.onApi[i.API.NEED_SWITCH_WAYPOINT_START]=function(t){Li("onSwitchPano",t)},this.onApi[i.API.NEED_SWITCH_WAYPOINT_TRANSITION]=function(e){t.transformControls.forEach((function(t){return t.update()})),t.visualRange&&ye.updateVisualRangeSphere(w.getPanoramaCameraPosition(),t.visualRange)},this.onApi[i.API.NEED_SWITCH_WAYPOINT_COMPLETE]=function(e){t.visualRange&&ye.updateVisualRangeSphere(w.getPanoramaCameraPosition(),t.visualRange),Li("onSwitchPanoComplete",e)},this.onApi[i.API.NEED_ON_RESIZE]=function(t){Li("onRendererResize",t)}},li.prototype.init=function(t){N.init(t.res)},li.prototype.install=function(t){void 0===t&&(t=function(){}),T.init(),g[T.EnableSyncTitlePosition].state=!0,ye.init(this),Ke(this),this.disablePicker=!1,t()},li.prototype.uninstall=function(){ye.cancelPut(),ye.removeAllTags(),this.clear()},li.prototype.clear=function(){this.newTag=null,this.hoverBasePlate=null,this.hoverPlane=null,this.choosedTag=null},li.prototype.onTagsLoaded=function(){g[T.AllTagsLoaded].state=!0},li.prototype.onTagAddedTransformControl=function(t,e){this.transformControls.set(t,e),w.sceneAdd(e)},li.prototype.onTagRemoveTarnsformControl=function(t){var e=this.transformControls.get(t);e.destroy(),this.transformControls.delete(t),w.sceneRemove(e)},li.prototype.onTransformControlHoverIn=function(t){g[T.TransformControlHoverIn].data=t,g[T.TransformControlHoverIn].state=!0},li.prototype.onTransformControlHoverOut=function(t){g[T.TransformControlHoverOut].data=t,g[T.TransformControlHoverOut].state=!0},li.prototype.onTransformControlPointerDown=function(t){g[T.TransformControlPointerDown].data=t,g[T.TransformControlPointerDown].state=!0},li.prototype.onTransformControlPointerUp=function(t){g[T.TransformControlPointerUp].data=t,g[T.TransformControlPointerUp].state=!0},li.prototype.onTransformControlDragMoving=function(t){var e=si.tagsMap.get(t).getOutputSettingItem();g[T.TransformControlDragMoving].data=e,g[T.TransformControlDragMoving].state=!0},li.prototype.onTransformControlDragMovingEnd=function(t){var e=si.tagsMap.get(t).getOutputSettingItem();g[T.TransformControlDragMovingEnd].data=e,g[T.TransformControlDragMovingEnd].state=!0},li}));
