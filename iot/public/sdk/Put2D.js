!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Put2D=e()}(this,(function(){"use strict";var t=function(t,e,i){return t(i={path:e,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==e&&i.path)}},i.exports),i.exports}((function(t){t.exports=qspace.THREE}));function e(){var t=!0,e=2;Object.defineProperties(this,{enabled:{get:function(){return t},set:function(e){t=e}},level:{get:function(){return e},set:function(t){e=t}}})}e.prototype.echo=function(t,e){return this.enabled?((e=Array.prototype.slice.call(e)).unshift("sdk:"),e.unshift(console),Function.prototype.bind.apply(t,e)):function(){}},e.prototype.info=function(){return 1===this.level?this.echo(console.info,arguments):function(){}},e.prototype.debug=function(){return 1===this.level||2===this.level?this.echo(console.debug,arguments):function(){}},e.prototype.warn=function(){return 1===this.level||2===this.level||3===this.level?this.echo(console.warn,arguments):function(){}},e.prototype.error=function(){if(1===this.level||2===this.level||3===this.level||4===this.level)return this.echo(console.error,arguments)},e.prototype.time=function(){return this.echo(console.time,arguments)},e.prototype.timeEnd=function(){return this.echo(console.timeEnd,arguments)};var i=new e,o={Add:"put.2d.add",CancelAdd:"put.2d.cancel.add",Click:"put.2d.click",ClickBlank:"put.2d.click.blank",Edit:"put.2d.edit",ExitEdit:"put.2d.exit.edit",Hover:"put.2d.hover",HoverOut:"put.2d.hover.out",PickerHover:"put.2d.picker.hover",PickerHoverOut:"put.2d.picker.hover.out",Reput:"put.2d.reput",PutDown:"put.2d.put.down",CancelReput:"put.2d.cancel.reput",Remove:"put.2d.remove",DragStart:"put.2d.drag.start",DragEnd:"put.2d.drag.end",Translate:"put.2d.translate",TranslateEnd:"put.2d.translate.end",Rotate:"put.2d.rotate",RotateEnd:"put.2d.rotate.end",Scale:"put.2d.scale",ScaleEnd:"put.2d.scale.end",Play:"put.2d.play",StopPlay:"put.2d.stop.play"};Object.freeze(o);var r=o;function n(t,e){return"[object Number]"===Object.prototype.toString.call(t)&&!isNaN(t)||(e&&i.error(e+" is not number")(),!1)}function a(t,e){return"[object Object]"===Object.prototype.toString.call(t)||(e&&i.error(e+" is not object")(),!1)}var s=function(t,e){return"[object String]"===Object.prototype.toString.call(t)||(e&&i.error(e+" is not string")(),!1)},c=n,l=function(t,e){return"[object Boolean]"===Object.prototype.toString.call(t)||(e&&i.error(e+" is not boolean")(),!1)},u=function(t,e){return"[object Function]"===Object.prototype.toString.call(t)||(e&&i.error(e+" is not function")(),!1)},p=a,h=function(t,e){return"[object Array]"===Object.prototype.toString.call(t)||(e&&i.error(e+" is not array")(),!1)},d=function(t,e){if(a(t,e))return!!(n(t.x,"x")&&n(t.y,"y")&&n(t.z,"z")&&3===Object.keys(t).length)||(e&&i.error(e+" is not vec3")(),!1)},f=function(t,e){return!!a(t,e)&&(!!(n(t.x,"x")&&n(t.y,"y")&&n(t.z,"z")&&n(t.w,"w")&&4===Object.keys(t).length)||(e&&i.error(e+" is not vec4")(),!1))};var v={getTsNow:function(){return Date.now()||(new Date).getTime()}};function y(t){return Object.prototype.toString.call(t).slice(8,-1).toLowerCase()}function m(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function g(t){var e,i=y(t);if("object"!==i&&"array"!==i)return t;if("object"===i)for(var o in e={},t)m(t,o)&&(e[o]=g(t[o]));if("array"===i){e=[];for(var r=t.length,n=0;n<r;n++)e.push(g(t[n]))}return e}var _=function(){var t=[];this.pipe=function(e,i){return t.push(v.getTsNow()),2===t.length?e>t[1]-t[0]?(t.pop(),!0):(i&&i(),t.shift(),!1):(i&&i(),!1)},this.clear=function(){t=[]}},x=function(t,e){t.x=e.x,t.y=e.y,t.z=e.z},w=function(t,e,i){if(void 0===i&&(i={own:!1,deep:!1}),"object"!==y(t))return{};function o(e,i){({11:function(e){m(t,e)&&(r[e]=g(t[e]))},10:function(e){r[e]=g(t[e])},"01":function(e){m(t,e)&&(r[e]=t[e])},0:function(e){r[e]=t[e]}})[(!!i._own+2*!!i._deep).toString(2)](e)}var r={};if("array"===y(e))for(var n=e.length,a=0;a<n;a++){o(e[a],{_own:i.own,_deep:i.deep})}if("object"===y(e))for(var s in e)if(m(e,s)){var c=e[s];"function"===y(c.pick)?r[s]=c.pick(t[s]):o(s,{_own:c.own,_deep:c.deep})}return r};function b(e){var i=e.width,o=e.height,r=e.bg_color,n=e.bg_opacity;t.Mesh.call(this),this.geometry=new t.PlaneBufferGeometry(i,o),this.material=new t.MeshBasicMaterial({color:r||0,opacity:n||1,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:-1}),this._opacity=this.material.opacity,this.renderOrder=0}b.prototype=Object.create(t.Mesh.prototype),b.prototype.constructor=b,b.prototype.bindGroup=function(t){this.group2D=t},b.prototype.show=function(){this.visible=!0},b.prototype.hide=function(){this.visible=!1},b.prototype.dispose=function(){this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose()};var E=b;var P=function(e){var i=this;this.id=e.data.id,this.uuid=e.uuid,this.visible=!0,this._position=e.position,this._quaternion=e.quaternion,this._scale=e.scale,this.floor=[],this.transform_data={translate:{x:0,y:0,z:0},rotate:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}},this.savePoseData={position:new t.Vector3,quaternion:new t.Quaternion,scale:new t.Vector3},this.vertices=null,this.vertex_screen_position=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}],Object.defineProperties(this,{position:{get:function(){return{x:i._position.x,y:i._position.y,z:i._position.z}}},quaternion:{get:function(){return{x:i._quaternion.x,y:i._quaternion.y,z:i._quaternion.z,w:i._quaternion.w}}},scale:{get:function(){return{x:i._scale.x,y:i._scale.y,z:i._scale.z}}},material:{get:function(){return e.container.material_list}}})};var O={convertScreenPositionToNDC:function(e,i,o){var r=document.getElementById("renderer-stage");return(o=o||new t.Vector2).x=e/r.clientWidth*2-1,o.y=-i/r.clientHeight*2+1,o},convertWorldPositionToScreen:function(t,e){var i=document.getElementById("renderer-stage"),o=t.clone().project(e),r=i.clientWidth/2,n=i.clientHeight/2;return{x:o.x*r+r,y:-o.y*n+n}},computeWorldPositionOutCamera:function(t,e,i){var o=(t=t.clone()).applyMatrix4(e).applyMatrix4(i),r=Math.abs(o.x)>1,n=Math.abs(o.y)>1,a=Math.abs(o.z)>1;return!!(r||n||a)},computeWorldPositionOutCamera2:function(t,e,i){var o=(t=t.clone()).applyMatrix4(e).applyMatrix4(i);return Math.abs(o.z)>1},getVerticesOfItemSize:function(e){for(var i=e.attributes.position,o=i.itemSize,r=[],n={},a=0,s=i.array.length;a<s;a+=o){var c=i.array[a],l=i.array[a+1],u=i.array[a+2],p="k_"+c+"_"+l+"_"+u;void 0===n[p]&&(r.push(new t.Vector3(c,l,u)),n[p]=1)}return r}};function M(e){var i=e.name,o=e.color,r=e.activeColor;t.Mesh.call(this),this.name=i,this._color=o,this._activeColor=r,this.geometry=new t.RingBufferGeometry(.4,.48,16,1,0,Math.PI/2),this.material=new t.MeshBasicMaterial({color:o,opacity:.6,transparent:!0,side:t.DoubleSide,depthWrite:!1,depthFunc:t.AlwaysDepth}),this._opacity=.6,this.visible=!0,this.forcedHide=!1,this.renderOrder=1,this._type="rotate"}M.prototype=Object.create(t.Mesh.prototype),M.prototype.constructor=M,M.prototype.hide=function(t){t&&(this.forcedHide=!0),this.visible=!1},M.prototype.show=function(t){t&&(this.forcedHide=!1),!this.forcedHide&&(this.visible=!0)},M.prototype.activate=function(){this._active||(this._active=!0,this.material.color.set(this._activeColor),this.material.opacity=1,this._opacity=1)},M.prototype.inactivate=function(){this._active&&(this._active=!1,this.material.color.set(this._color),this.material.opacity=.6,this._opacity=.6)},M.prototype.onHover=function(){this.activate()},M.prototype.onHoverOut=function(){this.inactivate()};var D=M,T=new t.Vector3,C=new t.Vector3;function S(e){var i=e.name,o=e.width,r=e.height,n=e.color;t.Mesh.call(this),this.geometry=new t.PlaneBufferGeometry(o,r,1,1),this.material=new t.MeshBasicMaterial({color:n,side:t.DoubleSide,transparent:!0,opacity:.2}),this.visible=!1,this.name=i}S.prototype=Object.create(t.Mesh.prototype),S.prototype.constructor=S,S.prototype.dragStart=function(t){T.copy(t.point)},S.prototype.dragMove=function(e){C.copy(e.point);var i=this.worldToLocal(T.clone()),o=this.worldToLocal(C.clone()),r=t.MathUtils.radToDeg(o.angleTo(i)),n=(new t.Vector3).crossVectors(o,i).z>0;T.copy(C),this.parent.toRotate({angle:r,clockwise:n})};var k=S;function G(e){var i=e.color,o=e.name;t.Group.call(this),this.name=o,this.meshList=[],this.domElement=null,this.createBgPlane(i),this.createMouseIndication(),this.visible=!1}G.prototype=Object.create(t.Group.prototype),G.prototype.constructor=G,G.prototype.createBgPlane=function(e){for(var i=Math.PI/4-.02,o=0;o<=7;o++){var r=Math.PI*o/4,n=new t.RingBufferGeometry(.6,.65,24,1,r,i),a=new t.MeshBasicMaterial({color:16777215,opacity:.8,transparent:!0,side:t.DoubleSide,depthWrite:!1,depthFunc:t.AlwaysDepth}),s=new t.Mesh(n,a);s.renderOrder=1,s._opacity=.8,6!==o&&5!==o||(a.color.set(e),a.opacity=1,s._opacity=1),this.meshList.push(s),this.add(s)}},G.prototype.createMouseIndication=function(){var t=document.createElement("div"),e=document.getElementById("renderer-stage");t.id="rotate-mouse-indication",t.style="\n\t\tdisplay: none;\n\t\tposition: absolute;\n\t\tpadding: 0 4px;\n\t\theight: 20px;\n\t\tline-height: 20px;\n\t\tfont-size: 16px;\n\t\tcolor: white;\n\t\tbackground-color: #424242;\n\t\tborder-radius: 2px;\n\t\tpointer-events: none;\n\t",this.domElement=t,e.appendChild(t)},G.prototype.setMouseIndicationInfo=function(t){var e=t.value,i=t.top,o=t.left;this.domElement.innerText=e+"Â°",this.domElement.style.top=i+"px",this.domElement.style.left=o+"px"},G.prototype.setRadius=function(t){var e=this;this.meshList.forEach((function(t){t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose(),e.remove(t)})),t=Math.sqrt(Math.pow(.5,2)+Math.pow(.75,2)),this.createBgPlane(t)},G.prototype.show=function(){this.visible=!0,this.domElement.style.display="block"},G.prototype.hide=function(){this.visible=!1,this.domElement.style.display="none"};var A=G,U={x:{color:16072511,activeColor:16072511,name:"x",show:!0,dis:0,width:.5,height:.05,depth:.05},y:{color:46122,activeColor:46122,name:"y",show:!0,dis:0,width:.5,height:.05,depth:.05},z:{color:1465855,activeColor:1465855,name:"z",show:!0,dis:0,width:.5,height:.05,depth:.05}},j={xy:{name:"xy",width:200,height:200,color:16776960,show:!0},xz:{name:"xz",width:200,height:200,color:16711935,show:!0},yz:{name:"yz",width:200,height:200,color:65535,show:!0}},I={x:{color:16072511,name:"x",show:!0},y:{color:46122,name:"y",show:!0},z:{color:1465855,name:"z",show:!0}};function N(e){t.Group.call(this),this._pickers=[],this._pickerPlaneMap=Object.create(null),this.rotateIndicationPlaneMap=Object.create(null),this.initPickers(e),this.initPickePlanes(),this.initRotateIndicationPlanes(),this.activeAxis="",this.activePicker=null,this.activePickerPlane=null,this.visible=!1}N.prototype=Object.create(t.Group.prototype),N.prototype.constructor=N,N.prototype.initPickers=function(t){var e=this;Object.keys(U).forEach((function(i){if(U[i].show){var o=new D(U[i],t),r=U[i];r.dis,r.width;z(o,{axis:i,offset:0}),e.add(o),e._pickers.push(o)}}))},N.prototype.initPickePlanes=function(){var t=this;Object.keys(j).forEach((function(e){if(j[e].show){var i=new k(j[e]);H(i),t.add(i),t._pickerPlaneMap[e]=i}}))},N.prototype.initRotateIndicationPlanes=function(){var t=this;Object.keys(I).forEach((function(e){if(I[e].show){var i=new A(I[e]);t.rotateIndicationPlaneMap[e]=i,W(i),t.add(i)}}))},N.prototype.setActivePicker=function(t){this.activeAxis=t.name,this.activePicker=t,this._pickers.forEach((function(e){e!==t&&e.hide()}))},N.prototype.setActivePickerPlane=function(t){if(t)switch(t){case"x":this.activePickerPlane=this._pickerPlaneMap.yz;break;case"y":this.activePickerPlane=this._pickerPlaneMap.xz;break;case"z":this.activePickerPlane=this._pickerPlaneMap.xy}},N.prototype.dragStart=function(t){var e=(t.intersectObjects(this._pickers)[0]||{}).object;if(e){this.setActivePicker(e),this.setActivePickerPlane(e.name);var i=t.intersectObject(this.activePickerPlane)[0];i&&(this.activePickerPlane.dragStart(i),this.parent.onControlActive("rotate"))}},N.prototype.dragMove=function(t){if(this.activePickerPlane){var e=t.intersectObject(this.activePickerPlane)[0];e&&(this.setState(!0),this.activePickerPlane.dragMove(e))}},N.prototype.dragEnd=function(){this.setState(!1),this.activeAxis="",this.activePicker=null,this.activePickerPlane=null,this._pickers.forEach((function(t){t.show()})),this.parent.onControlUnActive()},N.prototype.toRotate=function(t){var e=t.angle,i=t.clockwise,o=t.axis||this.activeAxis,r={angle:i?this.parent.object.getAllowData({control:"rotate",axis:o,offset:e}):this.parent.object.getAllowData({control:"rotate",axis:o,offset:-e}),axis:o};this.parent.object.toRotate(r)},N.prototype.hide=function(){this.visible=!1},N.prototype.show=function(){this.visible=!0},N.prototype.setState=function(t){t?(this.activePicker&&this.activePicker.hide(),this.rotateIndicationPlaneMap[this.activeAxis].show()):(this.activePicker&&this.activePicker.show(),this.rotateIndicationPlaneMap[this.activeAxis].hide())},N.prototype.setPickerRadius=function(t,e){this._pickers.forEach((function(t){t.setRadius(e/2)}));var i=Math.sqrt(Math.pow(t,2)+Math.pow(e,2))/2;this.rotateIndicationPlaneMap[this.activeAxis].setRadius(i)},N.prototype.setMouseIndicationInfo=function(t){this.activeAxis&&this.rotateIndicationPlaneMap[this.activeAxis].setMouseIndicationInfo(t)},N.prototype.setPickerOpactity=function(t){this._pickers.forEach((function(e){t>=.6&&(t=.6),e.material.opacity=t,e._opacity=t}))};var z=function(t,e){var i=e.axis,o=e.offset;switch(i){case"x":t.rotateY(-Math.PI/2);break;case"y":t.rotateX(Math.PI/2)}return t.translateX(o)},H=function(t){switch(t.name){case"xy":break;case"yz":t.rotateY(Math.PI/2);break;case"xz":t.rotateX(-Math.PI/2)}},W=function(t){switch(t.name){case"x":t.rotateY(Math.PI/2);break;case"y":t.rotateX(-Math.PI/2)}},B=N;function L(e){var i=e.color,o=e.activeColor,r=e.name;e.width,e.height,e.depth;t.Mesh.call(this),this.name=r;var n=[new t.Vector2(0,0),new t.Vector2(.005,0),new t.Vector2(.005,.6),new t.Vector2(.06,.6),new t.Vector2(0,.8)];this.geometry=new t.LatheGeometry(n),this.material=new t.MeshBasicMaterial({color:i,side:t.DoubleSide,opacity:1,transparent:!0,depthTest:!1}),this.renderOrder=2,this.visible=!0,this.forcedHide=!1,this._type="translate",this._color=i,this._activeColor=o,this._active=!1}L.prototype=Object.create(t.Mesh.prototype),L.prototype.constructor=L,L.prototype.hide=function(t){t&&(this.forcedHide=!0),this.visible=!1},L.prototype.show=function(t){t&&(this.forcedHide=!1),!this.forcedHide&&(this.visible=!0)},L.prototype.activate=function(){this._active||(this._active=!0,this.material.color.set(this._activeColor))},L.prototype.inactivate=function(){this._active&&(this._active=!1,this.material.color.set(this._color))},L.prototype.onHover=function(){this.activate()},L.prototype.onHoverOut=function(){this.inactivate()};var R=L,F=new t.Vector3,q=new t.Vector3;function V(e){var i=e.name,o=e.width,r=e.height,n=e.color;t.Mesh.call(this),this.geometry=new t.PlaneBufferGeometry(o,r,1,1),this.material=new t.MeshBasicMaterial({color:n,side:t.DoubleSide,transparent:!0,opacity:.2}),this.visible=!1,this.name=i}V.prototype=Object.create(t.Mesh.prototype),V.prototype.constructor=V,V.prototype.dragStart=function(t){F.copy(t.point)},V.prototype.dragMove=function(e){q.copy(e.point);var i=(new t.Vector3).subVectors(q,F);F.copy(q),this.parent.toMove(i)};var X=V,Y={x:{color:16072511,activeColor:16736352,name:"x",show:!0,dis:.01,width:.5,height:.05,depth:.05},y:{color:46122,activeColor:253751,name:"y",show:!0,dis:.01,width:.5,height:.05,depth:.05},z:{color:1465855,activeColor:6988287,name:"z",show:!0,dis:.01,width:.5,height:.05,depth:.05}},Q={xy:{name:"xy",width:200,height:200,color:16776960,show:!0},xz:{name:"xz",width:200,height:200,color:16711935,show:!0},yz:{name:"yz",width:200,height:200,color:65535,show:!0}},K=null;function J(){t.Group.call(this),this._pickers=[],this._pickerPlaneMap=Object.create(null),this.initPickers(),this.initPickePlanes(),this.activeAxis="",this.activePicker=null,this.activePickerPlane=null,this.visible=!1}J.prototype=Object.create(t.Group.prototype),J.prototype.constructor=J,J.prototype.initPickers=function(){var t=this;Object.keys(Y).forEach((function(e){if(Y[e].show){var i=new R(Y[e]),o=Y[e],r=o.dis;o.width;Z(i,{axis:e,offset:r}),t.add(i),t._pickers.push(i)}}))},J.prototype.initPickePlanes=function(){var t=this;Object.keys(Q).forEach((function(e){if(Q[e].show){var i=new X(Q[e]);$(i),t.add(i),t._pickerPlaneMap[e]=i}}))},J.prototype.setActivePicker=function(t){this.activeAxis=t.name,this.activePicker=t,this._pickers.forEach((function(e){if(e===t)return t.activate();e.hide()}))},J.prototype.setActivePickerPlane=function(e){if(e){K.updateMatrixWorld();var i=K.position,o=new t.Vector3;o.copy(i).sub(this.parent.object.position).normalize();var r=new t.Matrix4;return o.applyMatrix4(r.getInverse(r.extractRotation(this._pickerPlaneMap.xy.matrixWorld))),"x"===e?(this.activePickerPlane=this._pickerPlaneMap.xy,void(Math.abs(o.y)>Math.abs(o.z)&&(this.activePickerPlane=this._pickerPlaneMap.xz))):"y"===e?(this.activePickerPlane=this._pickerPlaneMap.xy,void(Math.abs(o.x)>Math.abs(o.z)&&(this.activePickerPlane=this._pickerPlaneMap.yz))):"z"===e?(this.activePickerPlane=this._pickerPlaneMap.xz,void(Math.abs(o.x)>Math.abs(o.y)&&(this.activePickerPlane=this._pickerPlaneMap.yz))):void 0}},J.prototype.dragStart=function(t,e){K=e;var i=(t.intersectObjects(this._pickers)[0]||{}).object;if(i){this.setActivePicker(i),this.setActivePickerPlane(i.name);var o=t.intersectObject(this.activePickerPlane)[0];o&&(this.activePickerPlane.dragStart(o),this.parent.onControlActive("translate"))}},J.prototype.dragMove=function(t){if(this.activePickerPlane){var e=t.intersectObject(this.activePickerPlane)[0];e&&this.activePickerPlane.dragMove(e)}},J.prototype.dragEnd=function(){this.activeAxis="",this.activePicker=null,this.activePickerPlane=null,this._pickers.forEach((function(t){t.show()})),this.parent.onControlUnActive()},J.prototype.toMove=function(e){var i=new t.Vector3;switch(this.activeAxis){case"x":i.x=1;break;case"y":i.y=1;break;case"z":i.z=1}var o=new t.Quaternion;o.setFromRotationMatrix(this.parent.object.matrixWorld),i.applyQuaternion(o);var r=e.clone().projectOnVector(i).length();e.dot(i)<0&&(r=-r);var n=this.parent.object.getAllowData({control:"translate",offset:r,axis:this.activeAxis});this.parent.object.toTranslate({offset:n,axis:this.activeAxis})},J.prototype.hide=function(){this.visible=!1},J.prototype.show=function(){this.visible=!0},J.prototype.setPickerOpactity=function(t){this._pickers.forEach((function(e){e.material.opacity=t,e._opacity=t}))};var Z=function(t,e){var i=e.axis,o=e.offset;switch(i){case"x":t.rotateZ(-Math.PI/2);break;case"y":break;case"z":t.rotateX(Math.PI/2)}return t.translateY(o)},$=function(t){switch(t.name){case"xy":break;case"yz":t.rotateY(-Math.PI/2);break;case"xz":t.rotateX(-Math.PI/2)}},tt=J;function et(e){var i=e.color,o=e.activeColor,r=e.name;t.Mesh.call(this),this.name=r,this._color=i,this._activeColor=o,this._type="scale",this.geometry=new t.BoxBufferGeometry(.1,.1,.1),this.material=new t.MeshBasicMaterial({color:i,opacity:1,transparent:!0,depthWrite:!1,depthFunc:t.AlwaysDepth}),this.renderOrder=1,this.forcedHide=!1}et.prototype=Object.create(t.Mesh.prototype),et.prototype.constructor=et,et.prototype.show=function(t){t&&(this.forcedHide=!1),!this.forcedHide&&(this.visible=!0)},et.prototype.hide=function(t){t&&(this.forcedHide=!0),this.visible=!1},et.prototype.activate=function(){},et.prototype.inactivate=function(){},et.prototype.onHover=function(){this.activate()},et.prototype.onHoverOut=function(){this.inactivate()};var it=et,ot=new t.Vector3,rt=new t.Vector3;function nt(e){var i=e.name,o=e.width,r=e.height,n=e.color;t.Mesh.call(this),this.geometry=new t.PlaneBufferGeometry(o,r,1,1),this.material=new t.MeshBasicMaterial({color:n,side:t.DoubleSide,transparent:!0,opacity:.2}),this.visible=!1,this.name=i}nt.prototype=Object.create(t.Mesh.prototype),nt.prototype.constructor=nt,nt.prototype.dragStart=function(t){ot.copy(t.point)},nt.prototype.dragMove=function(e){rt.copy(e.point);var i=(new t.Vector3).subVectors(rt,ot);ot.copy(rt),this.parent.toScale(i)};var at=nt,st={"x+":{color:16171851,activeColor:16752896,name:"x+",show:!0,dis:.01,width:.1,height:.1,depth:.1},"y+":{color:16171851,activeColor:16752896,name:"y+",show:!0,dis:.01,width:.1,height:.1,depth:.1},"x-":{color:16171851,activeColor:16752896,name:"x-",show:!0,dis:.01,width:.1,height:.1,depth:.1},"y-":{color:16171851,activeColor:16752896,name:"y-",show:!0,dis:.01,width:.1,height:.1,depth:.1}},ct={xy:{name:"xy",width:2e3,height:2e3,color:16776960,show:!0},xz:{name:"xz",width:2e3,height:2e3,color:16711935,show:!0},yz:{name:"yz",width:2e3,height:2e3,color:65535,show:!0}};function lt(){t.Group.call(this),this._pickers=[],this.pickerPlane=null,this.activeAxis="",this.activePicker=null,this.visible=!1,this.isEqual=!1,this.initPickers(),this.initPickePlanes()}lt.prototype=Object.create(t.Group.prototype),lt.prototype.constructor=lt,lt.prototype.initPickers=function(){var t=this;Object.keys(st).forEach((function(e){if(st[e].show){var i=new it(st[e]);t.add(i),t._pickers.push(i)}}))},lt.prototype.initPickePlanes=function(){this.pickerPlane=new at(ct.xy),this.add(this.pickerPlane)},lt.prototype.setActivePicker=function(t){this.activeAxis=t.name,this.activePicker=t,this._pickers.forEach((function(e){if(e===t)return t.activate();e.hide()}))},lt.prototype.dragStart=function(t,e){var i=(t.intersectObjects(this._pickers)[0]||{}).object;if(i){this.setActivePicker(i);var o=t.intersectObject(this.pickerPlane)[0];o&&(this.pickerPlane.dragStart(o),this.parent.onControlActive("scale"))}},lt.prototype.dragMove=function(t){var e=t.intersectObject(this.pickerPlane)[0];e&&this.pickerPlane.dragMove(e)},lt.prototype.dragEnd=function(){this.activeAxis="",this.activePicker=null,this._pickers.forEach((function(t){t.show()})),this.parent.onControlUnActive()},lt.prototype.toScale=function(e){var i=new t.Vector3,o=this.activeAxis[0];switch(this.activeAxis){case"x+":i.x=1;break;case"x-":i.x=-1;break;case"y+":i.y=1;break;case"y-":i.y=-1}var r=new t.Quaternion;r.setFromRotationMatrix(this.parent.matrixWorld),i.applyQuaternion(r);var n=e.clone().projectOnVector(i).length();e.dot(i)<0&&(n=-n);var a,s,c=this.parent.object.getAllowData({control:"scale",offset:n,axis:o});if(this.isEqual){var l="x"===o?"y":"x",u=this.parent.object.scale,p=u[o]/u[l],h=c/p,d=this.parent.object.getAllowData({control:"scale",offset:h,axis:l});s=d,a=Math.abs(d)<Math.abs(h)?d*p:c,this.parent.object.toScale({value:a,axis:o}),this.parent.object.toScale({value:s,axis:l})}else a=c,this.parent.object.toScale({value:a,axis:o})},lt.prototype.enableEqual=function(){this.isEqual=!0},lt.prototype.disableEqual=function(){this.isEqual=!1},lt.prototype.show=function(){this.visible=!0},lt.prototype.hide=function(){this.visible=!1},lt.prototype.setScale=function(t){this.parent.object.onControlScale(t)},lt.prototype.setPickerOpactity=function(t){this._pickers.forEach((function(e){e.material.opacity=t,e._opacity=t}))},lt.prototype.setPickerPosition=function(t,e){this._pickers.forEach((function(i){switch(i.name){case"x+":i.position.setX(t/2);break;case"x-":i.position.setX(-t/2);break;case"y+":i.position.setY(e/2);break;case"y-":i.position.setY(-e/2)}}))},lt.prototype.setPickersScale=function(t){this._pickers.forEach((function(e){return e.scale.set(t,t,t)}))};var ut=lt;function pt(){t.Group.call(this),this.translateControl=null,this.rotateControl=null,this.scaleControl=null,this.object=null,this.status={translate:!1,rotate:!1,scale:!1},this.activeControlType=""}pt.prototype=Object.create(t.Group.prototype),pt.prototype.constructor=pt,pt.prototype.init=function(){this.rotateControl=new B,this.translateControl=new tt,this.scaleControl=new ut,this.add(this.rotateControl,this.translateControl,this.scaleControl)},pt.prototype.bindObject=function(t){this.object=t,this.syncPose()},pt.prototype.unbindObject=function(){this.object=null,this.activeControlType="",this.hide()},pt.prototype.onControlActive=function(t){var e=this,i=this.object.ext.config.controller.edit.activeOtherOpacity,o={translate:function(){e.rotateControl.setPickerOpactity(i),e.scaleControl.setPickerOpactity(i)},rotate:function(){e.translateControl.setPickerOpactity(i),e.scaleControl.setPickerOpactity(i)},scale:function(){e.translateControl.setPickerOpactity(i),e.rotateControl.setPickerOpactity(i)}};this.activeControlType=t,o[t](),this.object.onControlActive(t)},pt.prototype.onControlUnActive=function(){this.translateControl.setPickerOpactity(1),this.rotateControl.setPickerOpactity(1),this.scaleControl.setPickerOpactity(1);var t=this.activeControlType;this.activeControlType="",this.object.onControlUnActive(t)},pt.prototype.unActive=function(){this.activeControlType&&this[this.activeControlType+"Control"].dragEnd()},pt.prototype.show=function(){this.translateControl.show(),this.rotateControl.show(),this.scaleControl.show(),this.status.translate=!0,this.status.rotate=!0,this.status.scale=!0},pt.prototype.hide=function(){this.hideTranslateControl(),this.hideRotateControl(),this.hideScaleControl()},pt.prototype.showTranslateControl=function(){this.translateControl.show(),this.status.translate=!0},pt.prototype.hideTranslateControl=function(){this.translateControl.hide(),this.status.translate=!1},pt.prototype.showRotateControl=function(){this.rotateControl.show(),this.status.rotate=!0},pt.prototype.hideRotateControl=function(){this.rotateControl.hide(),this.status.rotate=!1},pt.prototype.showScaleControl=function(){this.scaleControl.show(),this.status.scale=!0},pt.prototype.hideScaleControl=function(){this.scaleControl.hide(),this.status.scale=!1},pt.prototype.syncPose=function(){this.quaternion.copy(this.object.quaternion),this.position.copy(this.object.position);var t=this.object.data.width,e=this.object.data.height,i=this.object.scale;this.scaleControl.setPickerPosition(t*i.x,e*i.y)},pt.prototype.setScale=function(t){this.translateControl.scale.set(t,t,t),this.rotateControl.scale.set(t,t,t),this.scaleControl.setPickersScale(t)};var ht=pt,dt=new t.TextureLoader;dt.setCrossOrigin("Anonymous");var ft=new Map;var vt={TextureMap:ft,loadSingleTexture:function(t,e,o){void 0===e&&(e=function(){}),void 0===o&&(o=function(){});var r=t.split(/(\/\/)/g)[2],n=ft.get(r);if(n){var a=n.clone();return a.needsUpdate=!0,e(a),a}return dt.load("//"+r,(function(t){ft.set(r,t),e(t)}),(function(t){}),(function(e){i.error("loadSingleTexture <"+t+"> error:",e)(),o()}))},loadSingleTexture2:function(e,o){void 0===o&&(o=function(){});var r=new Image;r.addEventListener("load",(function(){}),!1),r.addEventListener("error",(function(t){i.error("loadSingleTexture2",t)()}),!1),r.src=e;var n=new t.Texture;n.image=r,document.body.appendChild(r),o(n)},loadMultipleTextures:function(t){},createCanvasLabel:function(e){var i=document.createElement("canvas"),o=i.getContext("2d");o.font=e.fontSize+"px "+e.fontFace;var r=o.measureText(e.text).width+e.fontSize,n=e.fontSize+e.fontSize,a=n/10;return i.width=r,i.height=n,o.lineWidth=2,o.strokeStyle=e.bgColor,o.fillStyle=e.bgColor,function(t,e,i,o,r,n){t.beginPath(),t.moveTo(e,i+n),t.lineTo(e,i+r-n),t.quadraticCurveTo(e,i+r,e+n,i+r),t.lineTo(e+o-n,i+r),t.quadraticCurveTo(e+o,i+r,e+o,i+r-n),t.lineTo(e+o,i+n),t.quadraticCurveTo(e+o,i,e+o-n,i),t.lineTo(e+n,i),t.quadraticCurveTo(e,i,e,i+n),t.stroke(),t.fill(),t.closePath()}(o,2,2,r-4,n-4,a),function(t,e){t.fillStyle=e.fontColor,t.font=e.fontSize+"px "+e.fontFace,t.textAlign="center",t.textBaseline="middle",t.fillText(e.text,r/2,n/2+2),t.fillText(e.text,r/2,n/2+2)}(o,e),{texture:new t.CanvasTexture(i),width:i.width,height:i.height,ratio:i.width/i.height}},createCanvasText:function(e){var i=document.createElement("canvas"),o=i.getContext("2d"),r="normal bold "+e.fontSize+"px "+e.fontFace;o.font=r;var n=o.measureText(e.text),a=n.width,s=n.actualBoundingBoxAscent,c=e.width,l=e.height;c=a+64,l=e.fontSize+32,i.width=c,i.height=l,o.rect(0,0,c,l),o.fillStyle=e.bgColor,o.fill(),o.fillStyle=e.fontColor,o.font=r;var u=.5*(c-a),p=e.fontSize+.5*(l-e.fontSize);p-=.5*(l-s),p+=16,o.fillText(e.text,u,p,a);var h=new t.CanvasTexture(i);return i.style.cssText+="position:absolute;bottom:0;left:0;width:"+c+"px;height:"+l+"px;",i.style.cssText+="background-color:rgba(255, 255, 255, 1)",{texture:h,width:c,height:l,ratio:c/l}}};function yt(e){var i=e.src,o=e.autoSize,r=e.fullSize;t.Mesh.call(this),this.material=new t.MeshBasicMaterial({opacity:1,transparent:!0}),this.autoSize=o,this.fullSize=r,this.autoGeometry=null,this.fullGeometry=null,this.name="photo",this.group2D=null,this.src=i}yt.prototype=Object.create(t.Mesh.prototype),yt.prototype.constructor=yt,yt.prototype.init=function(t){this.group2D=t,this.initGeometry("auto",this.autoSize.width,this.autoSize.height),this.initGeometry("full",this.fullSize.width,this.fullSize.height),this.loadTexture(this.src)},yt.prototype.initGeometry=function(e,i,o){"auto"===e?this.autoGeometry=new t.PlaneBufferGeometry(i,o):this.fullGeometry=new t.PlaneBufferGeometry(i,o)},yt.prototype.setFillType=function(t){this.geometry="auto"===t?this.autoGeometry:this.fullGeometry},yt.prototype.loadTexture=function(t){var e=this,i=this.group2D.ext.modelSign;vt.loadSingleTexture(t,(function(t){i===e.group2D.ext.modelSign&&e.setTexture(t)}))},yt.prototype.setTexture=function(t){this.material.map=t,this.material.needsUpdate=!0},yt.prototype.dispose=function(){this.autoGeometry&&this.autoGeometry.dispose(),this.fullGeometry&&this.fullGeometry.dispose(),this.material&&(this.material.dispose(),this.material.map&&this.material.map.dispose())};var mt=yt;function gt(e){var i=e.src,o=e.autoSize,r=e.fullSize;t.Group.call(this),this.type="photo",this.plane=new mt({src:i,autoSize:o,fullSize:r})}gt.prototype=Object.create(t.Group.prototype),gt.prototype.constructor=gt,gt.prototype.init=function(t){this.plane.init(t),this.add(this.plane)},gt.prototype.setFillType=function(t){this.plane.setFillType(t)},gt.prototype.dispose=function(){this.plane.dispose()};var _t=gt,xt="",wt=null;function bt(e){var i=e.src,o=e.forcedHide;void 0===o&&(o=!1),t.Mesh.call(this),this.geometry=new t.PlaneBufferGeometry(.2,.2),this.material=new t.MeshBasicMaterial({opacity:1,transparent:!0,polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:-1}),this.renderOrder=1,this.src=i,this.forcedHide=o,this.visible=!1,this.isPlaying=!1,this.group2D=null}bt.prototype=Object.create(t.Mesh.prototype),bt.prototype.constructor=bt,bt.prototype.init=function(t){this.group2D=t,this.loadTexture(this.src)},bt.prototype.loadTexture=function(t){var e=this,i=this.group2D.ext.modelSign;t!==xt&&(wt&&wt.dispose(),wt=null),xt=t,wt?this.setTexture(wt):vt.loadSingleTexture(t,(function(t){i===e.group2D.ext.modelSign&&(wt=t,e.setTexture(t))}))},bt.prototype.setTexture=function(t){this.material.map=t,this.material.needsUpdate=!0},bt.prototype.show=function(){this.isPlaying=!1,!this.forcedHide&&(this.visible=!0)},bt.prototype.hide=function(){this.isPlaying=!0,this.visible=!1},bt.prototype.setForcedHide=function(t){this.forcedHide=t,t?this.visible=!1:!this.isPlaying&&(this.visible=!0)},bt.prototype.dispose=function(){this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose()};var Et=bt,Pt="\n  varying vec2 vUv;\n  void main(void) {\n    vUv = uv;\n    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n    gl_Position = projectionMatrix * mvPosition;\n  }\n",Ot="\n  uniform int fillType;\n  uniform sampler2D map;\n  uniform sampler2D bgTexture;\n  uniform vec3 fillColor;\n  uniform vec3 filterColor;\n\tuniform float fillOpacity;\n  varying vec2 vUv;\n  void main(void) {\n    vec4 tColor = texture2D( map, vUv );\n    float alpha = (length(tColor.rgb - filterColor) - 0.5) * 10.0;\n    vec4 result = vec4(tColor.rgb, alpha);\n    float whiteness = 1.0 - smoothstep(0.1, 0.2, alpha);\n    vec4 resultColor;\n    if(fillType == 0) {\n      resultColor = vec4(fillColor, fillOpacity);\n    } else if (fillType == 1) {\n      resultColor = texture2D( bgTexture, vUv );\n    }\n    gl_FragColor = mix(resultColor, result, 1.0 - whiteness);\n  }\n";function Mt(e){var i=e.videoDom,o=e.autoSize,r=e.fullSize,n=e.green_screen_config;t.Mesh.call(this),this.autoSize=o,this.fullSize=r,this.autoGeometry=null,this.fullGeometry=null,this.type=n?"green-screen":"normal",this.lookAtCamera=!1,this.material=function(e,i){if("normal"===e)return new t.MeshBasicMaterial({opacity:1,transparent:!0});if("green-screen"===e)return function(e){var i=e.filter_color,o=e.fill_color,r=e.fill_opacity;return new t.ShaderMaterial({uniforms:{fillType:{value:0},filterColor:{value:new t.Color(i)},fillColor:{value:new t.Color(o)},fillOpacity:{value:r||0},threshold:{value:.01},map:{value:null},bgTexture:{value:null}},vertexShader:Pt,fragmentShader:Ot,transparent:!0,side:t.DoubleSide})}(i)}(this.type,n),this.name="video",this.group2D=null,this.videoDom=i,this.playIcon=null,n&&(this.lookAtCamera=!!n.look_at_camera)}Mt.prototype=Object.create(t.Mesh.prototype),Mt.prototype.constructor=Mt,Mt.prototype.init=function(e){var i=this;this.group2D=e,this.setTexture(this.videoDom),this.addEventListener(),this.createBgPlane(),this.initGeometry("auto",this.autoSize.width,this.autoSize.height),this.initGeometry("full",this.fullSize.width,this.fullSize.height),this.group2D.ext.config.icon.play&&this.createPlayIcon(this.group2D.ext.config.icon.play),"green-screen"===this.type&&(this.onBeforeRender=function(){if(i.group2D.ext.middleWare.getCameraPosition())if(i.lookAtCamera){var e=i.group2D.ext.middleWare.getCameraPosition();i.parent.lookAt((new t.Vector3).copy(e))}else i.parent.quaternion.copy(new t.Quaternion)})},Mt.prototype.initGeometry=function(e,i,o){"auto"===e?this.autoGeometry=new t.PlaneBufferGeometry(i,o):this.fullGeometry=new t.PlaneBufferGeometry(i,o)},Mt.prototype.setFillType=function(t){this.geometry="auto"===t?this.autoGeometry:this.fullGeometry},Mt.prototype.addEventListener=function(){var t=this;this.videoDom.onplay=function(){t.parent.onPlay(),t.group2D.onContainerEvent("play")},this.videoDom.onpause=function(){t.parent.onStopPlay(),t.group2D.onContainerEvent("stop")}},Mt.prototype.setTexture=function(e){var i=document.getElementById("videos-box");i||((i=document.createElement("div")).id="videos-box",i.style.display="none",document.getElementById("renderer-stage").appendChild(i));i.appendChild(e),e.autoplay&&e.play();var o=new t.VideoTexture(e);o.crossOrigin="anonymous","normal"===this.type?(this.material.map=o,this.material.needsUpdate=!0):this.material.uniforms.map.value=o},Mt.prototype.createPlayIcon=function(t){var e=new Et(t);this.playIcon=e,this.add(e)},Mt.prototype.setGreenScreenParams=function(e){if("green-screen"===this.type){var i=e.filter_color,o=e.fill_color,r=e.fill_opacity,n=e.look_at_camera;void 0!==i&&(this.material.uniforms.filterColor.value=new t.Color(i)),void 0!==o&&(this.material.uniforms.fillColor.value=new t.Color(o)),void 0!==r&&(this.material.uniforms.fillOpacity.value=r),this.lookAtCamera=!!n}},Mt.prototype.createBgPlane=function(){var e=new t.MeshBasicMaterial({color:0}),i=new t.Mesh(this.geometry,e);this.add(i)},Mt.prototype.play=function(){this.videoDom.play()},Mt.prototype.stopPlay=function(){this.videoDom.pause()},Mt.prototype.show=function(){this.visible=!0},Mt.prototype.hide=function(){this.visible=!1},Mt.prototype.onFrameUpdate=function(){this.videoDom.paused||("normal"===this.type&&this.material.map?this.material.map.needsUpdate=!0:"green-screen"===this.type&&this.material.uniforms.map&&(this.material.uniforms.map.value.needsUpdate=!0))},Mt.prototype.dispose=function(){if(this.autoGeometry&&this.autoGeometry.dispose(),this.fullGeometry&&this.fullGeometry.dispose(),this.material&&(this.material.dispose(),this.material.map&&this.material.map.dispose()),this.videoDom){var t=document.getElementById("videos-box");this.videoDom.onpause=null,t.removeChild(this.videoDom),this.videoDom=null}};var Dt=Mt;function Tt(e){var i=e.cover,o=e.videoDom,r=e.autoSize,n=e.fullSize,a=e.green_screen_config,s=e.icon,c=e.forcedHide;t.Group.call(this),this.type="video",this.icon=s,this.plane=null,this.photoPlane=null,this.videoPlane=null,this.playIconPlane=null,this.createPlane({cover:i,videoDom:o,autoSize:r,fullSize:n,green_screen_config:a,forcedHide:c})}Tt.prototype=Object.create(t.Group.prototype),Tt.prototype.constructor=Tt,Tt.prototype.init=function(t){this.photoPlane&&this.photoPlane.init(t),this.videoPlane.init(t),this.playIconPlane.init(t)},Tt.prototype.createPlane=function(t){var e=t.cover,i=t.videoDom,o=t.autoSize,r=t.fullSize,n=t.green_screen_config,a=t.forcedHide;this.videoPlane=new Dt({videoDom:i,autoSize:o,fullSize:r,green_screen_config:n}),this.playIconPlane=new Et({src:this.icon.play,forcedHide:a}),this.plane=this.videoPlane,this.add(this.videoPlane),this.add(this.playIconPlane),e&&(this.photoPlane=new mt({src:e,autoSize:o,fullSize:r}),!i.autoplay&&this.videoPlane.hide(),this.plane=this.photoPlane,this.add(this.photoPlane)),this.playIconPlane.show()},Tt.prototype.setFillType=function(t){this.videoPlane.setFillType(t),this.photoPlane&&this.photoPlane.setFillType(t)},Tt.prototype.play=function(){this.videoPlane.show(),this.videoPlane.play()},Tt.prototype.stopPlay=function(){this.videoPlane.stopPlay()},Tt.prototype.onPlay=function(){this.photoPlane&&(this.remove(this.photoPlane),this.photoPlane=null,this.plane=this.videoPlane),this.playIconPlane.hide()},Tt.prototype.onStopPlay=function(){this.parent.playing=!1,this.playIconPlane.show()},Tt.prototype.onFrameUpdate=function(t){this.videoPlane.onFrameUpdate(t)},Tt.prototype.dispose=function(){this.photoPlane&&this.photoPlane.dispose(),this.videoPlane.dispose(),this.playIconPlane.dispose()};var Ct=Tt;function St(e){var i=e.src,o=e.autoSize,r=e.fullSize,n=e.tile_config;t.Mesh.call(this),this.material=new t.MeshBasicMaterial({opacity:1,transparent:!0}),this.autoSize=o,this.fullSize=r,this.autoGeometry=null,this.fullGeometry=null,this.name="sprite",this.group2D=null,this.src=i,this.tileConfig=n,this.currentTile=0,this.deltaTime=0,this.ext=null}St.prototype=Object.create(t.Mesh.prototype),St.prototype.constructor=St,St.prototype.init=function(t){this.group2D=t,this.ext=t.ext,this.initGeometry("auto",this.autoSize.width,this.autoSize.height),this.initGeometry("full",this.fullSize.width,this.fullSize.height),this.loadTexture(this.src)},St.prototype.initGeometry=function(e,i,o){"auto"===e?this.autoGeometry=new t.PlaneBufferGeometry(i,o):this.fullGeometry=new t.PlaneBufferGeometry(i,o)},St.prototype.setFillType=function(t){this.geometry="auto"===t?this.autoGeometry:this.fullGeometry},St.prototype.loadTexture=function(e){var i=this,o=this.ext.modelSign;vt.loadSingleTexture(e,(function(e){if(o===i.ext.modelSign){var r=i.tileConfig,n=r.count,a=r.vertical,s=r.horizontal;e.wrapS=t.RepeatWrapping,e.wrapT=t.RepeatWrapping,e.repeat.set(a/n,s/n),i.setTexture(e)}}))},St.prototype.setTexture=function(t){this.material.map=t,this.material.needsUpdate=!0},St.prototype.onFrameUpdate=function(t){if(this.deltaTime+=1e3*t,this.deltaTime>=this.tileConfig.duration){this.currentTile++,this.deltaTime=0,this.currentTile>=this.tileConfig.count&&(this.currentTile=0);var e=this.currentTile/this.tileConfig.horizontal,i=-this.currentTile/this.tileConfig.vertical;this.material.map&&this.material.map.offset.set(e,i)}},St.prototype.dispose=function(){this.autoGeometry&&this.autoGeometry.dispose(),this.fullGeometry&&this.fullGeometry.dispose(),this.material&&(this.material.dispose(),this.material.map&&this.material.map.dispose())};var kt=St;function Gt(e){var i=e.src,o=e.autoSize,r=e.fullSize,n=e.tile_config;t.Group.call(this),this.type="sprite",this.plane=new kt({src:i,autoSize:o,fullSize:r,tile_config:n})}Gt.prototype=Object.create(t.Group.prototype),Gt.prototype.constructor=Gt,Gt.prototype.init=function(t){this.plane.init(t),this.add(this.plane)},Gt.prototype.setFillType=function(t){this.plane.setFillType(t)},Gt.prototype.onFrameUpdate=function(t){this.plane.onFrameUpdate(t)},Gt.prototype.dispose=function(){this.plane.dispose()};var At=Gt;function Ut(e){var i=e.canvas,o=e.autoSize,r=e.fullSize;t.Mesh.call(this),this.material=new t.MeshBasicMaterial({opacity:1,transparent:!0,premultipliedAlpha:!0}),this.autoSize=o,this.fullSize=r,this.autoGeometry=null,this.fullGeometry=null,this.name="canvas",this.group2D=null,this.canvas=i}Ut.prototype=Object.create(t.Mesh.prototype),Ut.prototype.constructor=Ut,Ut.prototype.init=function(t){this.group2D=t,this.initGeometry("auto",this.autoSize.width,this.autoSize.height),this.initGeometry("full",this.fullSize.width,this.fullSize.height),this.loadTexture(this.canvas)},Ut.prototype.initGeometry=function(e,i,o){"auto"===e?this.autoGeometry=new t.PlaneBufferGeometry(i,o):this.fullGeometry=new t.PlaneBufferGeometry(i,o)},Ut.prototype.setFillType=function(t){this.geometry="auto"===t?this.autoGeometry:this.fullGeometry},Ut.prototype.loadTexture=function(e){var i=new t.CanvasTexture(e);this.setTexture(i)},Ut.prototype.setTexture=function(t){this.material.map=t,this.material.needsUpdate=!0},Ut.prototype.onFrameUpdate=function(t){this.material.map.needsUpdate=!0},Ut.prototype.dispose=function(){this.autoGeometry&&this.autoGeometry.dispose(),this.fullGeometry&&this.fullGeometry.dispose(),this.material&&(this.material.dispose(),this.material.map&&this.material.map.dispose())};var jt=Ut;function It(e){var i=e.canvas,o=e.autoSize,r=e.fullSize;t.Group.call(this),this.type="canvas",this.plane=new jt({canvas:i,autoSize:o,fullSize:r})}It.prototype=Object.create(t.Group.prototype),It.prototype.constructor=It,It.prototype.init=function(t){this.plane.init(t),this.add(this.plane)},It.prototype.setFillType=function(t){this.plane.setFillType(t)},It.prototype.onFrameUpdate=function(t){this.plane.onFrameUpdate(t)},It.prototype.dispose=function(){this.plane.dispose()};var Nt=It,zt=w;var Ht=function(t){return zt(t,["id","width","height","bg_color","bg_opacity","loop_play","fill_type"])},Wt=function(t,e){var i=zt(e,["id","cover","type","src","auto_play","canvas"]);return i.group=t,i.uuid=t.uuid,i};function Bt(e){var i=e.width,o=e.height,r=e.loop_play,n=e.fill_type;void 0===n&&(n="auto"),t.Group.call(this),this.group2D=null,this.width=i,this.height=o,this.loopPlay=!!r,this.muted=!1,this.playing=!1,this.fillType=n,this.material_list=[],this.materialMap={},this.activeGroup=null}function Lt(t){if(t){var e=t.split("_"),i=e[e.length-1],o=e[e.length-2];if(i&&(i=i.split(".")[0]),i&&o)return{w:Number(o),h:Number(i)}}}Bt.prototype=Object.create(t.Group.prototype),Bt.prototype.constructor=Bt,Bt.prototype.init=function(t){this.group2D=t},Bt.prototype.setMaterial=function(t){var e=this,i=t.material_list,o=t.success,r=t.failure;i=i.slice(0,1);var n=[];i.forEach((function(t){var i=e.addMaterial(t);n.push(i)})),Promise.all(n).then((function(){o()})).catch((function(t){r({id:e.group2D.data.id,message:"load material fail"})}))},Bt.prototype.addMaterial=function(t){var e=this;return new Promise((function(i,o){if(e.material_list.length>1)return o({id:t.id,message:"material more than 1"});if("photo"===t.type&&e.createPhotoGroup(t.src).then((function(o){return e.handleAddMaterial(o,t),i({uuid:o.uuid,id:t.id})})).catch((function(e){return o({id:t.id,message:"load pic fail, "+e})})),"sprite"===t.type&&e.createSpriteGroup(t.src,t.tile_config).then((function(o){return e.handleAddMaterial(o,t),i({uuid:o.uuid,id:t.id})})).catch((function(e){return o({id:t.id,message:"load sprite fail, "+e})})),"video"===t.type&&e.createVideoGroup(t).then((function(o){return e.handleAddMaterial(o,t),i({uuid:o.uuid,id:t.id})})).catch((function(e){return o({id:t.id,message:"load video fail, "+e})})),"canvas"===t.type){var r=e.createCanvasGroup(t.canvas);return e.handleAddMaterial(r,t),i({uuid:r.uuid,id:t.id})}}))},Bt.prototype.removeMaterial=function(t){var e=this.materialMap[t];if(e){e.group===this.activeGroup&&this.remove(this.activeGroup),this.activeGroup.dispose(),this.activeGroup=null;var i=this.material_list.indexOf(e);return this.material_list.splice(i,1),delete this.materialMap[t],!0}return!1},Bt.prototype.replaceMaterial=function(t){if(!this.removeMaterial(t.material_uuid)){return t.failure("replace material fail, .uuid is not exist")}this.addMaterial(t.data).then((function(e){t.success(e)})).catch((function(e){t.failure(e)}))},Bt.prototype.setActiveGroup=function(t){this.activeGroup=t,this.add(t)},Bt.prototype.handleAddMaterial=function(t,e){t.init(this.group2D),t.setFillType(this.fillType);var i=Wt(t,e);this.material_list.push(i),this.materialMap[i.uuid]=i,this.setActiveGroup(t)},Bt.prototype.createVideoGroup=function(t){var e=this,i=t.src,o=t.cover,r=t.green_screen_config,n=t.auto_play,a=t.play_btn_forced_hide;return this.getVideoInfo(i,o).then((function(t){var i=t.videoDom,s=t.width,c=t.height,l=e.getWH(s,c),u=l.w,p=l.h;return n&&(i.autoplay=!0,i.muted=!0,e.muted=!0,e.playing=!0),new Ct({videoDom:i,cover:o,autoSize:{width:u,height:p},fullSize:{width:e.width,height:e.height},icon:e.group2D.ext.config.icon,green_screen_config:r,forcedHide:!!a})}))},Bt.prototype.createPhotoGroup=function(t){var e=this;return this.getImageInfo(t).then((function(i){var o=i.width,r=i.height,n=e.getWH(o,r),a=n.w,s=n.h;return new _t({src:t,autoSize:{width:a,height:s},fullSize:{width:e.width,height:e.height}})})).catch((function(t){}))},Bt.prototype.createSpriteGroup=function(t,e){var i=this;return this.getImageInfo(t).then((function(o){var r=o.width,n=o.height,a=e.vertical,s=e.horizontal,c=i.getWH(r/s,n/a),l=c.w,u=c.h;return new At({src:t,autoSize:{width:l,height:u},fullSize:{width:i.width,height:i.height},tile_config:e})})).catch((function(t){}))},Bt.prototype.createCanvasGroup=function(t){var e=this.getWH(Number(t.width),Number(t.height)),i=e.w,o=e.h;return new Nt({canvas:t,autoSize:{width:i,height:o},fullSize:{width:this.width,height:this.height}})},Bt.prototype.getWH=function(t,e){if(e/t>this.height/this.width){var i=this.height;return{w:i/e*t,h:i}}var o=this.width;return{w:o,h:o/t*e}},Bt.prototype.getImageInfo=function(t){var e=this,i=this.group2D.ext.modelSign;return new Promise((function(o,r){var n=new Image;n.src=t,n.onload=function(){i===e.group2D.ext.modelSign?o({width:n.width,height:n.height}):r("model change")},n.onerror=function(e){r(t)}}))},Bt.prototype.getVideoInfo=function(t,e){var i=this;return new Promise((function(o,r){var n=i.createVideoDom(t),a=Lt(t);if(a)o({videoDom:n,width:a.w,height:a.h});else{if(e)return(a=Lt(e))?void o({videoDom:n,width:a.w,height:a.h}):void i.getImageInfo(e).then((function(t){var e=t.width,i=t.height;o({videoDom:n,width:(a={w:e,h:i}).w,height:a.h})})).catch((function(t){r(e)}));var s=i.group2D.ext.modelSign;n.onloadedmetadata=function(){s===i.group2D.ext.modelSign?o({videoDom:n,width:n.videoWidth,height:n.videoHeight}):r("model change")},n.onerror=function(e){r(t)}}}))},Bt.prototype.createVideoDom=function(t){var e=document.createElement("video");return e.src=t,e.crossOrigin="anonymous",e.muted=this.muted,e.loop=this.loopPlay,e.preload="auto",e.setAttribute("playsinline",!0),e.setAttribute("webkit-playsinline",!0),e.setAttribute("x5-playsinline",!0),e},Bt.prototype.setFillType=function(t){this.fillType=t,this.activeGroup&&this.activeGroup.setFillType(t)},Bt.prototype.play=function(){this.activeGroup&&"video"===this.activeGroup.type&&(this.playing=!0,this.activeGroup.play())},Bt.prototype.stopPlay=function(){this.activeGroup&&"video"===this.activeGroup.type&&(this.playing=!1,this.activeGroup.stopPlay())},Bt.prototype.mute=function(){this.muted=!0,this.activeGroup&&"video"===this.activeGroup.type&&(this.activeGroup.videoPlane.videoDom.muted=!0)},Bt.prototype.unMute=function(){this.muted=!1,this.activeGroup&&"video"===this.activeGroup.type&&(this.activeGroup.videoPlane.videoDom.muted=!1)},Bt.prototype.openLoopPlay=function(){this.loopPlay||(this.loopPlay=!0,this.activeGroup&&"video"===this.activeGroup.type&&(this.activeGroup.videoPlane.videoDom.loop=!0))},Bt.prototype.closeLoopPlay=function(){this.loopPlay&&(this.loopPlay=!1,this.activeGroup&&"video"===this.activeGroup.type&&(this.activeGroup.videoPlane.videoDom.loop=!1))},Bt.prototype.getMaterial=function(t){for(var e=this.material_list.length-1;e>=0;e--){if(this.material_list[e].uuid===t)return this.material_list[e]}},Bt.prototype.onFrameUpdate=function(t){this.activeGroup&&~["sprite","video","canvas"].indexOf(this.activeGroup.type)&&this.activeGroup.onFrameUpdate(t)},Bt.prototype.dispose=function(){this.activeGroup&&(this.activeGroup.dispose(),this.activeGroup=null)};var Rt=Bt;function Ft(){this.div=null,this.css3dObject=null}Ft.prototype=Object.create(null),Ft.prototype.constructor=Ft,Ft.prototype.init=function(){this.createDiv(),this.create3DObject()},Ft.prototype.createDiv=function(){var t=document.createElement("div");t.style="\n\t\tdisplay: none;\n\t\tposition: absolute;\n\t\twidth: 100%;\n\t\theight: 100%;\n\t\tborder: #F6C34B solid 1px;\n\t",this.div=t},Ft.prototype.create3DObject=function(){this.css3dObject=new t.CSS3DObject(this.div),this.css3dObject.scale.set(.01,.01,.01),this.div.style.pointerEvents="none"},Ft.prototype.setSize=function(t,e){this.div.style.width=100*t+"px",this.div.style.height=100*e+"px"},Ft.prototype.show=function(){this.div.style.opacity=1},Ft.prototype.hide=function(){this.div.style.opacity=0};var qt=Ft;function Vt(){t.Group.call(this),this.object=null,this.visible=!1,this.css3DLine=null}Vt.prototype=Object.create(t.Group.prototype),Vt.prototype.constructor=Vt,Vt.prototype.init=function(t){var e=new qt;this.css3DLine=e,this.css3DLine.init(),this.add(this.css3DLine.css3dObject),this.hide(),this.object=t,this.updateLine()},Vt.prototype.show=function(){this.visible=!0,this.css3DLine.show()},Vt.prototype.hide=function(){this.visible=!1,this.css3DLine.hide()},Vt.prototype.updateLine=function(){var t=this.object.data.width,e=this.object.data.height;this.css3DLine.setSize(t,e)},Vt.prototype.dispose=function(){this.remove(this.css3DLine.css3dObject)};var Xt=Vt,Yt=x,Qt=O.getVerticesOfItemSize,Kt=O.convertWorldPositionToScreen,Jt=O.computeWorldPositionOutCamera,Zt=new t.Vector3;function $t(e){t.Group.call(this),this.data=e,this.ext=null,this.control=null,this.actionControl="",this.container=null,this.bgPlane=null,this.status={isFollowMoving:!0,isEdit:!1}}$t.prototype=Object.create(t.Group.prototype),$t.prototype.constructor=$t,$t.prototype.init=function(t){this.ext=t,this.bindData(),this.bindPlane(),this.bindContainer(),this.bindBorder()},$t.prototype.bindData=function(){var t=new P(this);this.setUserData("setting_item",t)},$t.prototype.bindPlane=function(){var t=this.data,e=t.width,i=t.height,o=t.bg_color,r=t.bg_opacity;this.bgPlane=new E({width:e,height:i,bg_color:o,bg_opacity:r}),this.bgPlane.bindGroup(this),this.add(this.bgPlane)},$t.prototype.bindContainer=function(){var t=this.data,e=t.width,i=t.height,o=t.loop_play,r=t.auto_play,n=t.fill_type;this.container=new Rt({width:e,height:i,loop_play:o,fill_type:n,auto_play:r}),this.container.init(this),this.add(this.container)},$t.prototype.bindBorder=function(){var t=new Xt;t.init(this),this.border=t,this.add(t)},$t.prototype.followMoving=function(t){t.mode;var e=t.normal,i=t.point;this.setPosition({position:Zt}),this.lookAt(e);var o=e.clone().multiplyScalar(this.ext.config.put.distanceFromWall),r=i.clone().add(o);this.setPosition({position:r})},$t.prototype.putDown=function(){this.status.isFollowMoving=!1,this.saveData(),this.resetTransformData(),this.ext.onGroup2dPutDown(this)},$t.prototype.cancelAdd=function(){this.dispose(),this.ext.onGroup2dCancelAdd()},$t.prototype.reput=function(){this.status.isFollowMoving=!0,this.ext.onGroup2dReput(this)},$t.prototype.cancelReput=function(){this.restoreData(),this.ext.onGroup2dCancelReput()},$t.prototype.edit=function(){this.status.isEdit=!0,this.bindControl(),this.ext.onGroup2dEdit(this)},$t.prototype.saveAndExit=function(){this.status.isEdit=!1,this.saveData(),this.unbindControl(),this.ext.onGroup2dSaveAndExit(this)},$t.prototype.bindControl=function(){this.control=this.ext.control,this.control.bindObject(this);var t=this.ext.config.controller.edit.show;t.translate&&this.showTranslate(),t.rotate&&this.showRotate(),t.scale&&this.showScale()},$t.prototype.unbindControl=function(){this.control.unbindObject(),this.control.unActive(),this.control=null},$t.prototype.showTranslate=function(){this.control.status.translate||this.control.showTranslateControl()},$t.prototype.hideTranslate=function(){this.control.status.translate&&this.control.hideTranslateControl()},$t.prototype.showRotate=function(){this.control.status.rotate||this.control.showRotateControl()},$t.prototype.hideRotate=function(){this.control.status.rotate&&this.control.hideRotateControl()},$t.prototype.showScale=function(){this.control.status.scale||this.control.showScaleControl()},$t.prototype.hideScale=function(){this.control.status.scale&&this.control.hideScaleControl()},$t.prototype.show=function(){var t=this.getUserData("setting_item");this.visible=!0,t.visible=!0},$t.prototype.hide=function(){var t=this.getUserData("setting_item");this.visible=!1,t.visible=!1},$t.prototype.getVertices=function(){var t=this;return this.updateMatrixWorld(),Qt(this.bgPlane.geometry).map((function(e){return t.bgPlane.localToWorld(e.clone())}))},$t.prototype.updateVertexScreenPosition=function(){var t=this,e=this.getUserData("setting_item"),i=this.getVertices();e.vertices=i;var o=[];i.forEach((function(e){var i=Kt(e,t.ext.middleWare.getCamera());o.push(i)})),e.vertex_screen_position=o},$t.prototype.checkBgPlaneOutScreen=function(){var t=this.ext.middleWare.getCameraWorldMatrixInverse(),e=this.ext.middleWare.getCameraProjectionMatrix();if(!t||!e)return!0;var i=0;return this.getVertices().forEach((function(o){Jt(o,t,e)&&i++})),4===i},$t.prototype.onFrameUpdate=function(t){this.container&&this.container.onFrameUpdate(t)},$t.prototype.onControlActive=function(t){this.ext.onGroup2dDragStart()},$t.prototype.onControlUnActive=function(t){switch(t){case"translate":this.ext.onGroup2dTranslateEnd();break;case"rotate":this.ext.onGroup2dRotateEnd();break;case"scale":this.ext.onGroup2dScaleEnd()}this.ext.onGroup2dDragEnd()},$t.prototype.toTranslate=function(t){var e=t.axis,i=t.offset,o=t.isinitiative;this.setPosition({offset:i,axis:e}),this.updateControlData({control:"translate",axis:e,value:i}),this.ext.onGroup2dTranslate(this,{offset:i,axis:e,isinitiative:o})},$t.prototype.toRotate=function(t){var e=t.angle,i=t.axis,o=t.isinitiative;this.setRotation({angle:e,axis:i}),this.updateControlData({control:"rotate",axis:i,value:e}),this.ext.onGroup2dRotate(this,{angle:e,axis:i,isinitiative:o})},$t.prototype.toScale=function(t){var e=t.axis,i=t.value,o=t.isinitiative;this.setScale({axis:e,value:i}),this.updateControlData({control:"scale",axis:e,value:i}),this.ext.onGroup2dScale(this,{axis:e,value:i,isinitiative:o})},$t.prototype.onContainerEvent=function(t){"play"===t&&this.ext.onPlay(this),"stop"===t&&this.ext.onStopPlay(this)},$t.prototype.getAllowData=function(t){var e=t.control,i=t.offset,o=t.axis,r=this.getUserData("setting_item").transform_data[e],n=this.ext.config.controller.limitation[e],a=r[o]+i;return i>=0?a<=n.max?i:n.max-r[o]:a>=n.min?i:n.min-r[o]},$t.prototype.setPosition=function(t){var e=t.offset,i=t.axis,o=t.position;i&&this["translate"+i.toUpperCase()](e),o&&this.position.copy(o),this.control&&this.control.syncPose()},$t.prototype.setRotation=function(e){var i=e.angle,o=e.axis,r=e.quaternion;if(o){var n=Zt.clone(),a=-t.MathUtils.degToRad(i);switch(o){case"x":n.x=1;break;case"y":n.y=1;break;case"z":n.z=1}this.rotateOnAxis(n,a)}r&&this.quaternion.copy(r),this.control&&this.control.syncPose()},$t.prototype.setScale=function(t){var e=t.axis,i=t.value,o=t.scale;if(e){var r=this.scale[e]+i;this.scale[e]=r}o&&this.scale.copy(o),this.control&&this.control.syncPose()},$t.prototype.saveData=function(){var t=this,e=this.getUserData("setting_item");e.savePoseData.position.copy(this.position),e.savePoseData.quaternion.copy(this.quaternion),e.savePoseData.scale.copy(this.scale);var i=[],o=this.ext.getFloors();o&&(o.forEach((function(e){t.ext.middleWare.computeFloorBoxContainsPoint(e,t.position)&&i.push(e)})),e.floor=i)},$t.prototype.resetTransformData=function(){var t=this.getUserData("setting_item");t.transform_data.translate={x:0,y:0,z:0},t.transform_data.rotate={x:0,y:0,z:0}},$t.prototype.restoreData=function(){var t=this.getUserData("setting_item").savePoseData;this.setPosition({position:t.position}),this.setRotation({quaternion:t.quaternion}),this.setScale({scale:t.scale})},$t.prototype.updateControlData=function(t){var e=t.control,i=t.axis,o=t.value,r=this.getUserData("setting_item");if("scale"===e){var n=this.scale[i];r.transform_data.scale[i]=n}else r.transform_data[e][i]+=o},$t.prototype.getUserData=function(t){return this.userData[t]},$t.prototype.setUserData=function(t,e){this.userData[t]=e},$t.prototype.setSyncData=function(t){var e=this.getUserData("setting_item");t.transform_data&&(t.transform_data.translate&&Yt(e.transform_data.translate,t.transform_data.translate),t.transform_data.rotate&&Yt(e.transform_data.rotate,t.transform_data.rotate),t.transform_data.scale&&Yt(e.transform_data.scale,t.transform_data.scale)),!1===t.visible&&this.hide(),this.ext.disableEdit&&this.bgPlane.hide(),this.setPosition({position:t.position}),this.setRotation({quaternion:t.quaternion}),this.setScale({scale:t.scale}),this.saveData()},$t.prototype.dispose=function(){this.bgPlane.dispose(),this.container.dispose(),this.border.dispose()};var te=$t,ee=w;function ie(t){return ee(t,["id","uuid","cover","type","src","auto_play","canvas"])}function oe(t){for(var e=[],i=t.length,o=0;o<i;o++){var r=ie(t[o]);e.push(r)}return e}var re=function(t){return ee(t,{id:"",uuid:"",visible:"",position:"",quaternion:"",scale:"",floor:"",transform_data:{deep:!0},material:{pick:oe}})},ne=u,ae=c,se=re,ce=oe,le=Ht;function ue(t){this.ext=t}ue.prototype.disableEdit=function(){this.ext.disableEdit=!0,this.ext.group2dList.forEach((function(t){t.bgPlane.hide()})),this.ext.editGroup2d&&this.ext.editGroup2d.saveAndExit()},ue.prototype.enableEdit=function(){this.ext.disableEdit=!1,this.ext.group2dList.forEach((function(t){t.bgPlane.show()}))},ue.prototype.add=function(t){var e=this.ext.name+" add 2d object failure",o=t.success,n=t.failure;if(this.ext.disableEdit&&(i.warn(e+", reason: disable edit")(),n))return n({id:t.id,message:"disable edit"});if((this.ext.status[r.Add].state||this.ext.status[r.Reput].state)&&(i.warn(e+", reason: previous 2d object is unput")(),n))return n({id:t.id,message:"previous 2d object is unput"});var a=le(t),s=new te(a);s.init(this.ext),this.ext.onGroup2dAdd(s),t.success&&o({id:t.id,uuid:s.uuid})},ue.prototype.cancelAdd=function(){var t=this.ext.name+" cancel add 2d object failure";this.ext.status[r.Add].state?this.ext.newGroup2d.cancelAdd():i.warn(t+", reason: new 2d object is not exist")()},ue.prototype.load=function(t){var e=this,i=ne(t.complete)?t.complete:function(){},o=[],r=t.data.length,n=0;t.data.forEach((function(t){var a=le(t),s=new te(a);s.init(e.ext),s.setSyncData(t),s.container.setMaterial({material_list:t.material_list,success:function(){n++,e.ext.onGroup2dLoad(s);var a=s.getUserData("setting_item"),c=se(a);t.success&&t.success(c),o.push(c),n===r&&i(o)},failure:function(e){n++,t.failure&&t.failure(e),n===r&&i(o)}})}))},ue.prototype.reput=function(t){var e=this.ext.name+" reput 2d object failure";if(this.ext.disableEdit)i.warn(e+", reason: disable edit")();else if(this.ext.status[r.Add].state)i.warn(e+", reason: current 2d object is new")();else if(this.ext.status[r.Edit].state)i.warn(e+", reason: previous 2d object is no save")();else{var o=this.ext.group2dMap[t];o?o.reput():i.warn(e+", reason: "+t+" is not exist")()}},ue.prototype.cancelReput=function(){var t=this.ext.name+" cancelreput 2d object failure";this.ext.status[r.Reput].state?this.ext.reputGroup2d.cancelReput():i.warn(t+", reason: no reput 2d object")()},ue.prototype.remove=function(t){var e=this.ext.name+" remove 2d object failure",o=this.ext.group2dMap[t];o?this.ext.removeGroup2d(o):i.warn(e+", reason: "+t+" is not exist")()},ue.prototype.removeAll=function(){this.ext.removeAllGroup2d()},ue.prototype.show=function(t){var e=this.ext.name+" show 2d object failure",o=this.ext.group2dMap[t];o?o.show():i.warn(e+", reason: "+t+" is not exist")()},ue.prototype.hide=function(t){var e=this.ext.name+" hide 2d object failure",o=this.ext.group2dMap[t];o?o.hide():i.warn(e+", reason: "+t+" is not exist")()},ue.prototype.showAll=function(){this.ext.group2dList.forEach((function(t){return t.show()}))},ue.prototype.hideAll=function(){this.ext.group2dList.forEach((function(t){return t.hide()}))},ue.prototype.fadeOutAll=function(t){!ae(t)&&(t=1e3),this.ext.createAnimate(0,t)},ue.prototype.fadeInAll=function(t){!ae(t)&&(t=1e3),this.ext.createAnimate(1,t)},ue.prototype.edit=function(t){var e=this.ext.name+" edit 2d object failure";if(this.ext.disableEdit)i.warn(e+", reason: disable edit")();else if(this.ext.status[r.Add].state||this.ext.status[r.Reput].state)i.warn(e+", reason: previous 2d object is unput")();else if(this.ext.status[r.Edit].state)i.warn(e+", reason: previous 2d object is no save")();else{var o=this.ext.group2dMap[t];o?o.edit():i.warn(e+", reason: "+t+" is not exist")()}},ue.prototype.saveAndExit=function(){var t=this.ext.editGroup2d;t&&t.saveAndExit()},ue.prototype.showTranslateControl=function(){var t=this.ext.name+" show editer translate failure";if(this.ext.status[r.Edit].state){var e=this.ext.editGroup2d;e&&e.showTranslate()}else i.warn(t+", reason: no editer")()},ue.prototype.hideTranslateControl=function(){var t=this.ext.name+" hide editer translate failure";if(this.ext.status[r.Edit].state){var e=this.ext.editGroup2d;e&&e.hideTranslate()}else i.warn(t+", reason: no editer")()},ue.prototype.showRotateControl=function(){var t=this.ext.name+" show editer rotate failure";if(this.ext.status[r.Edit].state){var e=this.ext.editGroup2d;e&&e.showRotate()}else i.warn(t+", reason: no editer")()},ue.prototype.hideRotateControl=function(){var t=this.ext.name+" hide editer rotate failure";if(this.ext.status[r.Edit].state){var e=this.ext.editGroup2d;e&&e.hideRotate()}else i.warn(t+", reason: no editer")()},ue.prototype.showScaleControl=function(){var t=this.ext.name+" show editer scale failure";if(this.ext.status[r.Edit].state){var e=this.ext.editGroup2d;e&&e.showScale()}else i.warn(t+", reason: no editer")()},ue.prototype.hideScaleControl=function(){var t=this.ext.name+" hide editer scale failure";if(this.ext.status[r.Edit].state){var e=this.ext.editGroup2d;e&&e.hideScale()}else i.warn(t+", reason: no editer")()},ue.prototype.showBorder=function(t){var e=this.ext.name+" showBorder failure",o=this.ext.group2dMap[t];o?o.border.show():i.warn(e+", reason: "+t+" is not exist")()},ue.prototype.hideBorder=function(t){var e=this.ext.name+" hideBorder failure",o=this.ext.group2dMap[t];o?o.border.hide():i.warn(e+", reason: "+t+" is not exist")()},ue.prototype.showControlAxis=function(t){var e=t.type,i=t.axis;this.ext.control&&this.ext.control[e+"Control"]._pickers.forEach((function(t){-1!==t.name.indexOf(i)&&t.show(!0)}))},ue.prototype.hideControlAxis=function(t){var e=t.type,i=t.axis;this.ext.control&&this.ext.control[e+"Control"]._pickers.forEach((function(t){-1!==t.name.indexOf(i)&&t.hide(!0)}))},ue.prototype.setRotate=function(t){var e=this.ext.name+" set rotate failure",o=this.ext.group2dMap[t.uuid];if(o){var r=this.getAllowData({group2D:o,value:t.value,axis:t.axis,control:"rotate"}),n=r[0],a=r[1];n?i.warn(e+", "+n)():o.toRotate({angle:a,axis:t.axis,isinitiative:!0})}else i.warn(e+", reason: "+t.uuid+" is not exist")()},ue.prototype.setTranslate=function(t){var e=this.ext.name+" set translate failure",o=this.ext.group2dMap[t.uuid];if(o){var r=this.getAllowData({group2D:o,value:t.value,axis:t.axis,control:"translate"}),n=r[0],a=r[1];n?i.warn(e+", "+n)():o.toTranslate({offset:a,axis:t.axis,isinitiative:!0})}else i.warn(e+", reason: "+t.uuid+" is not exist")()},ue.prototype.setScale=function(t){var e=this.ext.name+" set scale failure",o=this.ext.group2dMap[t.uuid];if(o){var r=this.getAllowData({group2D:o,value:t.value,axis:t.axis,control:"scale"}),n=r[0],a=r[1];n?i.warn(e+", "+n)():o.toScale({axis:t.axis,value:a,isinitiative:!0})}else i.warn(e+", reason: "+t.uuid+" is not exist")()},ue.prototype.enableScaleControlEqual=function(){this.ext.control.scaleControl.enableEqual()},ue.prototype.enableScaleControlEqual=function(){this.ext.control.scaleControl.disableEqual()},ue.prototype.setPoseData=function(t){var e=this.ext.name+" set editer pose data failure",o=this.ext.group2dMap[t.uuid];if(o)try{o.setSyncData(t.data),t.success&&t.success()}catch(e){t.failure&&t.failure(e)}else i.warn(e+", reason: "+t.uuid+" is not exist")()},ue.prototype.setControlSizeConstant=function(t){this.ext.controlSizeConstant=!!t,this.ext.control&&!t&&this.ext.control.setScale(1,1,1)},ue.prototype.addMaterial=function(t){var e=this.ext.name+" add material failure",o=this.ext.group2dMap[t.uuid];if(o){if(t.failure||(t.failure=function(){}),t.success||(t.success=function(){}),o.container.material_list.length)return i.warn(e+", reason: current material array length = 1")(),t.failure({id:t.id,message:"current material array length = 1"});o.container.addMaterial(t.data).then((function(e){t.success(e)})).catch((function(e){t.failure(e)}))}else i.warn(e+", reason: "+t.uuid+" is not exist")()},ue.prototype.removeMaterial=function(t){var e=this.ext.name+" remove material failure",o=this.ext.group2dMap[t.uuid];o?o.container.removeMaterial(t.material_uuid):i.warn(e+", reason: "+t.uuid+" is not exist")()},ue.prototype.replaceMaterial=function(t){var e=this.ext.name+" replace editer material failure",o=this.ext.group2dMap[t.uuid];o?(t.failure||(t.failure=function(){}),t.success||(t.success=function(){}),o.container.replaceMaterial(t)):i.warn(e+", reason: "+t.uuid+" is not exist")()},ue.prototype.setGreenScreenMaterialParams=function(t){var e=this.ext.name+" setGreenScreenMaterialParams failure",o=this.ext.group2dMap[t.uuid];if(o){var r=o.container.materialMap[t.material_uuid];r&&"video"===r.type&&"green-screen"===r.group.videoPlane.type?r.group.videoPlane.setGreenScreenParams(t):i.warn(e+", reason: "+t.material_uuid+" material is not green-screen")()}else i.warn(e+", reason: "+t.uuid+" is not exist")()},ue.prototype.setFillType=function(t){var e=this.ext.name+" setFillType failure",o=this.ext.group2dMap[t.uuid];o?o.container.setFillType(t.type):i.warn(e+", reason: "+t.uuid+" is not exist")()},ue.prototype.play=function(t){var e=this.ext.name+" play failure",o=this.ext.group2dMap[t];o?o.container.play():i.warn(e+", reason: "+t+" is not exist")()},ue.prototype.stopPlay=function(t){var e=this.ext.name+" stopPlay failure",o=this.ext.group2dMap[t];o?o.container.stopPlay():i.warn(e+", reason: "+t+" is not exist")()},ue.prototype.stopPlayAll=function(){this.ext.group2dList.forEach((function(t){t.container.stopPlay()}))},ue.prototype.mute=function(t){var e=this.ext.name+" mute failure",o=this.ext.group2dMap[t];o?o.container.mute():i.warn(e+", reason: "+t+" is not exist")()},ue.prototype.unMute=function(t){var e=this.ext.name+" unMute failure",o=this.ext.group2dMap[t];o?o.container.unMute():i.warn(e+", reason: "+t+" is not exist")()},ue.prototype.muteAll=function(){this.ext.group2dList.forEach((function(t){t.container.mute()}))},ue.prototype.unMuteAll=function(){this.ext.group2dList.forEach((function(t){t.container.unMute()}))},ue.prototype.openLoopPlay=function(t){var e=this.ext.name+" openLoopPlay failure",o=this.ext.group2dMap[t];o?o.container.openLoopPlay():i.warn(e+", reason: "+t+" is not exist")()},ue.prototype.closeLoopPlay=function(t){var e=this.ext.name+" closeLoopPlay failure",o=this.ext.group2dMap[t];o?o.container.closeLoopPlay():i.warn(e+", reason: "+t+" is not exist")()},ue.prototype.setPlayBtnForcedHide=function(t){var e=this.ext.name+" setPlayBtnForcedHide failure",o=this.ext.group2dMap[t];o?"video"!==!o.container.activeGroup.type?o.container.activeGroup.playIconPlane.setForcedHide(!0):i.warn(e+", reason: material is not video")():i.warn(e+", reason: "+t+" is not exist")()},ue.prototype.cancelPlayBtnForcedHide=function(t){var e=this.ext.name+" cancelPlayBtnForcedHide failure",o=this.ext.group2dMap[t];o?"video"!==!o.container.activeGroup.type?o.container.activeGroup.playIconPlane.setForcedHide(!1):i.warn(e+", reason: material is not video")():i.warn(e+", reason: "+t+" is not exist")()},ue.prototype.getObject2dData=function(t){var e=this.ext.group2dMap[t];if(e){var i=e.getUserData("setting_item");return se(i)}},ue.prototype.getObject2dDataById=function(t){if(null!=t)for(var e=this.ext.group2dList.length,i=0;i<e;i++){var o=this.ext.group2dList[i];if(o.data.id===t){var r=o.getUserData("setting_item");return se(r)}}},ue.prototype.getAllObject2dData=function(){var t=[];return this.ext.group2dList.forEach((function(e){var i=e.getUserData("setting_item");t.push(se(i))})),t},ue.prototype.getMaterialData=function(t){var e=this.ext.group2dMap[t];if(e)return ce(e.container.material_list)},ue.prototype.getMaterialDataById=function(t){if(null!=t)for(var e=this.ext.group2dList.length,i=0;i<e;i++){var o=this.ext.group2dList[i];if(o.data.id===t)return ce(o.container.material_list)}},ue.prototype.getMaterialStatus=function(t){var e=this.ext.group2dMap[t];if(e){var i=e.container;return{playing:i.playing,mute:i.muted}}},ue.prototype.bundleObject2dId=function(t){var e=this.ext.name+" bundle id failure",o=this.ext.group2dMap[t.uuid];return o?(o.data.id=t.id,o.getUserData("setting_item").id=t.id,!0):(i.warn(e+", reason: uuid "+t.uuid+" is not exist")(),t.failure&&t.failure({id:t.id,message:"uuid "+t.uuid+" is not exist"}),!1)},ue.prototype.getAllowData=function(t){var e=t.group2D,i=t.control,o=t.value,r=t.axis,n=e.getUserData("setting_item").transform_data[i][r],a=this.ext.config.controller.limitation[i];return o<a.min||o>a.max?["reason: params.value exceed the limit"]:[null,o-n]};var pe=ue,he=c,de=s,fe=h,ve=u,ye=d,me=f,ge=l,_e=p,xe=["x","y","z"];var we=function(t){var e="Put2D set config failure";if(void 0===t)return!0;if(!_e(t))return i.error(e+", reason: invalid params")(),!1;var o=t.controller_config,r=t.put_config,n=t.icon_config;return!(o&&!function(t){if(!_e(t))return i.error(e+", reason: invalid .controller_config")(),!1;var o=t.edit,r=t.limitation;if(o){if(!_e(o))return i.error(e+", reason: invalid .controller_config.edit")(),!1;var n=o.show,a=o.active_other_opacity;if(n&&!_e(n))return i.error(e+", reason: invalid .controller_config.edit.show")(),!1;if(a&&!he(a))return i.error(e+", reason: invalid .controller_config.edit.active_other_opacity")(),!1}if(r){if(!_e(r))return i.error(e+", reason: invalid .controller_config.limitation")(),!1;var s=r.translate,c=r.rotate,l=r.scale;if(s){if(!_e(s))return i.error(e+", reason: invalid .controller_config.translate")(),!1;var u=s.max,p=s.min;if(!he(u)||u<=0)return i.error(e+", reason: invalid .controller_config.translate.max, max must number and > 0 ")(),!1;if(!he(p)||p>=0)return i.error(e+", reason: invalid .controller_config.translate.min, min must number and < 0 ")(),!1}if(c){if(!_e(c))return i.error(e+", reason: invalid .controller_config.rotate")(),!1;var h=c.max,d=c.min;if(!he(h)||h<=0)return i.error(e+", reason: invalid .controller_config.rotate.max, max must number and > 0 ")(),!1;if(!he(d)||d>=0)return i.error(e+", reason: invalid .controller_config.rotate.min, min must number and < 0 ")(),!1}if(l){if(!_e(l))return i.error(e+", reason: invalid .controller_config.scale")(),!1;var f=l.max,v=l.min;if(!he(f)||f<1)return i.error(e+", reason: invalid .controller_config.scale.max, max must number and > 1 ")(),!1;if(!he(v)||v<=0||v>=1)return i.error(e+", reason: invalid .controller_config.scale.min, min must number and > 0 && < 1 ")(),!1}}return!0}(o))&&(!(r&&!function(t){if(!_e(t))return i.error(e+", reason: invalid .put_config")(),!1;var o=t.distance_from_wall;return!(o&&!he(o))||(i.error(e+", reason: invalid .put_config.distance_from_wall")(),!1)}(r))&&!(n&&!function(t){if(!_e(t))return i.error(e+", reason: invalid .icon_config")(),!1;var o=t.play;return!(o&&!de(o))||(i.error(e+", reason: invalid .icon_config.play")(),!1)}(n)))},be=function(t){var e="Put2D add failure";if(!t||!_e(t))return i.error(e+", reason: invalid params")(),!1;return!t.bg_color||he(t.bg_color)||de(t.bg_color)?t.bg_opacity&&!he(t.bg_opacity)?(i.error(e+", reason: invalid .bg_opacity")(),!1):he(t.width)?he(t.height)?t.fill_type&&-1===["auto","full"].indexOf(t.fill_type)?(i.error(e+", reason: invalid .fill_type")(),!1):t.success&&!ve(t.success)?(i.error(e+", reason: invalid .success")(),!1):!(t.failure&&!ve(t.failure))||(i.error(e+", reason: invalid .failure")(),!1):(i.error(e+", reason: invalid .height")(),!1):(i.error(e+", reason: invalid .width")(),!1):(i.error(e+", reason: invalid .bg_color")(),!1)},Ee=function(t){var e="Put2D setEditerTranslation failure";return t&&_e(t)?t.uuid?-1===xe.indexOf(t.axis)?(i.error(e+", reason: invalid .axis")(),!1):!!he(t.value)||(i.error(e+", reason: invalid .value")(),!1):(i.error(e+", reason: invalid .uuid")(),!1):(i.error(e+", reason: invalid params")(),!1)},Pe=function(t){var e="Put2D setEditerRotation failure";return t&&_e(t)?t.uuid?-1===xe.indexOf(t.axis)?(i.error(e+", reason: invalid .axis")(),!1):!!he(t.value)||(i.error(e+", reason: invalid .value")(),!1):(i.error(e+", reason: invalid .uuid")(),!1):(i.error(e+", reason: invalid params")(),!1)},Oe=function(t){var e="Put2D setEditerScale failure";return t&&_e(t)?t.uuid?-1===xe.indexOf(t.axis)?(i.error(e+", reason: invalid .axis")(),!1):!!he(t.value)||(i.error(e+", reason: invalid .value")(),!1):(i.error(e+", reason: invalid .uuid")(),!1):(i.error(e+", reason: invalid params")(),!1)},Me=function(t){var e="Put2D load failure";if(!(t&&_e(t)&&fe(t.data)&&t.data.length))return i.error(e+", reason: invalid params")(),!1;var o=["auto","full"];return t.data.every((function(t){if(t.bg_color&&!he(t.bg_color)&&!de(t.bg_color))return i.error(e+", reason: invalid .data.bg_color")(),!1;if(t.bg_opacity&&!he(t.bg_opacity))return i.error(e+", reason: invalid .data.bg_opacity")(),!1;if(t.fill_type&&-1===o.indexOf(t.fill_type))return i.error(e+", reason: invalid .data.fill_type")(),!1;if(!he(t.width))return i.error(e+", reason: invalid .data.width")(),!1;if(!he(t.height))return i.error(e+", reason: invalid .data.height")(),!1;if(!ye(t.position))return i.error(e+", reason: invalid .data.position")(),!1;if(!me(t.quaternion))return i.error(e+", reason: invalid .data.quaternion")(),!1;if(!ye(t.scale))return i.error(e+", reason: invalid .data.scale")(),!1;if(t.transform_data){if(!_e(t.transform_data))return i.error(e+", reason: invalid .data.transform_data")(),!1;var r=t.transform_data,n=r.translate,a=r.rotate,s=r.scale;if(n&&!ye(n))return i.error(e+", reason: invalid .data.transform_data.translate")(),!1;if(a&&!ye(a))return i.error(e+", reason: invalid .data.transform_data.rotate")(),!1;if(s&&!ye(s))return i.error(e+", reason: invalid .data.transform_data.scale")(),!1}return void 0===t.visible||ge(t.visible)?t.success&&!ve(t.success)?(i.error(e+", reason: invalid .data.success is not function")(),!1):t.failure&&!ve(t.failure)?(i.error(e+", reason: invalid .data.failure is not function")(),!1):fe(t.material_list)?!!t.material_list.every((function(t,o){if(!_e(t))return i.error(e+", reason: invalid .data.material_list["+o+"]")(),!1;if(-1===["photo","video","sprite","canvas"].indexOf(t.type))return i.error(e+", reason: invalid .data.material_list["+o+"].type")(),!1;if("photo"===t.type)t.src,0;else if("sprite"===t.type){if(t.src,!_e(t.tile_config))return i.error(e+", reason: invalid .data.material_list["+o+"].tile_config")(),!1;var r=t.tile_config,n=r.count,a=r.duration,s=r.vertical,c=r.horizontal;if(!he(n))return i.error(e+", reason: invalid .data.material_list["+o+"].tile_config.count")(),!1;if(!he(a))return i.error(e+", reason: invalid .data.material_list["+o+"].tile_config.duration")(),!1;if(!he(s))return i.error(e+", reason: invalid .data.material_list["+o+"].tile_config.vertical")(),!1;if(!he(c))return i.error(e+", reason: invalid .data.material_list["+o+"].tile_config.horizontal")(),!1}else if("canvas"===t.type){if(!(t.canvas instanceof HTMLCanvasElement))return i.error(e+", reason: invalid .data.material_list["+o+"].canvas")(),!1}else{if(t.src,t.cover&&(t.cover,0))return i.error(e+", reason: invalid .data.material_list["+o+"].cover")(),!1;if(t.green_screen_config){if(!_e(t.green_screen_config))return i.error(e+", reason: invalid .data.material_list["+o+"].green_screen_config")(),!1;var l=t.green_screen_config,u=l.filter_color,p=l.fill_color,h=l.fill_opacity;if(void 0!==u&&!he(u)&&!de(u))return i.error(e+", reason: invalid .data.material_list["+o+"].green_screen_config.filter_color")(),!1;if(void 0!==p&&!he(p)&&!de(p))return i.error(e+", reason: invalid .data.material_list["+o+"].green_screen_config.fill_color")(),!1;if(void 0!==h&&!he(h)&&!de(h))return i.error(e+", reason: invalid .data.material_list["+o+"].green_screen_config.fill_opacity")(),!1}}return!0})):(i.error(e+", reason: invalid .data.material_list")(),!1):(i.error(e+", reason: invalid .data.visible")(),!1)}))},De=function(t){var e="Put2D addEditerMaterial failure";if(!t||!_e(t))return i.error(e+", reason: invalid params")(),!1;if(!t.uuid)return i.error(e+", reason: invalid .uuid")(),!1;if(t.success&&!ve(t.success))return i.error(e+", reason: invalid .success is not function")(),!1;if(t.failure&&!ve(t.failure))return i.error(e+", reason: invalid .failure is not function")(),!1;var o=t.data;if(!_e(o))return i.error(e+", reason: invalid .data")(),!1;if(-1===["photo","video","sprite","canvas"].indexOf(o.type))return i.error(e+", reason: invalid .data.type")(),!1;if("photo"===o.type)o.src,0;else if("sprite"===o.type){if(o.src,!_e(o.tile_config))return i.error(e+", reason: invalid .data.tile_config")(),!1;var r=o.tile_config,n=r.count,a=r.duration,s=r.vertical,c=r.horizontal;if(!he(n))return i.error(e+", reason: invalid .data.tile_config.count")(),!1;if(!he(a))return i.error(e+", reason: invalid .data.tile_config.duration")(),!1;if(!he(s))return i.error(e+", reason: invalid .data.tile_config.vertical")(),!1;if(!he(c))return i.error(e+", reason: invalid .data.tile_config.horizontal")(),!1}else if("canvas"===o.type){if(!(o.canvas instanceof HTMLCanvasElement))return i.error(e+", reason: invalid .data.canvas")(),!1}else{if(o.src,o.cover&&(o.cover,0))return i.error(e+", reason: invalid .data.cover")(),!1;if(o.green_screen_config){if(!_e(o.green_screen_config))return i.error(e+", reason: invalid .data.green_screen_config")(),!1;var l=o.green_screen_config,u=l.filter_color,p=l.fill_color,h=l.fill_opacity;if(void 0!==u&&!he(u)&&!de(u))return i.error(e+", reason: invalid .data.green_screen_config.filter_color")(),!1;if(void 0!==p&&!he(p)&&!de(p))return i.error(e+", reason: invalid .data.green_screen_config.fill_color")(),!1;if(void 0!==h&&!he(h)&&!de(h))return i.error(e+", reason: invalid .data.green_screen_config.fill_opacity")(),!1}}return!0},Te=function(t){var e="Put2D addEditerMaterial failure";if(!t||!_e(t))return i.error(e+", reason: invalid params")(),!1;if(!de(t.uuid))return i.error(e+", reason: invalid .uuid")(),!1;if(!de(t.material_uuid))return i.error(e+", reason: invalid .material_uuid")(),!1;if(t.success&&!ve(t.success))return i.error(e+", reason: invalid .success is not function")(),!1;if(t.failure&&!ve(t.failure))return i.error(e+", reason: invalid .failure is not function")(),!1;var o=t.data;if(!_e(o))return i.error(e+", reason: invalid .data")(),!1;if(-1===["photo","video","sprite","canvas"].indexOf(o.type))return i.error(e+", reason: invalid .data.type")(),!1;if("photo"===o.type)o.src,0;else if("sprite"===o.type){if(o.src,!_e(o.tile_config))return i.error(e+", reason: invalid .data.tile_config")(),!1;var r=o.tile_config,n=r.count,a=r.duration,s=r.vertical,c=r.horizontal;if(!he(n))return i.error(e+", reason: invalid .data.tile_config.count")(),!1;if(!he(a))return i.error(e+", reason: invalid .data.tile_config.duration")(),!1;if(!he(s))return i.error(e+", reason: invalid .data.tile_config.vertical")(),!1;if(!he(c))return i.error(e+", reason: invalid .data.tile_config.horizontal")(),!1}else if("canvas"===o.type){if(!(o.canvas instanceof HTMLCanvasElement))return i.error(e+", reason: invalid .data.canvas")(),!1}else{if(o.src,o.cover&&(o.cover,0))return i.error(e+", reason: invalid .data.cover")(),!1;if(o.green_screen_config){if(!_e(o.green_screen_config))return i.error(e+", reason: invalid .data.green_screen_config")(),!1;var l=o.green_screen_config,u=l.filter_color,p=l.fill_color,h=l.fill_opacity;if(void 0!==u&&!he(u)&&!de(u))return i.error(e+", reason: invalid .data.green_screen_config.filter_color")(),!1;if(void 0!==p&&!he(p)&&!de(p))return i.error(e+", reason: invalid .data.green_screen_config.fill_color")(),!1;if(void 0!==h&&!he(h)&&!de(h))return i.error(e+", reason: invalid .data.green_screen_config.fill_opacity")(),!1}}return!0},Ce=function(t){var e="Put2D setFillTypeParams failure";return _e(t)?-1!==["auto","full"].indexOf(t.type)||(i.error(e+", reason: invalid .type")(),!1):(i.error(e+", reason: invalid params")(),!1)},Se=function(t){return!!_e(t)||(i.error("Put2D bundleObject2dIdParams failure, reason: invalid params")(),!1)},ke=function(t){var e="Put2D setEditerPoseDataParams failure";if(!_e(t))return i.error(e+", reason: invalid params")(),!1;if(!t.uuid)return i.error(e+", reason: invalid .uuid")(),!1;var o=t.data;if(!_e(o))return i.error(e+", reason: invalid params.data")(),!1;if(!ye(o.position))return i.error(e+", reason: invalid .data.position")(),!1;if(!me(o.quaternion))return i.error(e+", reason: invalid .data.quaternion")(),!1;if(!ye(o.scale))return i.error(e+", reason: invalid .data.scale")(),!1;if(o.transform_data){if(!_e(o.transform_data))return i.error(e+", reason: invalid .data.transform_data")(),!1;var r=o.transform_data,n=r.translate,a=r.rotate,s=r.scale;if(!ye(n))return i.error(e+", reason: invalid .data.transform_data.translate")(),!1;if(!ye(a))return i.error(e+", reason: invalid .data.transform_data.rotate")(),!1;if(!ye(s))return i.error(e+", reason: invalid .data.transform_data.scale")(),!1}return t.success&&!ve(t.success)?(i.error(e+", reason: invalid .success")(),!1):!(t.failure&&!ve(t.failure))||(i.error(e+", reason: invalid .failure")(),!1)},Ge=function(t){var e="Put2D setGreenScreenParams failure";if(!_e(t))return i.error(e+", reason: invalid .params")(),!1;var o=t.filter_color,r=t.fill_color,n=t.fill_opacity;return void 0===o||he(o)||de(o)?void 0===r||he(r)||de(r)?!(void 0!==n&&!he(n)&&!de(n))||(i.error(e+", reason: invalid .params.fill_opacity")(),!1):(i.error(e+", reason: invalid .params.fill_color")(),!1):(i.error(e+", reason: invalid .params.filter_color")(),!1)},Ae=function(t){var e="Put2D showControlAxisParams failure";if(!_e(t))return i.error(e+", reason: invalid .params")(),!1;var o=t.type,r=t.axis;return~["translate","rotate","scale"].indexOf(o)?!!~xe.indexOf(r)||(i.error(e+", reason: invalid .axis")(),!1):(i.error(e+", reason: invalid .type")(),!1)},Ue=function(t){var e="Put2D hideControlAxisParams failure";if(!_e(t))return i.error(e+", reason: invalid .params")(),!1;var o=t.type,r=t.axis;return~["translate","rotate","scale"].indexOf(o)?!!~xe.indexOf(r)||(i.error(e+", reason: invalid .axis")(),!1):(i.error(e+", reason: invalid .type")(),!1)},je=function(t){var e=t,i=e.methods;e.quitEditMode=function(){return i.disableEdit()},e.enterEditMode=function(){return i.enableEdit()},e.add=function(t){if(be(t))return i.add(t)},e.cancelAdd=function(){return i.cancelAdd()},e.load=function(t){if(Me(t))return i.load(t)},e.reput=function(t){return i.reput(t)},e.cancelReput=function(){return i.cancelReput()},e.remove=function(t){return i.remove(t)},e.removeAll=function(){return i.removeAll()},e.show=function(t){return i.show(t)},e.hide=function(t){return i.hide(t)},e.showAll=function(){return i.showAll()},e.hideAll=function(){return i.hideAll()},e.fadeInAll=function(t){return i.fadeInAll(t)},e.fadeOutAll=function(t){return i.fadeOutAll(t)},e.edit=function(t){return i.edit(t)},e.exitEdit=function(){return i.saveAndExit()},e.showScaleControl=function(){return i.showScaleControl()},e.hideScaleControl=function(){return i.hideScaleControl()},e.showTranslateControl=function(){return i.showTranslateControl()},e.hideTranslateControl=function(){return i.hideTranslateControl()},e.showRotateControl=function(){return i.showRotateControl()},e.hideRotateControl=function(){return i.hideRotateControl()},e.showControlAxis=function(t){Ae(t)&&i.showControlAxis(t)},e.hideControlAxis=function(t){Ue(t)&&i.hideControlAxis(t)},e.showBorder=function(t){return i.showBorder(t)},e.hideBorder=function(t){return i.hideBorder(t)},e.setTranslate=function(t){if(Ee(t))return i.setTranslate(t)},e.setRotate=function(t){if(Pe(t))return i.setRotate(t)},e.setScale=function(t){if(Oe(t))return i.setScale(t)},e.setPoseData=function(t){if(ke(t))return i.setPoseData(t)},e.enableEqualScale=function(){return i.enableEqualScale()},e.disableEqualScale=function(){return i.disableEqualScale()},e.setControlSizeConstant=function(t){return i.setControlSizeConstant(t)},e.addMaterial=function(t){if(De(t))return i.addMaterial(t)},e.removeMaterial=function(t){return i.removeMaterial(t)},e.replaceMaterial=function(t){if(Te(t))return i.replaceMaterial(t)},e.setGreenScreenMaterialParams=function(t){if(Ge(t))return i.setGreenScreenMaterialParams(t)},e.setFillType=function(t){if(Ce(t))return i.setFillType(t)},e.play=function(t){return i.play(t)},e.stopPlay=function(t){return i.stopPlay(t)},e.stopPlayAll=function(){return i.stopPlayAll()},e.mute=function(t){return i.mute(t)},e.unMute=function(t){return i.unMute(t)},e.muteAll=function(){return i.muteAll()},e.unMuteAll=function(){return i.unMuteAll()},e.openLoopPlay=function(t){return i.openLoopPlay(t)},e.closeLoopPlay=function(t){return i.closeLoopPlay(t)},e.setPlayBtnForcedHide=function(t){return i.setPlayBtnForcedHide(t)},e.cancelPlayBtnForcedHide=function(t){return i.cancelPlayBtnForcedHide(t)},e.getObject2dData=function(t){return i.getObject2dData(t)},e.getObject2dDataById=function(t){return i.getObject2dDataById(t)},e.getAllObject2dData=function(){return i.getAllObject2dData()},e.getMaterialData=function(t){return i.getMaterialData(t)},e.getMaterialDataById=function(t){return i.getMaterialDataById(t)},e.getMaterialStatus=function(t){return i.getMaterialStatus(t)},e.bundleObject2dId=function(t){if(Se(t))return i.bundleObject2dId(t)}};var Ie=function(t){var e={"put.down":{en:r.PutDown,cb:[]},click:{en:r.Click,cb:[]},translate:{en:r.Translate,cb:[]},"translate.end":{en:r.TranslateEnd,cb:[]},rotate:{en:r.Rotate,cb:[]},"rotate.end":{en:r.RotateEnd,cb:[]},scale:{en:r.Scale,cb:[]},"scale.end":{en:r.ScaleEnd,cb:[]},hover:{en:r.Hover,cb:[]},"hover.out":{en:r.HoverOut,cb:[]},"control.hover":{en:r.PickerHover,cb:[]},"control.hover.out":{en:r.PickerHoverOut,cb:[]},play:{en:r.Play,cb:[]},"stop.play":{en:r.StopPlay,cb:[]},"blank.click":{en:r.ClickBlank,cb:[]},"control.drag.start":{en:r.DragStart,cb:[]},"control.drag.end":{en:r.DragEnd,cb:[]}};!function(t,e){Object.keys(t).forEach((function(i){var o=t[i];e[o.en]=function(e){t[i].cb.forEach((function(t){return t(e)}))}}))}(e,t),t.addEventListener=function(t,i){e[t].cb.push(i)},t.removeEventListener=function(t,i){var o=e[t].cb.indexOf(i);-1!==o&&e[t].cb.splice(o,1)}},Ne=function(t){je(t),Ie(t)};function ze(t){this.ext=t,this.enable=!0,this.init()}ze.prototype.init=function(){var t=this;Object.keys(r).forEach((function(e){var i=Object.create(null);i._state=!1,i._data=null,t[r[e]]=i,t.defineProtpertyOfStatusItem(i,r[e])}))},ze.prototype.defineProtpertyOfStatusItem=function(t,e){var i=this;Object.defineProperties(t,{state:{get:function(){return t._state},set:function(o){t._state=o;var n=t._data;!function(t,e,i,o){var n=t.ext,a=t;switch(e){case r.Add:if(!0===i){if(a[r.PutDown].state=!1,!t.enable)return;n[r.Add].forEach((function(t){return t(o)}))}break;case r.AddEnd:if(!0===i){if(a[r.Add].state=!1,!t.enable)return;n[r.AddEnd].forEach((function(t){return t(o)}))}break;case r.CancelAdd:if(!0===i){if(a[r.Add].state=!1,!t.enable)return;n[r.CancelAdd].forEach((function(t){return t(o)}))}break;case r.PutDown:if(!0===i){if(a[r.Add].state=!1,a[r.Reput].state=!1,!t.enable)return;n[r.PutDown].forEach((function(t){return t(o)}))}break;case r.Reput:if(!0===i){if(a[r.CancelReput].state=!1,!t.enable)return;n[r.Reput].forEach((function(t){return t(o)}))}break;case r.CancelReput:if(!0===i){if(a[r.Reput].state=!1,!t.enable)return;n[r.CancelReput].forEach((function(t){return t(o)}))}break;case r.Edit:!0===i&&(a[r.ExitEdit].state=!1);break;case r.ExitEdit:!0===i&&(a[r.Edit].state=!1);break;case r.Click:if(!0===i){if(a[r.ClickBlank].state=!1,!t.enable)return;n[r.Click].forEach((function(t){return t(o)}))}break;case r.ClickBlank:if(!0===i){if(a[r.Click].state=!1,!t.enable)return;n[r.ClickBlank].forEach((function(t){return t(o)}))}break;case r.Hover:if(!0===i){if(a[r.HoverOut].state=!1,!t.enable)return;n[r.Hover].forEach((function(t){return t(o)}))}break;case r.HoverOut:if(!0===i){if(a[r.Hover].state=!1,!t.enable)return;n[r.HoverOut].forEach((function(t){return t(o)}))}break;case r.PickerHover:if(!0===i){if(a[r.PickerHoverOut].state=!1,!t.enable)return;n[r.PickerHover].forEach((function(t){return t(o)}))}break;case r.PickerHoverOut:if(!0===i){if(a[r.PickerHover].state=!1,!t.enable)return;n[r.PickerHoverOut].forEach((function(t){return t(o)}))}break;case r.DragStart:if(!0===i){if(a[r.DragEnd].state=!1,!t.enable)return;n[r.DragStart].forEach((function(t){return t(o)}))}break;case r.DragEnd:if(!0===i){if(a[r.DragStart].state=!1,!t.enable)return;n[r.DragEnd].forEach((function(t){return t(o)}))}break;case r.Translate:if(!0===i){if(a[r.TranslateEnd].state=!1,!t.enable)return;n[r.Translate].forEach((function(t){return t(o)}))}break;case r.TranslateEnd:if(!0===i){if(a[r.Translate].state=!1,!t.enable)return;n[r.TranslateEnd].forEach((function(t){return t(o)}))}break;case r.Rotate:if(!0===i){if(a[r.RotateEnd].state=!1,!t.enable)return;n[r.Rotate].forEach((function(t){return t(o)}))}break;case r.RotateEnd:if(!0===i){if(a[r.Rotate].state=!1,!t.enable)return;n[r.RotateEnd].forEach((function(t){return t(o)}))}break;case r.Scale:if(!0===i){if(a[r.ScaleEnd].state=!1,!t.enable)return;n[r.Scale].forEach((function(t){return t(o)}))}break;case r.ScaleEnd:if(!0===i){if(a[r.Scale].state=!1,!t.enable)return;n[r.ScaleEnd].forEach((function(t){return t(o)}))}break;case r.Play:if(!0===i){if(a[r.StopPlay].state=!1,!t.enable)return;n[r.Play].forEach((function(t){return t(o)}))}break;case r.StopPlay:if(!0===i){if(a[r.Play].state=!1,!t.enable)return;n[r.StopPlay].forEach((function(t){return t(o)}))}}}(i,e,o,n)}},data:{get:function(){return t._data},set:function(e){t._data=e}}})};var He=ze;var We=function(t){Object.values(r).forEach((function(e){var i=[];Object.defineProperty(t,e,{set:function(t){i.push(t)},get:function(){return i}})}))},Be="pc",Le="mobile",Re=Ve(),Fe=Object.create(null);function qe(){var t=/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i,e=-1!=Re.indexOf("Safari")&&-1!=Re.indexOf("Version"),i=-1!=Re.indexOf("iPhone")&&-1!=Re.indexOf("Version"),o=e&&!i&&"ontouchend"in document;if(Re&&t.test)return t.test(Re)||o}function Ve(){return window.navigator.userAgent}Fe.parent_count=0,Fe.offset_left=0,Fe.offset_top=0;var Xe={isPc:function(){return!qe()},isMobile:qe,getUserAgent:Ve,getUrlParam:function(t){var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)","i"),i=window.location.search.substr(1).match(e);return null!=i?decodeURI(i[2]):null},getRendererStageOffsetInfo:function(){if(0!==Fe.parent_count)return Fe;var t=qspace.commonEvents.coreEvents.getRendererStage(),e=0,i=0,o=0,r=function(t){i+=t.offsetLeft,o+=t.offsetTop,t.offsetParent&&(e++,r(t.offsetParent))};return r(t),Fe.parent_count=e,Fe.offset_left=i,Fe.offset_top=o,Fe}};function Ye(){this.edit={show:{translate:!0,rotate:!0,scale:!0},activeOtherOpacity:0},this.limitation={translate:{max:1/0,min:-1/0},rotate:{max:1/0,min:-1/0},scale:{max:10,min:.1}}}Ye.prototype.set=function(t){var e=t.edit,i=t.limitation;if(e){var o=e.show,r=e.active_other_opacity;o&&(this.edit.show.translate=!!o.translate,this.edit.show.rotate=!!o.rotate,this.edit.show.scale=!!o.scale),r&&(this.edit.activeOtherOpacity=r)}if(i){var n=i.translate,a=i.rotate,s=i.scale;n&&(this.limitation.translate.max=n.max,this.limitation.translate.min=n.min),a&&(this.limitation.rotate.max=a.max,this.limitation.rotate.min=a.min),s&&(this.limitation.scale.max=s.max,this.limitation.scale.min=s.min)}};var Qe=Ye;function Ke(){this.distanceFromWall=.05}Ke.prototype.set=function(t){var e=t.distance_from_wall;(e||0===e)&&(this.distanceFromWall=e)};var Je=Ke;function Ze(){this.play="//material.3dnest.cn/e100_sdk/player-play-btn.png"}Ze.prototype.set=function(t){var e=t.play;e&&(this.play=e)};var $e=Ze;function ti(){this.icon=new $e,this.controller=new Qe,this.put=new Je}ti.prototype.set=function(t){t.controller_config&&this.controller.set(t.controller_config),t.put_config&&this.put.set(t.put_config),t.icon_config&&this.icon.set(t.icon_config)};var ei=ti,ii=function(t){this.qspace=t,this.commonEvents=t.commonEvents,this.commonExtension=t.commonExtension},oi={NEED_MOUSE_MOVE_WITHOUT_BUTTON_DOWN:{configurable:!0},NEED_MOUSE_LEFT_BUTTON_DOWN:{configurable:!0},NEED_MOUSE_LEFT_BUTTON_DOWN_WITHIN_MOVE:{configurable:!0},NEED_MOUSE_LEFT_BUTTON_UP:{configurable:!0},NEED_MOUSE_MOVE_INTERSECT_WITHIN_MODEL:{configurable:!0},NEED_MOUSE_RIGHT_BUTTON_DOWN_UP_WITHOUT_MOVE:{configurable:!0},NEED_MOUSE_LEFT_BUTTON_DOWN_UP_WITHOUT_MOVE:{configurable:!0},NEED_UPDATE:{configurable:!0},NEED_SWITCH_MODEL:{configurable:!0},NEED_HANDLE_CLICK:{configurable:!0},NEED_HANDLE_SINGLE_TOUCH_START:{configurable:!0},NEED_MOUSE_OUT:{configurable:!0}};ii.prototype.getCamera=function(){switch(this.qspace.view.mode){case"panorama":return this.qspace.core.getPanoramaCamera();case"dollhouse":return this.qspace.core.getDollhouseCamera();case"floorplan":return this.qspace.core.getFloorplanCamera()}},ii.prototype.getCameraPosition=function(){switch(this.qspace.view.mode){case"panorama":return this.qspace.panoramaCamera.position;case"dollhouse":return this.qspace.dollhouseCamera.position;case"floorplan":return this.qspace.floorplanCamera.position;case"transitioning":return null}},ii.prototype.getFloors=function(){return this.qspace.model.floors},ii.prototype.getFloorBoundingBox=function(t){return this.qspace.model.getFloorBoundingBox(t)},ii.prototype.getCameraWorldMatrixInverse=function(){var t=this.qspace.view.mode,e=new this.qspace.THREE.Matrix4;switch(t){case"panorama":e.elements=this.qspace.panoramaCamera.matrixWorldInverse;break;case"dollhouse":e.elements=this.qspace.dollhouseCamera.matrixWorldInverse;break;case"floorplan":e.elements=this.qspace.floorplanCamera.matrixWorldInverse}return e},ii.prototype.getCameraProjectionMatrix=function(){var t=this.qspace.view.mode,e=new this.qspace.THREE.Matrix4;switch(t){case"panorama":e.elements=this.qspace.panoramaCamera.projectionMatrix;break;case"dollhouse":e.elements=this.qspace.dollhouseCamera.projectionMatrix;break;case"floorplan":e.elements=this.qspace.floorplanCamera.projectionMatrix}return e},ii.prototype.computeFloorBoxContainsPoint=function(t,e){return qspace.model.computeFloorBoxContainsPoint(t,e)},ii.prototype.sceneAdd=function(t){this.qspace.scene.add(t)},ii.prototype.sceneRemove=function(t){this.qspace.scene.remove(t)},ii.prototype.enableCss3d=function(){this.qspace.core.enableCss3d()},ii.prototype.disableCss3d=function(){this.qspace.core.disableCss3d()},ii.prototype.judgeBarrierBetweenThePoint=function(t,e){return this.qspace.raycaster.computeBarrierWithinModelBetweenThePoint(t,e)},oi.NEED_MOUSE_MOVE_WITHOUT_BUTTON_DOWN.get=function(){return this.commonExtension.API.NEED_MOUSE_MOVE_WITHOUT_BUTTON_DOWN},oi.NEED_MOUSE_LEFT_BUTTON_DOWN.get=function(){return this.commonExtension.API.NEED_MOUSE_LEFT_BUTTON_DOWN},oi.NEED_MOUSE_LEFT_BUTTON_DOWN_WITHIN_MOVE.get=function(){return this.commonExtension.API.NEED_MOUSE_LEFT_BUTTON_DOWN_WITHIN_MOVE},oi.NEED_MOUSE_LEFT_BUTTON_UP.get=function(){return this.commonExtension.API.NEED_MOUSE_LEFT_BUTTON_UP},oi.NEED_MOUSE_MOVE_INTERSECT_WITHIN_MODEL.get=function(){return this.commonExtension.API.NEED_MOUSE_MOVE_INTERSECT_WITHIN_MODEL},oi.NEED_MOUSE_RIGHT_BUTTON_DOWN_UP_WITHOUT_MOVE.get=function(){return this.commonExtension.API.NEED_MOUSE_RIGHT_BUTTON_DOWN_UP_WITHOUT_MOVE},oi.NEED_MOUSE_LEFT_BUTTON_DOWN_UP_WITHOUT_MOVE.get=function(){return this.commonExtension.API.NEED_MOUSE_LEFT_BUTTON_DOWN_UP_WITHOUT_MOVE},oi.NEED_UPDATE.get=function(){return this.commonExtension.API.NEED_UPDATE},oi.NEED_SWITCH_MODEL.get=function(){return this.commonExtension.API.NEED_SWITCH_MODEL},oi.NEED_HANDLE_CLICK.get=function(){return this.commonExtension.API.NEED_HANDLE_CLICK},oi.NEED_HANDLE_SINGLE_TOUCH_START.get=function(){return this.commonExtension.API.NEED_HANDLE_SINGLE_TOUCH_START},oi.NEED_MOUSE_OUT.get=function(){return this.commonExtension.API.NEED_MOUSE_OUT},Object.defineProperties(ii.prototype,oi);var ri=ii,ni=_,ai=re,si=we,ci=new t.Vector2;function li(){var e=this;this.opacity=1,this.group2dList=[],this.group2dMap=Object.create(null),this.group2dContainer=new t.Group,this.newGroup2d=null,this.reputGroup2d=null,this.editGroup2d=null,this.hoverGroup2d=null,this.hoverPicker=null,this.raycaster=new t.Raycaster,this.disableEdit=!1,this.isInstall=!1,this.modelSign=0,this.tweenList=[],this.controlSizeConstant=!1,this.getFloors=function(){var t=e.middleWare.getFloors();if(t)return t.map((function(t){return t.idx}))}}function ui(t,e){var i={};if(e)i.x=t.offsetX||t.x,i.y=t.offsetY||t.y;else{var o=Xe.getRendererStageOffsetInfo();t.changedTouches?(i.x=t.changedTouches[0].clientX-o.offset_left,i.y=t.changedTouches[0].clientY-o.offset_top):(i.x=t.x,i.y=t.y)}return i}return li.prototype.env=void 0,li.prototype.bundle="Tue Feb 18 2025 20:02:07 GMT+0800 (China Standard Time)",li.prototype.version="1.4.1",li.prototype.name="Put2D",li.prototype.supportPlatform=[Be,Le],li.prototype.registeredApi=Object.create(null),li.prototype.onApi=Object.create(null),li.prototype.register=function(){var t=this,e=this.parent||window.qspace;this.middleWare=new ri(e),Xe.isPc()&&(this.registeredApi[this.middleWare.NEED_MOUSE_MOVE_WITHOUT_BUTTON_DOWN]=!0),Xe.isPc()&&(this.registeredApi[this.middleWare.NEED_MOUSE_LEFT_BUTTON_DOWN]=!0),Xe.isPc()&&(this.registeredApi[this.middleWare.NEED_MOUSE_LEFT_BUTTON_DOWN_WITHIN_MOVE]=!0),Xe.isPc()&&(this.registeredApi[this.middleWare.NEED_MOUSE_LEFT_BUTTON_UP]=!0),Xe.isPc()&&(this.registeredApi[this.middleWare.NEED_MOUSE_MOVE_INTERSECT_WITHIN_MODEL]=!0),Xe.isPc()&&(this.registeredApi[this.middleWare.NEED_MOUSE_RIGHT_BUTTON_DOWN_UP_WITHOUT_MOVE]=!0),Xe.isPc()&&(this.registeredApi[this.middleWare.NEED_MOUSE_LEFT_BUTTON_DOWN_UP_WITHOUT_MOVE]=!0),this.registeredApi[this.middleWare.NEED_UPDATE]=!0,this.registeredApi[this.middleWare.NEED_SWITCH_MODEL]=!0,Xe.isMobile()&&(this.registeredApi[this.middleWare.NEED_HANDLE_CLICK]=!0),Xe.isMobile()&&(this.registeredApi[this.middleWare.NEED_HANDLE_SINGLE_TOUCH_START]=!0),this.registeredApi[this.middleWare.NEED_MOUSE_OUT]=!0;var i=new ni;this.onApi[this.middleWare.NEED_MOUSE_MOVE_INTERSECT_WITHIN_MODEL]=function(e){t.newGroup2d&&t.newGroup2d.followMoving(e),t.reputGroup2d&&t.reputGroup2d.followMoving(e)},this.onApi[this.middleWare.NEED_MOUSE_LEFT_BUTTON_DOWN_UP_WITHOUT_MOVE]=function(){t.hoverGroup2d&&!t.newGroup2d?t.onGroup2dClick(t.hoverGroup2d):t.onClickBlank()},this.onApi[this.middleWare.NEED_HANDLE_CLICK]=function(){t.hoverGroup2d?t.onGroup2dClick(t.hoverGroup2d):t.onClickBlank()},this.onApi[this.middleWare.NEED_MOUSE_LEFT_BUTTON_DOWN]=function(){if(t.status[r.Edit].state&&t.hoverPicker){var e=t.middleWare.getCamera(),i=t.hoverPicker._type;"translate"===i&&t.control.translateControl.dragStart(t.raycaster,e),"rotate"===i&&t.control.rotateControl.dragStart(t.raycaster,e),"scale"===i&&t.control.scaleControl.dragStart(t.raycaster,e)}},this.onApi[this.middleWare.NEED_MOUSE_LEFT_BUTTON_DOWN_WITHIN_MOVE]=function(e){i.pipe(20,(function(){t.onMouseLeftButtonDownWithinMove(e)}))},this.onApi[this.middleWare.NEED_MOUSE_LEFT_BUTTON_UP]=function(){if(t.status[r.Edit].state&&t.hoverPicker){var e=t.hoverPicker._type;if("translate"===e)return t.control.translateControl.dragEnd();if("rotate"===e)return t.control.rotateControl.dragEnd();if("scale"===e)return t.control.scaleControl.dragEnd()}},this.onApi[this.middleWare.NEED_MOUSE_RIGHT_BUTTON_DOWN_UP_WITHOUT_MOVE]=function(){return t.newGroup2d?t.newGroup2d.putDown():t.reputGroup2d?t.reputGroup2d.putDown():void 0},this.onApi[this.middleWare.NEED_MOUSE_MOVE_WITHOUT_BUTTON_DOWN]=function(e){i.pipe(20,(function(){var i=ui(e,!0);t.onMouseMoveWithoutButtonDown(i)}))},this.onApi[this.middleWare.NEED_HANDLE_SINGLE_TOUCH_START]=function(e){var i=ui(e,!1);t.onMouseMoveWithoutButtonDown(i)},this.onApi[this.middleWare.NEED_UPDATE]=function(e){if(t.group2dList.forEach((function(t){return t.onFrameUpdate(e)})),t.editGroup2d&&t.controlSizeConstant){var i=t.middleWare.getCameraPosition(),o=t.control.position,r=.25*i.distanceTo(o)+.45;t.control.setScale(r)}},this.onApi[this.middleWare.NEED_SWITCH_MODEL]=function(){t.modelSign++},this.onApi[this.middleWare.NEED_MOUSE_OUT]=function(){if(t.status[r.DragStart].state){var e=t.control,i=t.hoverPicker._type;"translate"===i&&e.translateControl.dragEnd(),"rotate"===i&&e.rotateControl.dragEnd(),"scale"===i&&e.scaleControl.dragEnd()}t.hoverGroup2d&&t.onGroup2dHoverOut(),t.hoverPicker&&t.onPickerHoverOut()}},li.prototype.init=function(t){this.config=new ei,t&&si(t)&&this.config.set(t)},li.prototype.install=function(t){void 0===t&&(t=function(){}),this.status||(this.methods=new pe(this),this.status=new He(this),this.control=new ht,this.group2dContainer.add(this.control),this.event=r,We(this),Ne(this),this.control.init()),this.isInstall=!0,this.status.enable=!0,t()},li.prototype.uninstall=function(){this.isInstall=!1,this.status.enable=!1,this.middleWare.disableCss3d()},li.prototype.clear=function(){this.removeAllGroup2d()},li.prototype.onGroup2dAdd=function(t){this.group2dContainer.parent||this.handleCodeLoad();var e=t.getUserData("setting_item");this.newGroup2d=t,this.group2dContainer.add(t),this.status[r.Add].data=e,this.status[r.Add].state=!0},li.prototype.onGroup2dPutDown=function(t){var e=t.getUserData("setting_item");this.newGroup2d&&(this.group2dList.push(t),this.group2dMap[t.uuid]=t,this.newGroup2d=null),this.reputGroup2d=null,this.status[r.PutDown].data=ai(e),this.status[r.PutDown].state=!0},li.prototype.onGroup2dReput=function(t){var e=t.getUserData("setting_item");this.reputGroup2d=t,this.status[r.Reput].data=e,this.status[r.Reput].state=!0},li.prototype.onGroup2dCancelAdd=function(){var t=this.newGroup2d,e=t.getUserData("setting_item");this.newGroup2d=null,this.group2dContainer.remove(t),this.status[r.CancelAdd].data=e,this.status[r.CancelAdd].state=!0},li.prototype.onGroup2dCancelReput=function(){var t=this.reputGroup2d.getUserData("setting_item");this.reputGroup2d=null,this.status[r.CancelReput].data=t,this.status[r.CancelReput].state=!0},li.prototype.onGroup2dClick=function(t){var e={id:t.data.id,uuid:t.uuid};this.status[r.Click].data=e,this.status[r.Click].state=!0},li.prototype.onClickBlank=function(){this.status[r.ClickBlank].data=null,this.status[r.ClickBlank].state=!0},li.prototype.onGroup2dEdit=function(t){this.editGroup2d=t;var e=t.getUserData("setting_item");this.status[r.Edit].data=e,this.status[r.Edit].state=!0},li.prototype.onGroup2dSaveAndExit=function(){this.editGroup2d=null,this.status[r.ExitEdit].data=null,this.status[r.ExitEdit].state=!0},li.prototype.onGroup2dDragStart=function(){this.status[r.DragStart].data=null,this.status[r.DragStart].state=!0},li.prototype.onGroup2dDragEnd=function(){this.status[r.DragEnd].data=null,this.status[r.DragEnd].state=!0},li.prototype.onGroup2dTranslate=function(t,e){var i=e.offset,o=e.axis,n=e.isinitiative;void 0===n&&(n=!1);var a=t.getUserData("setting_item");this.status[r.Translate].data={step:i,axis:o,isinitiative:n,data:ai(a)},this.status[r.Translate].state=!0},li.prototype.onGroup2dTranslateEnd=function(){var t=this.editGroup2d.getUserData("setting_item");this.status[r.TranslateEnd].data=ai(t),this.status[r.TranslateEnd].state=!0},li.prototype.onGroup2dRotate=function(t,e){var i=e.angle,o=e.axis,n=e.isinitiative;void 0===n&&(n=!1);var a=t.getUserData("setting_item");this.status[r.Rotate].data={step:i,axis:o,isinitiative:n,data:ai(a)},this.status[r.Rotate].state=!0},li.prototype.onGroup2dRotateEnd=function(){var t=this.editGroup2d.getUserData("setting_item");this.status[r.RotateEnd].data=ai(t),this.status[r.RotateEnd].state=!0},li.prototype.onGroup2dScale=function(t,e){var i=e.axis,o=e.value,n=e.isinitiative,a=t.getUserData("setting_item");this.status[r.Scale].data={axis:i,isinitiative:n,step:o,data:ai(a)},this.status[r.Scale].state=!0},li.prototype.onGroup2dScaleEnd=function(){var t=this.editGroup2d.getUserData("setting_item");this.status[r.ScaleEnd].data=ai(t),this.status[r.ScaleEnd].state=!0},li.prototype.onPickerHover=function(t){t&&(t.onHover(),this.hoverPicker=t,this.status[r.PickerHover].data=null,this.status[r.PickerHover].state=!0)},li.prototype.onPickerHoverOut=function(){this.hoverPicker&&(this.hoverPicker.onHoverOut(),this.hoverPicker=null,this.status[r.PickerHoverOut].data=null,this.status[r.PickerHoverOut].state=!0)},li.prototype.onGroup2dHover=function(t){this.hoverGroup2d=t;var e={id:t.data.id,uuid:t.uuid};this.status[r.Hover].data=e,this.status[r.Hover].state=!0},li.prototype.onGroup2dHoverOut=function(){this.hoverGroup2d=null,this.status[r.HoverOut].data=null,this.status[r.HoverOut].state=!0},li.prototype.onGroup2dLoad=function(t){this.group2dContainer.parent||this.handleCodeLoad(),this.group2dList.push(t),this.group2dMap[t.uuid]=t,this.group2dContainer.add(t)},li.prototype.onGroup2dListLoad=function(t,e){var i=this,o=[];t.forEach((function(t){var e=t.getUserData("setting_item");o.push(e),i.group2dList.push(t),i.group2dMap[t.uuid]=t,i.group2dContainer.add(t)})),e(o)},li.prototype.onPlay=function(t){var e={uuid:t.uuid};this.status[r.Play].data=e,this.status[r.Play].state=!0},li.prototype.onStopPlay=function(t){var e={uuid:t.uuid};this.status[r.StopPlay].data=e,this.status[r.StopPlay].state=!0},li.prototype.onMouseLeftButtonDownWithinMove=function(t){if(this.updateRaycaster(t),this.status[r.Edit].state&&this.hoverPicker){var e=this.middleWare.getCamera(),i=this.hoverPicker._type;if("translate"===i&&this.control.translateControl.dragMove(this.raycaster,e),"scale"===i&&this.control.scaleControl.dragMove(this.raycaster,e),"rotate"===i){this.control.rotateControl.dragMove(this.raycaster,e);var o=this.control.rotateControl.activeAxis,n=t.offsetX||t.x+16,a=t.offsetY||t.y,s=Math.round(this.editGroup2d.getUserData("setting_item").transform_data.rotate[o]);this.control.rotateControl.rotateIndicationPlaneMap[o].setMouseIndicationInfo({top:a,left:n,value:s})}}},li.prototype.onMouseMoveWithoutButtonDown=function(t){if(this.updateRaycaster(t),!this.status[r.Add].state&&!this.status[r.Reput].state&&this.group2dList.length){var e=this.pickUpControlPicker(this);if(e){var i=this.hoverPicker;return i&&i!==e&&this.onPickerHoverOut(),void(i||this.onPickerHover(e))}this.onPickerHoverOut();var o=this.pickerUpPlane(this.group2dList);if(o)o.group2D!==this.hoverGroup2d&&this.onGroup2dHover(o.group2D);else this.hoverGroup2d&&this.onGroup2dHoverOut()}},li.prototype.updateRaycaster=function(t){var e=t.x,i=t.y;O.convertScreenPositionToNDC(e,i,ci);var o=this.middleWare.getCamera();ci&&o&&this.raycaster.setFromCamera(ci,o)},li.prototype.getShowPlaneList=function(t){var e=this,i=[];return t.forEach((function(t){if(t.visible)if(e.disableEdit){if(!t.container.activeGroup)return;i.push(t.container.activeGroup.plane)}else i.push(t.bgPlane)})),i},li.prototype.pickUpControlPicker=function(){if(this.status[r.Edit].state){if(this.control.status.translate){var t=this.control.translateControl._pickers,e=this.pickUpObject(t,!0);if(e&&e.object.visible)return e.object}if(this.control.status.rotate){var i=this.control.rotateControl._pickers,o=this.pickUpObject(i,!0);if(o&&o.object.visible)return o.object}if(this.control.status.scale){var n=this.control.scaleControl._pickers,a=this.pickUpObject(n,!0);if(a&&a.object.visible)return a.object}}},li.prototype.pickerUpPlane=function(t){var e=this.getShowPlaneList(t),i=this.pickUpObject(e);if(i)return i.object},li.prototype.pickUpObject=function(t,e){if(t.length){var i=this.raycaster.intersectObjects(t);if(i.length){var o=i[0],r=o.point;if(e)return o;var n=this.middleWare.getCameraPosition();return this.middleWare.judgeBarrierBetweenThePoint(n,r)?void 0:o}}},li.prototype.removeGroup2d=function(t){if(this.newGroup2d===t)return t.cancelAdd();this.reputGroup2d===t&&t.cancelReput(),this.editGroup2d===t&&(t.saveAndExit(),this.onPickerHoverOut(),this.onGroup2dDragEnd()),this.hoverGroup2d===t&&this.onGroup2dHoverOut();var e=this.group2dList.indexOf(t);-1!==e&&(this.group2dList.splice(e,1),delete this.group2dMap[t.uuid],t.dispose(),this.group2dContainer.remove(t))},li.prototype.removeAllGroup2d=function(){this.newGroup2d&&this.newGroup2d.cancelAdd(),this.reputGroup2d&&this.reputGroup2d.cancelReput(),this.editGroup2d&&(this.editGroup2d.saveAndExit(),this.onPickerHoverOut(),this.onGroup2dDragEnd()),this.hoverGroup2d&&this.onGroup2dHoverOut();for(var t=this.group2dList.length-1;t>=0;t--){var e=this.group2dList[t];e.dispose(),this.group2dContainer.remove(e),this.group2dList.pop()}this.group2dMap=Object.create(null),this.removeAnimate()},li.prototype.createAnimate=function(t,e){var i=this,o=qspace.TWEEN;this.removeAnimate();var r={opacity:this.opacity},n={opacity:t};this.group2dContainer.traverse((function(t){if(t.isMesh||t.isSprite||t.isLine){if(!t.material)return;var a=new o.Tween(r).to(n,e).easing(o.Easing.Linear.None).onUpdate((function(e){var o=1;i.opacity=e.opacity,"_opacity"in t&&(o=t._opacity),t.material.opacity=e.opacity*o})).onStart((function(){t.isSprite&&(t.material.premultipliedAlpha=!1)})).onComplete((function(){t.isSprite&&(t.material.premultipliedAlpha=1===n.opacity)})).start();i.tweenList.push(a)}}))},li.prototype.removeAnimate=function(){var t=qspace.TWEEN;this.tweenList.forEach((function(e){t.remove(e)})),this.tweenList=[]},li.prototype.handleCodeLoad=function(){this.middleWare.sceneAdd(this.group2dContainer),this.middleWare.enableCss3d()},li}));
